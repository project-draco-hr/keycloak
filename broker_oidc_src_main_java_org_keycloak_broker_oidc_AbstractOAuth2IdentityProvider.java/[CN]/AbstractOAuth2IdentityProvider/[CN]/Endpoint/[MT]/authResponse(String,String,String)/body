{
  if (error != null) {
    event.event(EventType.LOGIN);
    event.error(error);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,headers,Messages.IDENTITY_PROVIDER_UNEXPECTED_ERROR);
  }
  try {
    if (authorizationCode != null) {
      String response=generateTokenRequest(authorizationCode).asString();
      HashMap<String,String> userNotes=new HashMap<String,String>();
      FederatedIdentity federatedIdentity=getFederatedIdentity(userNotes,response);
      if (getConfig().isStoreToken()) {
        federatedIdentity.setToken(response);
      }
      return callback.authenticated(userNotes,getConfig(),federatedIdentity,state);
    }
  }
 catch (  Exception e) {
    logger.error("Failed to make identity provider oauth callback",e);
  }
  event.event(EventType.LOGIN);
  event.error(Errors.IDENTITY_PROVIDER_LOGIN_FAILURE);
  return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,headers,Messages.IDENTITY_PROVIDER_UNEXPECTED_ERROR);
}
