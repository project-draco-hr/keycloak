{
  if (error != null) {
    event.event(EventType.LOGIN);
    event.error(error);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,headers,Messages.IDENTITY_PROVIDER_UNEXPECTED_ERROR);
  }
  try {
    if (authorizationCode != null) {
      String response=generateTokenRequest(authorizationCode).asString();
      BrokeredIdentityContext federatedIdentity=getFederatedIdentity(response);
      if (getConfig().isStoreToken()) {
        federatedIdentity.setToken(response);
      }
      federatedIdentity.setCode(state);
      federatedIdentity.setIdpConfig(getConfig());
      federatedIdentity.setIdp(AbstractOAuth2IdentityProvider.this);
      return callback.authenticated(federatedIdentity);
    }
  }
 catch (  Exception e) {
    logger.error("Failed to make identity provider oauth callback",e);
  }
  event.event(EventType.LOGIN);
  event.error(Errors.IDENTITY_PROVIDER_LOGIN_FAILURE);
  return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,headers,Messages.IDENTITY_PROVIDER_UNEXPECTED_ERROR);
}
