{
  String samlResponse=getRequestParameter(request,SAML_RESPONSE_PARAMETER);
  if (samlResponse == null) {
    throw new RuntimeException("No response from SAML identity provider.");
  }
  SAML2Request saml2Request=new SAML2Request();
  ResponseType responseType;
  if (getConfig().isPostBindingResponse()) {
    responseType=(ResponseType)saml2Request.getSAML2ObjectFromStream(PostBindingUtil.base64DecodeAsStream(URLDecoder.decode(samlResponse,"UTF-8")));
  }
 else {
    responseType=(ResponseType)saml2Request.getSAML2ObjectFromStream(RedirectBindingUtil.base64DeflateDecode((samlResponse)));
  }
  validateStatusResponse(responseType);
  validateSignature(saml2Request);
  List<RTChoiceType> assertions=responseType.getAssertions();
  if (assertions.isEmpty()) {
    throw new RuntimeException("No assertion from response.");
  }
  RTChoiceType rtChoiceType=assertions.get(0);
  EncryptedAssertionType encryptedAssertion=rtChoiceType.getEncryptedAssertion();
  if (encryptedAssertion != null) {
    decryptAssertion(responseType,request.getRealm().getPrivateKey());
  }
  return responseType.getAssertions().get(0).getAssertion();
}
