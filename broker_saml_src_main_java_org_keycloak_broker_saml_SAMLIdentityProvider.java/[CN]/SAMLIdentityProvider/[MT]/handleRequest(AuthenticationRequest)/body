{
  try {
    UriInfo uriInfo=request.getUriInfo();
    String issuerURL=UriBuilder.fromUri(uriInfo.getBaseUri()).build().toString();
    String destinationUrl=getConfig().getSingleSignOnServiceUrl();
    String nameIDPolicyFormat=getConfig().getNameIDPolicyFormat();
    if (nameIDPolicyFormat == null) {
      nameIDPolicyFormat=JBossSAMLURIConstants.NAMEID_FORMAT_PERSISTENT.get();
    }
    String protocolBinding=JBossSAMLURIConstants.SAML_HTTP_REDIRECT_BINDING.get();
    if (getConfig().isPostBindingResponse()) {
      protocolBinding=JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();
    }
    SAML2AuthnRequestBuilder authnRequestBuilder=new SAML2AuthnRequestBuilder().assertionConsumerUrl(request.getRedirectUri()).destination(destinationUrl).issuer(issuerURL).forceAuthn(getConfig().isForceAuthn()).protocolBinding(protocolBinding).nameIdPolicy(SAML2NameIDPolicyBuilder.format(nameIDPolicyFormat)).relayState(request.getState());
    if (getConfig().isWantAuthnRequestsSigned()) {
      PrivateKey privateKey=request.getRealm().getPrivateKey();
      PublicKey publicKey=request.getRealm().getPublicKey();
      if (privateKey == null) {
        throw new RuntimeException("Identity Provider [" + getConfig().getName() + "] wants a signed authentication request. But the Realm ["+ request.getRealm().getName()+ "] does not have a private key.");
      }
      if (publicKey == null) {
        throw new RuntimeException("Identity Provider [" + getConfig().getName() + "] wants a signed authentication request. But the Realm ["+ request.getRealm().getName()+ "] does not have a public key.");
      }
      KeyPair keypair=new KeyPair(publicKey,privateKey);
      authnRequestBuilder.signWith(keypair);
    }
    if (getConfig().isPostBindingAuthnRequest()) {
      return AuthenticationResponse.fromResponse(authnRequestBuilder.postBinding().request());
    }
 else {
      return AuthenticationResponse.fromResponse(authnRequestBuilder.redirectBinding().request());
    }
  }
 catch (  Exception e) {
    throw new RuntimeException("Could not create authentication request.",e);
  }
}
