{
  RealmRepresentation rep=ModelToRepresentation.toRepresentation(realm,true);
  rep.setEventsEnabled(realm.isEventsEnabled());
  if (realm.getEventsExpiration() != 0) {
    rep.setEventsExpiration(realm.getEventsExpiration());
  }
  if (realm.getEventsListeners() != null) {
    rep.setEventsListeners(new LinkedList<String>(realm.getEventsListeners()));
  }
  List<ClientModel> applications=realm.getClients();
  List<ApplicationRepresentation> appReps=new ArrayList<ApplicationRepresentation>();
  for (  ClientModel app : applications) {
    ApplicationRepresentation appRep=exportApplication(app);
    appReps.add(appRep);
  }
  rep.setApplications(appReps);
  List<RoleRepresentation> realmRoleReps=null;
  Map<String,List<RoleRepresentation>> appRolesReps=new HashMap<String,List<RoleRepresentation>>();
  Set<RoleModel> realmRoles=realm.getRoles();
  if (realmRoles != null && realmRoles.size() > 0) {
    realmRoleReps=exportRoles(realmRoles);
  }
  for (  ClientModel app : applications) {
    Set<RoleModel> currentAppRoles=app.getRoles();
    List<RoleRepresentation> currentAppRoleReps=exportRoles(currentAppRoles);
    appRolesReps.put(app.getClientId(),currentAppRoleReps);
  }
  RolesRepresentation rolesRep=new RolesRepresentation();
  if (realmRoleReps != null) {
    rolesRep.setRealm(realmRoleReps);
  }
  if (appRolesReps.size() > 0) {
    rolesRep.setApplication(appRolesReps);
  }
  rep.setRoles(rolesRep);
  List<ClientModel> allClients=new ArrayList<>(applications);
  Map<String,List<ScopeMappingRepresentation>> appScopeReps=new HashMap<>();
  for (  ClientModel client : allClients) {
    Set<RoleModel> clientScopes=client.getScopeMappings();
    ScopeMappingRepresentation scopeMappingRep=null;
    for (    RoleModel scope : clientScopes) {
      if (scope.getContainer() instanceof RealmModel) {
        if (scopeMappingRep == null) {
          scopeMappingRep=rep.scopeMapping(client.getClientId());
        }
        scopeMappingRep.role(scope.getName());
      }
 else {
        ClientModel app=(ClientModel)scope.getContainer();
        String appName=app.getClientId();
        List<ScopeMappingRepresentation> currentAppScopes=appScopeReps.get(appName);
        if (currentAppScopes == null) {
          currentAppScopes=new ArrayList<>();
          appScopeReps.put(appName,currentAppScopes);
        }
        ScopeMappingRepresentation currentClientScope=null;
        for (        ScopeMappingRepresentation scopeMapping : currentAppScopes) {
          if (scopeMapping.getClient().equals(client.getClientId())) {
            currentClientScope=scopeMapping;
            break;
          }
        }
        if (currentClientScope == null) {
          currentClientScope=new ScopeMappingRepresentation();
          currentClientScope.setClient(client.getClientId());
          currentAppScopes.add(currentClientScope);
        }
        currentClientScope.role(scope.getName());
      }
    }
  }
  if (appScopeReps.size() > 0) {
    rep.setApplicationScopeMappings(appScopeReps);
  }
  if (includeUsers) {
    List<UserModel> allUsers=session.users().getUsers(realm);
    List<UserRepresentation> users=new ArrayList<UserRepresentation>();
    for (    UserModel user : allUsers) {
      UserRepresentation userRep=exportUser(session,realm,user);
      users.add(userRep);
    }
    if (users.size() > 0) {
      rep.setUsers(users);
    }
  }
  return rep;
}
