{
  UserFederationSyncResult syncResult=new UserFederationSyncResult();
  for (  LDAPUser ldapUser : ldapUsers) {
    String username=ldapUser.getLoginName();
    UserModel currentUser=session.userStorage().getUserByUsername(username,realm);
    if (currentUser == null) {
      importUserFromLDAP(realm,ldapUser);
      syncResult.increaseAdded();
    }
 else {
      if ((fedModel.getId().equals(currentUser.getFederationLink())) && (ldapUser.getId().equals(currentUser.getAttribute(LDAPConstants.LDAP_ID)))) {
        String email=(ldapUser.getEmail() != null && ldapUser.getEmail().trim().length() > 0) ? ldapUser.getEmail() : null;
        currentUser.setEmail(email);
        currentUser.setFirstName(ldapUser.getFirstName());
        currentUser.setLastName(ldapUser.getLastName());
        logger.debugf("Updated user from LDAP: %s",currentUser.getUsername());
        syncResult.increaseUpdated();
      }
 else {
        logger.warnf("User '%s' is not updated during sync as he is not linked to federation provider '%s'",username,fedModel.getDisplayName());
      }
    }
  }
  return syncResult;
}
