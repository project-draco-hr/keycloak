{
  for (  User picketlinkUser : users) {
    String username=picketlinkUser.getLoginName();
    UserModel currentUser=session.userStorage().getUserByUsername(username,realm);
    if (currentUser == null) {
      importUserFromPicketlink(realm,picketlinkUser);
      logger.debugf("Added new user from LDAP: %s",username);
    }
 else {
      if ((fedModel.getId().equals(currentUser.getFederationLink())) && (picketlinkUser.getId().equals(currentUser.getAttribute(LDAPFederationProvider.LDAP_ID)))) {
        String email=(picketlinkUser.getEmail() != null && picketlinkUser.getEmail().trim().length() > 0) ? picketlinkUser.getEmail() : null;
        currentUser.setEmail(email);
        currentUser.setFirstName(picketlinkUser.getFirstName());
        currentUser.setLastName(picketlinkUser.getLastName());
        logger.debugf("Updated user from LDAP: %s",currentUser.getUsername());
      }
 else {
        logger.warnf("User '%s' is not updated during sync as he is not linked to federation provider '%s'",username,fedModel.getDisplayName());
      }
    }
  }
}
