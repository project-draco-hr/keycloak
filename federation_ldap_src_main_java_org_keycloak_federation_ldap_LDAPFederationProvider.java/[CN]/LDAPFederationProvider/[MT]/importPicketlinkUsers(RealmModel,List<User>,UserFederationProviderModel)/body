{
  for (  User picketlinkUser : users) {
    String username=picketlinkUser.getLoginName();
    UserModel currentUser=session.userStorage().getUserByUsername(username,realm);
    if (currentUser == null) {
      importUserFromPicketlink(realm,picketlinkUser);
      logger.infof("Added new user from LDAP: " + username);
    }
 else {
      if ((fedModel.getId().equals(currentUser.getFederationLink())) && (picketlinkUser.getId().equals(currentUser.getAttribute(LDAPFederationProvider.LDAP_ID)))) {
        String email=(picketlinkUser.getEmail() != null && picketlinkUser.getEmail().trim().length() > 0) ? picketlinkUser.getEmail() : null;
        currentUser.setEmail(email);
        currentUser.setFirstName(picketlinkUser.getFirstName());
        currentUser.setLastName(picketlinkUser.getLastName());
        logger.infof("Updated user from LDAP: " + currentUser.getUsername());
      }
 else {
        throw new IllegalStateException("User " + username + " has invalid LDAP ID or doesn't have federation link");
      }
    }
  }
}
