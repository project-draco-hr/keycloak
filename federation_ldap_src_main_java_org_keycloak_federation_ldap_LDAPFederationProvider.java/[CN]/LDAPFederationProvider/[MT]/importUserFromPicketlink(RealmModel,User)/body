{
  String email=(picketlinkUser.getEmail() != null && picketlinkUser.getEmail().trim().length() > 0) ? picketlinkUser.getEmail() : null;
  if (picketlinkUser.getLoginName() == null) {
    throw new ModelException("User returned from LDAP has null username! Check configuration of your LDAP mappings. ID of user from LDAP: " + picketlinkUser.getId());
  }
  UserModel imported=session.userStorage().addUser(realm,picketlinkUser.getLoginName());
  imported.setEnabled(true);
  imported.setEmail(email);
  imported.setFirstName(picketlinkUser.getFirstName());
  imported.setLastName(picketlinkUser.getLastName());
  imported.setFederationLink(model.getId());
  imported.setAttribute(LDAP_ID,picketlinkUser.getId());
  logger.debugf("Added new user from LDAP. Username: " + imported.getUsername() + ", Email: ",imported.getEmail() + ", LDAP_ID: " + picketlinkUser.getId());
  return proxy(imported);
}
