{
  LDAPQuery ldapQuery=LDAPUtils.createQueryForUserSearch(this,realm);
  LDAPQueryConditionsBuilder conditionsBuilder=new LDAPQueryConditionsBuilder();
  String usernameMappedAttribute=this.ldapIdentityStore.getConfig().getUsernameLdapAttribute();
  Condition usernameCondition=conditionsBuilder.equal(new QueryParameter(usernameMappedAttribute),username);
  ldapQuery.where(usernameCondition);
  LDAPObject ldapUser=ldapQuery.getFirstResult();
  if (ldapUser == null) {
    return null;
  }
  String ldapUsername=LDAPUtils.getUsername(ldapUser,ldapIdentityStore.getConfig());
  if (!username.equals(ldapUsername)) {
    logger.warnf("User found in LDAP but with different username. LDAP username: %s, Searched username: %s",username,ldapUsername);
    return null;
  }
  return ldapUser;
}
