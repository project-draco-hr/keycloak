{
  if (!synchronizeRegistrations())   throw new IllegalStateException("Registration is not supported by this ldap server");
  IdentityManager identityManager=getIdentityManager();
  try {
    User picketlinkUser=new User(user.getUsername());
    picketlinkUser.setFirstName(user.getFirstName());
    picketlinkUser.setLastName(user.getLastName());
    picketlinkUser.setEmail(user.getEmail());
    identityManager.add(picketlinkUser);
    user.setAttribute(LDAP_ID,picketlinkUser.getId());
    return proxy(user);
  }
 catch (  IdentityManagementException ie) {
    throw convertIDMException(ie);
  }
}
