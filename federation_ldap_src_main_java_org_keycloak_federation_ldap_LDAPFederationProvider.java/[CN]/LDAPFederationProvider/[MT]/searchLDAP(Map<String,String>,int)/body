{
  Map<String,LDAPUser> results=new HashMap<String,LDAPUser>();
  if (attributes.containsKey(USERNAME)) {
    LDAPUser user=LDAPUtils.getUser(this.ldapIdentityStore,attributes.get(USERNAME));
    if (user != null) {
      results.put(user.getLoginName(),user);
    }
  }
  if (attributes.containsKey(EMAIL)) {
    LDAPUser user=queryByEmail(attributes.get(EMAIL));
    if (user != null) {
      results.put(user.getLoginName(),user);
    }
  }
  if (attributes.containsKey(FIRST_NAME) || attributes.containsKey(LAST_NAME)) {
    IdentityQueryBuilder queryBuilder=this.ldapIdentityStore.createQueryBuilder();
    IdentityQuery<LDAPUser> query=queryBuilder.createIdentityQuery(LDAPUser.class);
    if (attributes.containsKey(FIRST_NAME)) {
      query.where(queryBuilder.equal(LDAPUser.FIRST_NAME,attributes.get(FIRST_NAME)));
    }
    if (attributes.containsKey(LAST_NAME)) {
      query.where(queryBuilder.equal(LDAPUser.LAST_NAME,attributes.get(LAST_NAME)));
    }
    query.setLimit(maxResults);
    List<LDAPUser> users=query.getResultList();
    for (    LDAPUser user : users) {
      results.put(user.getLoginName(),user);
    }
  }
  return results;
}
