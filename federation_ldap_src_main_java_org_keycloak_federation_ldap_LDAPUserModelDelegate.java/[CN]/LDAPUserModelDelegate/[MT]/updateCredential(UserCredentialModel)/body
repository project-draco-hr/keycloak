{
  if (!provider.getSupportedCredentialTypes().contains(cred.getType())) {
    delegate.updateCredential(cred);
    return;
  }
  IdentityManager identityManager=provider.getIdentityManager();
  try {
    User picketlinkUser=BasicModel.getUser(identityManager,getUsername());
    if (picketlinkUser == null) {
      logger.debugf("User '%s' doesn't exists. Skip password update",getUsername());
      throw new IllegalStateException("User doesn't exist in LDAP storage");
    }
    if (cred.getType().equals(UserCredentialModel.PASSWORD)) {
      identityManager.updateCredential(picketlinkUser,new Password(cred.getValue().toCharArray()));
    }
 else     if (cred.getType().equals(UserCredentialModel.TOTP)) {
      TOTPCredential credential=new TOTPCredential(cred.getValue());
      credential.setDevice(cred.getDevice());
      identityManager.updateCredential(picketlinkUser,credential);
    }
  }
 catch (  IdentityManagementException ie) {
    throw new ModelException(ie);
  }
}
