{
  try {
    ThemeProvider themeProvider=session.getProvider(ThemeProvider.class,"extending");
    Theme theme=themeProvider.getTheme(realm.getEmailTheme(),Theme.Type.EMAIL);
    String subject=theme.getMessages().getProperty(subjectKey);
    String body=freeMarker.processTemplate(attributes,template,theme);
    send(subject,body);
  }
 catch (  Exception e) {
    throw new EmailException("Failed to template email",e);
  }
}
