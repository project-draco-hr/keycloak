{
  try {
    ThemeProvider themeProvider=session.getProvider(ThemeProvider.class,"extending");
    Theme theme=themeProvider.getTheme(realm.getEmailTheme(),Theme.Type.EMAIL);
    Locale locale=LocaleHelper.getLocale(realm,user);
    attributes.put("locale",locale);
    Properties rb=theme.getMessages(locale);
    attributes.put("msg",new MessageFormatterMethod(locale,rb));
    String subject=new MessageFormat(rb.getProperty(subjectKey,subjectKey),locale).format(new Object[0]);
    String body=freeMarker.processTemplate(attributes,template,theme);
    send(subject,body);
  }
 catch (  Exception e) {
    throw new EmailException("Failed to template email",e);
  }
}
