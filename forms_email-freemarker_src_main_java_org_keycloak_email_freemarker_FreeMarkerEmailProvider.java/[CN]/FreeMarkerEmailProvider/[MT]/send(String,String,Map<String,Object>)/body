{
  try {
    ThemeProvider themeProvider=session.getProvider(ThemeProvider.class,"extending");
    Theme theme=themeProvider.getTheme(realm.getEmailTheme(),Theme.Type.EMAIL);
    Locale locale=LocaleHelper.getLocale(realm,user);
    attributes.put("locale",locale);
    Properties rb=theme.getMessages(locale);
    attributes.put("rb",rb);
    attributes.put("formatter",new TextFormatterBean(locale));
    String subject=rb.getProperty(subjectKey);
    String body=freeMarker.processTemplate(attributes,template,theme);
    send(subject,body);
  }
 catch (  Exception e) {
    throw new EmailException("Failed to template email",e);
  }
}
