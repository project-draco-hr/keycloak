{
  if (log.isTraceEnabled()) {
    log.trace("checking whether to refresh.");
  }
  if (isActive())   return;
  if (this.deployment == null || refreshToken == null)   return;
  if (log.isTraceEnabled()) {
    log.trace("Doing refresh");
  }
  AccessTokenResponse response=null;
  try {
    response=ServerRequest.invokeRefresh(deployment,refreshToken);
  }
 catch (  IOException e) {
    log.error("Refresh token failure",e);
    return;
  }
catch (  ServerRequest.HttpFailure httpFailure) {
    log.error("Refresh token failure status: " + httpFailure.getStatus() + " "+ httpFailure.getError());
    return;
  }
  if (log.isTraceEnabled()) {
    log.trace("received refresh response");
  }
  String tokenString=response.getToken();
  AccessToken token=null;
  try {
    token=RSATokenVerifier.verifyToken(tokenString,deployment.getRealmKey(),deployment.getRealm());
    log.debug("Token Verification succeeded!");
  }
 catch (  VerificationException e) {
    log.error("failed verification of token");
  }
  if (response.getNotBeforePolicy() > deployment.getNotBefore()) {
    deployment.setNotBefore(response.getNotBeforePolicy());
  }
  this.token=token;
  this.refreshToken=response.getRefreshToken();
  this.tokenString=tokenString;
}
