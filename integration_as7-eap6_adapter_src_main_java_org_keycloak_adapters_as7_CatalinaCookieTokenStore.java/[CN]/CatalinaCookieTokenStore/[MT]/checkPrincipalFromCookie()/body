{
  KeycloakPrincipal<RefreshableKeycloakSecurityContext> principal=CookieTokenStore.getPrincipalFromCookie(deployment,facade,this);
  if (principal == null) {
    log.debug("Account was not in cookie or was invalid");
    return null;
  }
  RefreshableKeycloakSecurityContext session=principal.getKeycloakSecurityContext();
  if (!session.getRealm().equals(deployment.getRealm())) {
    log.debug("Account from cookie is from a different realm than for the request.");
    return null;
  }
  if (session.isActive() && !session.getDeployment().isAlwaysRefreshToken())   return principal;
  boolean success=session.refreshExpiredToken(false);
  if (success && session.isActive())   return principal;
  log.debugf("Cleanup and expire cookie for user %s after failed refresh",principal.getName());
  request.setUserPrincipal(null);
  request.setAuthType(null);
  CookieTokenStore.removeCookie(facade);
  return null;
}
