{
  if (request.getSessionInternal(false) == null || request.getSessionInternal().getPrincipal() == null)   return;
  RefreshableKeycloakSecurityContext session=(RefreshableKeycloakSecurityContext)request.getSessionInternal().getNote(KeycloakSecurityContext.class.getName());
  if (session == null)   return;
  if (!deployment.getRealm().equals(session.getRealm())) {
    log.debug("Account from cookie is from a different realm than for the request.");
    return;
  }
  if (session.getDeployment() == null)   session.setCurrentRequestInfo(deployment,this);
  if (session.isActive() && !session.getDeployment().isAlwaysRefreshToken())   return;
  boolean success=session.refreshExpiredToken(false);
  if (success && session.isActive())   return;
  Session catalinaSession=request.getSessionInternal();
  log.debugf("Cleanup and expire session %s after failed refresh",catalinaSession.getId());
  catalinaSession.removeNote(KeycloakSecurityContext.class.getName());
  request.setUserPrincipal(null);
  request.setAuthType(null);
  catalinaSession.setPrincipal(null);
  catalinaSession.setAuthType(null);
  catalinaSession.expire();
}
