{
  if (!Session.SESSION_DESTROYED_EVENT.equals(event.getType()) && (!Session.SESSION_PASSIVATED_EVENT.equals(event.getType())))   return;
  Session session=event.getSession();
  GenericPrincipal principal=(GenericPrincipal)session.getPrincipal();
  if (principal == null)   return;
  session.setPrincipal(null);
  session.setAuthType(null);
  String username=principal.getUserPrincipal().getName();
  UserSessions userSessions=userSessionMap.get(username);
  if (userSessions == null) {
    return;
  }
  String sessionid=session.getId();
synchronized (this) {
    String keycloakSessionId=userSessions.httpSessionToKeycloakSession.remove(sessionid);
    if (keycloakSessionId != null) {
      userSessions.keycloakSessionToHttpSession.remove(keycloakSessionId);
      keycloakSessionMap.remove(keycloakSessionId);
    }
    userSessions.sessions.remove(sessionid);
    if (userSessions.httpSessionToKeycloakSession.size() == 0) {
      userSessionMap.remove(username);
    }
  }
}
