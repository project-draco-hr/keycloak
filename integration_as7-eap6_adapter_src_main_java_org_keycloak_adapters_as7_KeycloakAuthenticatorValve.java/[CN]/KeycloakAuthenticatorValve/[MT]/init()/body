{
  String configResolverClass=(String)context.getServletContext().getAttribute("keycloak.config.resolver");
  if (configResolverClass != null) {
    try {
      KeycloakConfigResolver configResolver=(KeycloakConfigResolver)context.getLoader().getClassLoader().loadClass(configResolverClass).newInstance();
      deploymentContext=new AdapterDeploymentContext(configResolver);
      log.info("Using " + configResolverClass + " to resolve Keycloak configuration on a per-request basis.");
    }
 catch (    Exception ex) {
      log.warn("The specified resolver " + configResolverClass + " could NOT be loaded. Keycloak is unconfigured and will deny all requests. Reason: "+ ex.getMessage());
      deploymentContext=new AdapterDeploymentContext(new KeycloakDeployment());
    }
  }
 else {
    InputStream configInputStream=getConfigInputStream(context);
    KeycloakDeployment kd;
    if (configInputStream == null) {
      log.warn("No adapter configuration. Keycloak is unconfigured and will deny all requests.");
      kd=new KeycloakDeployment();
    }
 else {
      kd=KeycloakDeploymentBuilder.build(configInputStream);
    }
    deploymentContext=new AdapterDeploymentContext(kd);
    log.debug("Keycloak is using a per-deployment configuration.");
  }
  context.getServletContext().setAttribute(AdapterDeploymentContext.class.getName(),deploymentContext);
  AuthenticatedActionsValve actions=new AuthenticatedActionsValve(deploymentContext,getNext(),getContainer(),getController());
  setNext(actions);
  nodesRegistrationManagement=new NodesRegistrationManagement();
}
