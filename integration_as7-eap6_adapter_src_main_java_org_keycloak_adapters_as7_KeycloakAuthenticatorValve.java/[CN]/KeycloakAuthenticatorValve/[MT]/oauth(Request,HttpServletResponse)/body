{
  ServletOAuthLogin oauth=new ServletOAuthLogin(realmConfiguration,request,response,request.getConnector().getRedirectPort());
  String code=oauth.getCode();
  if (code == null) {
    String error=oauth.getError();
    if (error != null) {
      response.sendError(HttpServletResponse.SC_BAD_REQUEST,"OAuth " + error);
      return;
    }
 else {
      saveRequest(request,request.getSessionInternal(true));
      oauth.loginRedirect();
    }
    return;
  }
 else {
    if (!oauth.resolveCode(code))     return;
    AccessToken token=oauth.getToken();
    Set<String> roles=new HashSet<String>();
    if (adapterConfig.isUseResourceRoleMappings()) {
      AccessToken.Access access=token.getResourceAccess(resourceMetadata.getResourceName());
      if (access != null)       roles.addAll(access.getRoles());
    }
 else {
      AccessToken.Access access=token.getRealmAccess();
      if (access != null)       roles.addAll(access.getRoles());
    }
    KeycloakPrincipal skp=new KeycloakPrincipal(token.getSubject(),null);
    GenericPrincipal principal=new CatalinaSecurityContextHelper().createPrincipal(context.getRealm(),skp,roles);
    Session session=request.getSessionInternal(true);
    session.setPrincipal(principal);
    session.setAuthType("OAUTH");
    KeycloakAuthenticatedSession skSession=new KeycloakAuthenticatedSession(oauth.getTokenString(),token,realmConfiguration.getMetadata());
    session.setNote(KeycloakAuthenticatedSession.class.getName(),skSession);
    String username=token.getSubject();
    log.debug("userSessionManage.login: " + username);
    userSessionManagement.login(session,username);
  }
}
