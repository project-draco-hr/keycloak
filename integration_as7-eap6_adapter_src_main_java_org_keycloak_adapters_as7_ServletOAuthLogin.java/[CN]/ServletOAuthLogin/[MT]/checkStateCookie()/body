{
  Cookie stateCookie=getCookie(realmInfo.getStateCookieName());
  if (stateCookie == null) {
    sendError(HttpServletResponse.SC_BAD_REQUEST);
    log.warn("No state cookie");
    return false;
  }
  log.debug("** reseting application state cookie");
  Cookie reset=new Cookie(realmInfo.getStateCookieName(),"");
  reset.setPath(getDefaultCookiePath());
  reset.setMaxAge(0);
  response.addCookie(reset);
  String stateCookieValue=getCookieValue(realmInfo.getStateCookieName());
  String state=request.getParameter("state");
  if (state == null) {
    sendError(HttpServletResponse.SC_BAD_REQUEST);
    log.warn("state parameter was null");
    return false;
  }
  if (!state.equals(stateCookieValue)) {
    sendError(HttpServletResponse.SC_BAD_REQUEST);
    log.warn("state parameter invalid");
    log.warn("cookie: " + stateCookieValue);
    log.warn("queryParam: " + state);
    return false;
  }
  return true;
}
