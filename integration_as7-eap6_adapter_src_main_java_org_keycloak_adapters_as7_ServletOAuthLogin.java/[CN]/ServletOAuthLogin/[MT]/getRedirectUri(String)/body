{
  String url=getRequestUrl();
  if (!isRequestSecure() && deployment.isSslRequired()) {
    int port=redirectPort;
    if (port < 0) {
      return null;
    }
    KeycloakUriBuilder secureUrl=KeycloakUriBuilder.fromUri(url).scheme("https").port(-1);
    if (port != 443)     secureUrl.port(port);
    url=secureUrl.build().toString();
  }
  KeycloakUriBuilder uriBuilder=deployment.getAuthUrl().clone().queryParam("client_id",deployment.getResourceName()).queryParam("redirect_uri",url).queryParam("state",state).queryParam("login","true");
  if (deployment.getScope() != null) {
    uriBuilder.queryParam("scope",deployment.getScope());
  }
  return uriBuilder.build().toString();
}
