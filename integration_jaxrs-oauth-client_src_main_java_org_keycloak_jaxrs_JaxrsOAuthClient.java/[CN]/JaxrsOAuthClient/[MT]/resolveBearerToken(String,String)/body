{
  redirectUri=stripOauthParametersFromRedirect(redirectUri);
  Form codeForm=new Form().param("grant_type","authorization_code").param("code",code).param("client_id",clientId).param("redirect_uri",redirectUri);
  for (  Map.Entry<String,String> entry : credentials.entrySet()) {
    codeForm.param(entry.getKey(),entry.getValue());
  }
  Response res=client.target(codeUrl).request().post(Entity.form(codeForm));
  try {
    if (res.getStatus() == 400) {
      throw new BadRequestException();
    }
 else     if (res.getStatus() != 200) {
      throw new InternalServerErrorException(new Exception("Unknown error when getting acess token"));
    }
    AccessTokenResponse tokenResponse=res.readEntity(AccessTokenResponse.class);
    return tokenResponse.getToken();
  }
  finally {
    res.close();
  }
}
