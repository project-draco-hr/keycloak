{
  AdapterTokenStore store=(AdapterTokenStore)request.getNote(TOKEN_STORE_NOTE);
  if (store != null) {
    return store;
  }
  if (resolvedDeployment.getTokenStore() == TokenStore.SESSION) {
    store=new CatalinaSessionTokenStore(request,resolvedDeployment,userSessionManagement,createPrincipalFactory());
  }
 else {
    store=new CatalinaCookieTokenStore(request,facade,resolvedDeployment,createPrincipalFactory());
  }
  request.setNote(TOKEN_STORE_NOTE,store);
  return store;
}
