{
  if (request.getSessionInternal(false) == null || request.getSessionInternal().getPrincipal() == null)   return false;
  log.fine("remote logged in already. Establish state from session");
  RefreshableKeycloakSecurityContext securityContext=(RefreshableKeycloakSecurityContext)request.getSessionInternal().getNote(KeycloakSecurityContext.class.getName());
  if (securityContext != null) {
    if (!deployment.getRealm().equals(securityContext.getRealm())) {
      log.fine("Account from cookie is from a different realm than for the request.");
      return false;
    }
    securityContext.setCurrentRequestInfo(deployment,this);
    request.setAttribute(KeycloakSecurityContext.class.getName(),securityContext);
  }
  GenericPrincipal principal=(GenericPrincipal)request.getSessionInternal().getPrincipal();
  request.setUserPrincipal(principal);
  request.setAuthType("KEYCLOAK");
  restoreRequest();
  return true;
}
