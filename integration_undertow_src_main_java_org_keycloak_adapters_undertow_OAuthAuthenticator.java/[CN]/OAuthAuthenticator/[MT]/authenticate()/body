{
  String code=getCode();
  if (code == null) {
    log.info("there was no code");
    String error=getError();
    if (error != null) {
      log.warn("There was an error: " + error);
      challenge=challenge(400);
      return AuthenticationMechanism.AuthenticationMechanismOutcome.NOT_AUTHENTICATED;
    }
 else {
      log.info("redirecting to auth server");
      challenge=loginRedirect();
      return AuthenticationMechanism.AuthenticationMechanismOutcome.NOT_ATTEMPTED;
    }
  }
 else {
    log.info("there was a code, resolving");
    challenge=resolveCode(code);
    if (challenge != null) {
      return AuthenticationMechanism.AuthenticationMechanismOutcome.NOT_AUTHENTICATED;
    }
    return AuthenticationMechanism.AuthenticationMechanismOutcome.AUTHENTICATED;
  }
}
