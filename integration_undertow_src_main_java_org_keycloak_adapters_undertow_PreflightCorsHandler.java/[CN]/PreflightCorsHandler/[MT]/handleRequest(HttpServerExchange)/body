{
  log.debugv("checkCorsPreflight {0}",exchange.getRequestURI());
  if (!exchange.getRequestMethod().toString().equalsIgnoreCase("OPTIONS")) {
    log.debug("checkCorsPreflight: not options ");
    next.handleRequest(exchange);
    return;
  }
  if (exchange.getRequestHeaders().getFirst("Origin") == null) {
    log.debug("checkCorsPreflight: no origin header");
    next.handleRequest(exchange);
    return;
  }
  log.debug("Preflight request returning");
  exchange.setResponseCode(200);
  String origin=exchange.getRequestHeaders().getFirst("Origin");
  exchange.getResponseHeaders().put(ACCESS_CONTROL_ALLOW_ORIGIN,origin);
  exchange.getResponseHeaders().put(ACCESS_CONTROL_ALLOW_CREDENTIALS,"true");
  String requestMethods=exchange.getRequestHeaders().getFirst("Access-Control-Request-Method");
  if (requestMethods != null) {
    if (config.getCorsAllowedMethods() != null) {
      requestMethods=config.getCorsAllowedMethods();
    }
    exchange.getResponseHeaders().put(ACCESS_CONTROL_ALLOW_METHODS,requestMethods);
  }
  String allowHeaders=exchange.getRequestHeaders().getFirst("Access-Control-Request-Headers");
  if (allowHeaders != null) {
    if (config.getCorsAllowedHeaders() != null) {
      allowHeaders=config.getCorsAllowedHeaders();
    }
    exchange.getResponseHeaders().put(ACCESS_CONTROL_ALLOW_HEADERS,allowHeaders);
  }
  if (config.getCorsMaxAge() > -1) {
    exchange.getResponseHeaders().put(ACCESS_CONTROL_MAX_AGE,Integer.toString(config.getCorsMaxAge()));
  }
  exchange.endExchange();
}
