{
  log.debug("handleRequest");
  KeycloakUndertowAccount account=(KeycloakUndertowAccount)exchange.getSecurityContext().getAuthenticatedAccount();
  if (account == null) {
    log.debug("Not logged in, nothing to propagate");
    next.handleRequest(exchange);
    return;
  }
  UndertowKeycloakSession skSession=new UndertowKeycloakSession(account);
  final ServletRequestContext servletRequestContext=exchange.getAttachment(ServletRequestContext.ATTACHMENT_KEY);
  HttpServletRequest req=(HttpServletRequest)servletRequestContext.getServletRequest();
  req.setAttribute(KeycloakAuthenticatedSession.class.getName(),skSession);
  HttpSession session=req.getSession(false);
  if (session == null) {
    next.handleRequest(exchange);
    return;
  }
  log.debug("propagating to HTTP Session");
  session.setAttribute(KeycloakAuthenticatedSession.class.getName(),skSession);
  next.handleRequest(exchange);
}
