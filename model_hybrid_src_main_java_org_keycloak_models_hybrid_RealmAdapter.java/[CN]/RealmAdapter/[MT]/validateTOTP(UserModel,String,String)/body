{
  if (provider.users().supports(Feature.VERIFY_CREDENTIALS)) {
    User user=provider.mappings().unwrap(userModel);
    return provider.users().verifyCredentials(user,new Credentials(UserCredentialModel.PASSWORD,password),new Credentials(UserCredentialModel.TOTP,token));
  }
 else {
    if (!validatePassword(userModel,password))     return false;
    for (    UserCredentialValueModel cred : userModel.getCredentialsDirectly()) {
      if (cred.getType().equals(UserCredentialModel.TOTP)) {
        return new TimeBasedOTP().validate(token,cred.getValue().getBytes());
      }
    }
    return false;
  }
}
