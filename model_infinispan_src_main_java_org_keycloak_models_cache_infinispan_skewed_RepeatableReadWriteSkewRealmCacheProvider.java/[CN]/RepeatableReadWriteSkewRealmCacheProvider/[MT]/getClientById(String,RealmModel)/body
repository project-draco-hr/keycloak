{
  cache.startBatch();
  boolean batchEnded=false;
  CachedClient cached=cache.getApplication(id);
  try {
    if (cached != null && !cached.getRealm().equals(realm.getId())) {
      cached=null;
    }
    if (cached == null) {
      ClientModel model=getDelegate().getClientById(id,realm);
      if (model == null)       return null;
      if (appInvalidations.contains(id))       return model;
      cached=new CachedClient(cache,getDelegate(),realm,model);
      cache.addCachedClient(cached);
      try {
        batchEnded=true;
        cache.endBatch(true);
      }
 catch (      Exception exception) {
        logger.trace("failed to add to cache",exception);
        return model;
      }
    }
 else     if (appInvalidations.contains(id)) {
      return getDelegate().getClientById(id,realm);
    }
 else     if (managedApplications.containsKey(id)) {
      return managedApplications.get(id);
    }
    ClientAdapter adapter=new ClientAdapter(realm,cached,this,cache);
    managedApplications.put(id,adapter);
    return adapter;
  }
  finally {
    if (!batchEnded)     cache.endBatch(true);
  }
}
