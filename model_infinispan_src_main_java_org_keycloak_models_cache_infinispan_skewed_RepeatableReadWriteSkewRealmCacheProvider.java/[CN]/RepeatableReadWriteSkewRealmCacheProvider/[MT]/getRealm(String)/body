{
  cache.startBatch();
  boolean batchEnded=false;
  try {
    CachedRealm cached=cache.getCachedRealm(id);
    boolean wasNull=cached == null;
    if (cached == null) {
      RealmModel model=getDelegate().getRealm(id);
      if (model == null)       return null;
      if (realmInvalidations.contains(id))       return model;
      cached=new CachedRealm(cache,this,model);
      cache.addCachedRealm(cached);
      try {
        batchEnded=true;
        cache.endBatch(true);
        logger.trace("returning new cached realm");
      }
 catch (      Exception exception) {
        logger.trace("failed to add to cache",exception);
        return model;
      }
    }
 else     if (realmInvalidations.contains(id)) {
      return getDelegate().getRealm(id);
    }
 else     if (managedRealms.containsKey(id)) {
      return managedRealms.get(id);
    }
    if (!wasNull)     logger.trace("returning cached realm: " + cached.getName());
    RealmAdapter adapter=new RealmAdapter(cached,this);
    managedRealms.put(id,adapter);
    return adapter;
  }
  finally {
    if (!batchEnded)     cache.endBatch(true);
  }
}
