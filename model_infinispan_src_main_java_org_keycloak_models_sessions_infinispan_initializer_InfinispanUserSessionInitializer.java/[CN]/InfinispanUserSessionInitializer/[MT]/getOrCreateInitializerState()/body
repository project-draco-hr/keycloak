{
  TimeAwareInitializerState state=(TimeAwareInitializerState)cache.get(stateKey);
  if (state == null) {
    int startTime=(int)(sessionFactory.getServerStartupTimestamp() / 1000);
    final int[] count=new int[1];
    KeycloakModelUtils.runJobInTransaction(sessionFactory,new KeycloakSessionTask(){
      @Override public void run(      KeycloakSession session){
        sessionLoader.init(session,startTime);
      }
    }
);
    KeycloakModelUtils.runJobInTransaction(sessionFactory,new KeycloakSessionTask(){
      @Override public void run(      KeycloakSession session){
        count[0]=sessionLoader.getSessionsCount(session);
      }
    }
);
    state=new TimeAwareInitializerState();
    state.init(count[0],sessionsPerSegment);
    state.setClusterStartupTime(startTime);
    saveStateToCache(state);
  }
  return state;
}
