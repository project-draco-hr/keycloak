{
  if (emf == null) {
synchronized (this) {
      if (emf == null) {
        logger.debug("Initializing JPA connections");
        Map<String,Object> properties=new HashMap<String,Object>();
        String unitName="keycloak-default";
        String dataSource=config.get("dataSource");
        if (dataSource != null) {
          if (config.getBoolean("jta",false)) {
            properties.put(AvailableSettings.JTA_DATASOURCE,dataSource);
          }
 else {
            properties.put(AvailableSettings.NON_JTA_DATASOURCE,dataSource);
          }
        }
 else {
          properties.put(AvailableSettings.JDBC_URL,config.get("url"));
          properties.put(AvailableSettings.JDBC_DRIVER,config.get("driver"));
          String user=config.get("user");
          if (user != null) {
            properties.put(AvailableSettings.JDBC_USER,user);
          }
          String password=config.get("password");
          if (password != null) {
            properties.put(AvailableSettings.JDBC_PASSWORD,password);
          }
        }
        String schema=getSchema();
        if (schema != null) {
          properties.put(JpaUtils.HIBERNATE_DEFAULT_SCHEMA,schema);
        }
        MigrationStrategy migrationStrategy=getMigrationStrategy();
        boolean initializeEmpty=config.getBoolean("initializeEmpty",true);
        File databaseUpdateFile=getDatabaseUpdateFile();
        properties.put("hibernate.show_sql",config.getBoolean("showSql",false));
        properties.put("hibernate.format_sql",config.getBoolean("formatSql",true));
        Connection connection=getConnection();
        try {
          prepareOperationalInfo(connection);
          String driverDialect=detectDialect(connection);
          if (driverDialect != null) {
            properties.put("hibernate.dialect",driverDialect);
          }
          migration(migrationStrategy,initializeEmpty,schema,databaseUpdateFile,connection,session);
          int globalStatsInterval=config.getInt("globalStatsInterval",-1);
          if (globalStatsInterval != -1) {
            properties.put("hibernate.generate_statistics",true);
          }
          logger.trace("Creating EntityManagerFactory");
          emf=JpaUtils.createEntityManagerFactory(session,unitName,properties,getClass().getClassLoader());
          logger.trace("EntityManagerFactory created");
          if (globalStatsInterval != -1) {
            startGlobalStats(session,globalStatsInterval);
          }
        }
  finally {
          if (connection != null) {
            try {
              connection.close();
            }
 catch (            SQLException e) {
              logger.warn("Can't close connection",e);
            }
          }
        }
      }
    }
  }
}
