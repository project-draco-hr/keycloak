{
  logger.debug("Starting database update");
  ThreadLocalSessionContext.setCurrentSession(session);
  try {
    Liquibase liquibase=getLiquibase(connection,defaultSchema);
    List<ChangeSet> changeSets=liquibase.listUnrunChangeSets((Contexts)null);
    if (!changeSets.isEmpty()) {
      if (changeSets.get(0).getId().equals(FIRST_VERSION)) {
        logger.info("Initializing database schema");
      }
 else {
        if (logger.isDebugEnabled()) {
          List<RanChangeSet> ranChangeSets=liquibase.getDatabase().getRanChangeSetList();
          logger.debugv("Updating database from {0} to {1}",ranChangeSets.get(ranChangeSets.size() - 1).getId(),changeSets.get(changeSets.size() - 1).getId());
        }
 else {
          logger.infov("Updating database");
        }
      }
      liquibase.update((Contexts)null);
      logger.debug("Completed database update");
    }
 else {
      logger.debug("Database is up to date");
    }
  }
 catch (  Exception e) {
    throw new RuntimeException("Failed to update database",e);
  }
 finally {
    ThreadLocalSessionContext.removeCurrentSession();
  }
}
