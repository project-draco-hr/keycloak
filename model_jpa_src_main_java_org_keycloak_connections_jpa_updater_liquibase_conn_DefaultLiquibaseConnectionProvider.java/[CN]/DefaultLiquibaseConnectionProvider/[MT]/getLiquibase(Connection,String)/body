{
  Database database=DatabaseFactory.getInstance().findCorrectDatabaseImplementation(new JdbcConnection(connection));
  if (defaultSchema != null) {
    database.setDefaultSchemaName(defaultSchema);
  }
  String changelog=(database instanceof DB2Database) ? LiquibaseJpaUpdaterProvider.DB2_CHANGELOG : LiquibaseJpaUpdaterProvider.CHANGELOG;
  logger.debugf("Using changelog file: %s",changelog);
  ResourceAccessor resourceAccessor=new ClassLoaderResourceAccessor(getClass().getClassLoader());
  DatabaseChangeLog databaseChangeLog=generateDynamicChangeLog(changelog,resourceAccessor,database);
  return new Liquibase(databaseChangeLog,resourceAccessor,database);
}
