{
  PersistenceXmlParser parser=new PersistenceXmlParser(new ClassLoaderServiceImpl(classLoader),PersistenceUnitTransactionType.RESOURCE_LOCAL);
  List<ParsedPersistenceXmlDescriptor> persistenceUnits=parser.doResolve(properties);
  for (  ParsedPersistenceXmlDescriptor persistenceUnit : persistenceUnits) {
    if (persistenceUnit.getName().equals(unitName)) {
      return Bootstrap.getEntityManagerFactoryBuilder(persistenceUnit,properties,classLoader).build();
    }
  }
  throw new RuntimeException("Persistence unit '" + unitName + "' not found");
}
