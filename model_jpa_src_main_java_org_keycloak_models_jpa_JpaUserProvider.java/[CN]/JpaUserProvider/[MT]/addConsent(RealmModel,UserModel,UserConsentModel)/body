{
  String clientId=consent.getClient().getId();
  UserConsentEntity consentEntity=getGrantedConsentEntity(user,clientId);
  if (consentEntity != null) {
    throw new ModelDuplicateException("Consent already exists for client [" + clientId + "] and user ["+ user.getId()+ "]");
  }
  long currentTime=Time.currentTimeMillis();
  consentEntity=new UserConsentEntity();
  consentEntity.setId(KeycloakModelUtils.generateId());
  consentEntity.setUser(em.getReference(UserEntity.class,user.getId()));
  consentEntity.setClientId(clientId);
  consentEntity.setCreatedDate(currentTime);
  consentEntity.setLastUpdatedDate(currentTime);
  em.persist(consentEntity);
  em.flush();
  updateGrantedConsentEntity(consentEntity,consent);
}
