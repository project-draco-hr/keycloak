{
  if (id == null) {
    id=KeycloakModelUtils.generateId();
  }
  UserEntity entity=new UserEntity();
  entity.setId(id);
  entity.setUsername(username);
  RealmEntity realmEntity=em.getReference(RealmEntity.class,realm.getId());
  entity.setRealm(realmEntity);
  em.persist(entity);
  em.flush();
  UserModel userModel=new UserAdapter(realm,em,entity);
  if (addDefaultRoles) {
    for (    String r : realm.getDefaultRoles()) {
      userModel.grantRole(realm.getRole(r));
    }
    for (    ApplicationModel application : realm.getApplications()) {
      for (      String r : application.getDefaultRoles()) {
        userModel.grantRole(application.getRole(r));
      }
    }
  }
  return userModel;
}
