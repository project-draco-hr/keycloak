{
  StringBuilder builder=new StringBuilder("select u from UserEntity u");
  boolean first=true;
  for (  Map.Entry<String,String> entry : attributes.entrySet()) {
    String attribute=null;
    if (entry.getKey().equals(UserModel.LOGIN_NAME)) {
      attribute="lower(username)";
    }
 else     if (entry.getKey().equalsIgnoreCase(UserModel.FIRST_NAME)) {
      attribute="lower(firstName)";
    }
 else     if (entry.getKey().equalsIgnoreCase(UserModel.LAST_NAME)) {
      attribute="lower(lastName)";
    }
 else     if (entry.getKey().equalsIgnoreCase(UserModel.EMAIL)) {
      attribute="lower(email)";
    }
    if (attribute == null)     continue;
    if (first) {
      first=false;
      builder.append(" where realm = :realm");
    }
 else {
      builder.append(" and ");
    }
    builder.append(attribute).append(" like '%").append(entry.getValue().toLowerCase()).append("%'");
  }
  builder.append(" order by u.username");
  String q=builder.toString();
  TypedQuery<UserEntity> query=em.createQuery(q,UserEntity.class);
  query.setParameter("realmId",realm.getId());
  if (firstResult != -1) {
    query.setFirstResult(firstResult);
  }
  if (maxResults != -1) {
    query.setMaxResults(maxResults);
  }
  List<UserEntity> results=query.getResultList();
  List<UserModel> users=new ArrayList<UserModel>();
  for (  UserEntity entity : results)   users.add(new UserAdapter(realm,em,entity));
  return users;
}
