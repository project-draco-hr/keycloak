{
  String clientId=consent.getClientId();
  if (clientId == null) {
    throw new ModelException("clientId needs to be filled for newly added consent!");
  }
  GrantedConsentEntity consentEntity=getGrantedConsentEntity(clientId);
  if (consentEntity != null) {
    throw new ModelDuplicateException("Consent already exists for client [" + clientId + "] and user ["+ user.getId()+ "]");
  }
  consentEntity=new GrantedConsentEntity();
  consentEntity.setId(KeycloakModelUtils.generateId());
  consentEntity.setUser(user);
  consentEntity.setClientId(clientId);
  em.persist(consentEntity);
  em.flush();
  updateGrantedConsentEntity(consentEntity,consent);
  return consent;
}
