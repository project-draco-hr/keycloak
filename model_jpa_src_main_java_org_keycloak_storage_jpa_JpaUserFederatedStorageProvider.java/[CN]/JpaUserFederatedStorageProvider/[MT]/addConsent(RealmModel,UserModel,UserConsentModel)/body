{
  String clientId=consent.getClient().getId();
  FederatedUserConsentEntity consentEntity=getGrantedConsentEntity(user,clientId);
  if (consentEntity != null) {
    throw new ModelDuplicateException("Consent already exists for client [" + clientId + "] and user ["+ user.getId()+ "]");
  }
  consentEntity=new FederatedUserConsentEntity();
  consentEntity.setId(KeycloakModelUtils.generateId());
  consentEntity.setUserId(user.getId());
  consentEntity.setClientId(clientId);
  consentEntity.setStorageProviderId(StorageId.resolveProviderId(user));
  em.persist(consentEntity);
  em.flush();
  updateGrantedConsentEntity(consentEntity,consent);
}
