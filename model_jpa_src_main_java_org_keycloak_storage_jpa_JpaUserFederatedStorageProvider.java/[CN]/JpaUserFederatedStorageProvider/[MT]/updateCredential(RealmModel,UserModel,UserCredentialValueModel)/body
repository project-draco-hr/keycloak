{
  FederatedUserCredentialEntity entity=null;
  if (cred.getId() != null)   entity=em.find(FederatedUserCredentialEntity.class,cred.getId());
  boolean newEntity=false;
  if (entity == null) {
    entity=new FederatedUserCredentialEntity();
    entity.setId(KeycloakModelUtils.generateId());
    newEntity=true;
  }
  entity.setUserId(user.getId());
  entity.setRealmId(realm.getId());
  entity.setStorageProviderId(StorageId.resolveProviderId(user));
  entity.setAlgorithm(cred.getAlgorithm());
  entity.setCounter(cred.getCounter());
  Long createdDate=cred.getCreatedDate();
  if (createdDate == null)   createdDate=System.currentTimeMillis();
  entity.setCreatedDate(createdDate);
  entity.setDevice(cred.getDevice());
  entity.setDigits(cred.getDigits());
  entity.setHashIterations(cred.getHashIterations());
  entity.setPeriod(cred.getPeriod());
  entity.setSalt(cred.getSalt());
  entity.setType(cred.getType());
  entity.setValue(cred.getValue());
  if (newEntity) {
    em.persist(entity);
  }
}
