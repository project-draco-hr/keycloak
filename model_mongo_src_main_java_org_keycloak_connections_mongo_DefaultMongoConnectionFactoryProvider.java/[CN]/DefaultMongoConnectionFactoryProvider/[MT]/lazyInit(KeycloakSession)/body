{
  if (client == null) {
synchronized (this) {
      if (client == null) {
        try {
          this.client=createMongoClient();
          String dbName=config.get("db","keycloak");
          this.db=client.getDB(dbName);
          String databaseSchema=config.get("databaseSchema");
          if (databaseSchema != null) {
            if (databaseSchema.equals("update")) {
              MongoUpdaterProvider mongoUpdater=session.getProvider(MongoUpdaterProvider.class);
              if (mongoUpdater == null) {
                throw new RuntimeException("Can't update database: Mongo updater provider not found");
              }
              mongoUpdater.update(session,db);
            }
 else {
              throw new RuntimeException("Invalid value for databaseSchema: " + databaseSchema);
            }
          }
          this.mongoStore=new MongoStoreImpl(db,getManagedEntities());
        }
 catch (        Exception e) {
          throw new RuntimeException(e);
        }
      }
    }
  }
}
