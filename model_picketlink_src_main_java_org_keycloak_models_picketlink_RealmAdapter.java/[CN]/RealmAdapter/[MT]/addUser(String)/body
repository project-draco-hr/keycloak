{
  User user=findPicketlinkUser(username);
  if (user != null)   throw new IllegalStateException("User already exists");
  user=new User(username);
  getIdm().add(user);
  UserAdapter userModel=new UserAdapter(user,getIdm());
  for (  String r : getDefaultRoles()) {
    grantRole(userModel,getRole(r));
  }
  for (  ApplicationModel application : getApplications()) {
    for (    String r : application.getDefaultRoles()) {
      application.grantRole(userModel,application.getRole(r));
    }
  }
  return userModel;
}
