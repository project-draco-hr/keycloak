{
  if (compatMode == null) {
synchronized (this) {
      if (compatMode == null) {
        compatMode=isCompatMode(session);
        if (compatMode) {
          compatProviderFactory=new MemUserSessionProviderFactory();
          log.info("Infinispan version doesn't support map reduce for local cache. Falling back to deprecated mem user session provider.");
        }
      }
    }
  }
  if (!compatMode) {
    InfinispanConnectionProvider connections=session.getProvider(InfinispanConnectionProvider.class);
    Cache<String,SessionEntity> cache=connections.getCache(InfinispanConnectionProvider.SESSION_CACHE_NAME);
    Cache<LoginFailureKey,LoginFailureEntity> loginFailures=connections.getCache(InfinispanConnectionProvider.LOGIN_FAILURE_CACHE_NAME);
    return new InfinispanUserSessionProvider(session,cache,loginFailures);
  }
 else {
    return compatProviderFactory.create(session);
  }
}
