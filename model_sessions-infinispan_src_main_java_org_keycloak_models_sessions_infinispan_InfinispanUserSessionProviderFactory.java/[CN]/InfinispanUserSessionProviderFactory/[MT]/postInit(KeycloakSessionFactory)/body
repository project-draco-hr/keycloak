{
  KeycloakModelUtils.runJobInTransaction(factory,new KeycloakSessionTask(){
    @Override public void run(    KeycloakSession session){
      compatMode=isCompatMode(session);
      if (compatMode) {
        compatProviderFactory=new MemUserSessionProviderFactory();
      }
      log.debug("Clearing detached sessions from persistent storage");
      UserSessionPersisterProvider persister=session.getProvider(UserSessionPersisterProvider.class);
      if (persister == null) {
        throw new RuntimeException("userSessionPersister not configured. Please see the migration docs and upgrade your configuration");
      }
 else {
        persister.clearDetachedUserSessions();
      }
    }
  }
);
  int maxErrors=config.getInt("maxErrors",50);
  int sessionsPerSegment=config.getInt("sessionsPerSegment",100);
  loadPersistentSessions(factory,maxErrors,sessionsPerSegment);
}
