{
  String id=KeycloakModelUtils.generateId();
  UserSessionEntity entity=new UserSessionEntity();
  entity.setId(id);
  entity.setRealm(realm.getId());
  entity.setUser(user.getId());
  entity.setLoginUsername(loginUsername);
  entity.setIpAddress(ipAddress);
  entity.setAuthMethod(authMethod);
  entity.setRememberMe(rememberMe);
  int currentTime=Time.currentTime();
  entity.setStarted(currentTime);
  entity.setLastSessionRefresh(currentTime);
  entity.setBrokerSessionId(brokerSessionId);
  entity.setBrokerUserId(brokerUserId);
  userSessions.put(id,entity);
  if (brokerSessionId != null) {
    userSessionsByBrokerSessionId.put(brokerSessionId,id);
  }
  if (brokerUserId != null) {
    while (true) {
      Set<String> set=userSessionsByBrokerUserId.get(brokerUserId);
      if (set == null) {
        Set<String> value=new HashSet<>();
        set=userSessionsByBrokerUserId.putIfAbsent(brokerUserId,value);
        if (set == null) {
          set=value;
        }
      }
synchronized (set) {
        set.add(id);
      }
      if (userSessionsByBrokerUserId.get(brokerUserId) == set) {
        break;
      }
    }
  }
  return new UserSessionAdapter(session,this,realm,entity);
}
