{
  MultivaluedMap<String,String> formData=createFormData("john","password");
  Assert.assertEquals(AuthenticationManager.AuthenticationStatus.SUCCESS,am.authenticateForm(session,null,realm1,formData));
  Assert.assertEquals(AuthenticationManager.AuthenticationStatus.INVALID_USER,am.authenticateForm(session,null,realm2,formData));
  Assert.assertNull(realm2.getUser("john"));
  setupAuthenticationProviders();
  try {
    ResteasyProviderFactory.pushContext(KeycloakSession.class,session);
    Assert.assertEquals(AuthenticationManager.AuthenticationStatus.SUCCESS,am.authenticateForm(session,null,realm2,formData));
    UserModel john2=realm2.getUser("john");
    Assert.assertNotNull(john2);
    Assert.assertEquals("john",john2.getUsername());
    Assert.assertEquals("John",john2.getFirstName());
    Assert.assertEquals("Doe",john2.getLastName());
    Assert.assertEquals("john@email.org",john2.getEmail());
    AuthenticationLinkModel authLink=john2.getAuthenticationLink();
    Assert.assertNotNull(authLink);
    Assert.assertEquals(authLink.getAuthProvider(),AuthProviderConstants.PROVIDER_NAME_EXTERNAL_MODEL);
    Assert.assertEquals(authLink.getAuthUserId(),realm1.getUser("john").getId());
  }
  finally {
    ResteasyProviderFactory.clearContextData();
  }
}
