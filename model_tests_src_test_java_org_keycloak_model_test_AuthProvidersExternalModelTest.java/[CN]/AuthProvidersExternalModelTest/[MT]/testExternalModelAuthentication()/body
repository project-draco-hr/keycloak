{
  MultivaluedMap<String,String> formData=createFormData("john","password");
  Assert.assertEquals(AuthenticationManager.AuthenticationStatus.SUCCESS,am.authenticateForm(realm1,formData));
  Assert.assertEquals(AuthenticationManager.AuthenticationStatus.INVALID_USER,am.authenticateForm(realm2,formData));
  Assert.assertNull(realm2.getUser("john"));
  setupAuthenticationProviders();
  try {
    ResteasyProviderFactory.pushContext(KeycloakSession.class,identitySession);
    Assert.assertEquals(AuthenticationManager.AuthenticationStatus.SUCCESS,am.authenticateForm(realm2,formData));
    UserModel john2=realm2.getUser("john");
    Assert.assertNotNull(john2);
    Assert.assertEquals("john",john2.getLoginName());
    Assert.assertEquals("John",john2.getFirstName());
    Assert.assertEquals("Doe",john2.getLastName());
    Assert.assertEquals("john@email.org",john2.getEmail());
    Set<AuthenticationLinkModel> authLinks=realm2.getAuthenticationLinks(john2);
    Assert.assertEquals(1,authLinks.size());
    AuthenticationLinkModel authLink=authLinks.iterator().next();
    Assert.assertEquals(authLink.getAuthProvider(),AuthProviderConstants.PROVIDER_NAME_EXTERNAL_MODEL);
  }
  finally {
    ResteasyProviderFactory.clearContextData();
  }
}
