{
  setupAuthenticationProviders();
  UserModel john=realm2.addUser("john");
  john.setEnabled(true);
  realm2.setAuthenticationLink(john,new AuthenticationLinkModel(AuthProviderConstants.PROVIDER_NAME_EXTERNAL_MODEL,realm1.getUser("john").getId()));
  try {
    ResteasyProviderFactory.pushContext(KeycloakSession.class,identitySession);
    AuthenticationProviderManager authProviderManager=AuthenticationProviderManager.getManager(realm2,providerSession);
    try {
      Assert.assertTrue(authProviderManager.updatePassword(john,"password-updated"));
    }
 catch (    AuthenticationProviderException ape) {
      ape.printStackTrace();
      Assert.fail("Error not expected");
    }
    MultivaluedMap<String,String> formData=createFormData("john","password-updated");
    Assert.assertEquals(AuthenticationManager.AuthenticationStatus.SUCCESS,am.authenticateForm(null,realm1,formData));
    Assert.assertEquals(AuthenticationManager.AuthenticationStatus.SUCCESS,am.authenticateForm(null,realm2,formData));
    setPasswordUpdateForProvider(false,AuthProviderConstants.PROVIDER_NAME_EXTERNAL_MODEL,realm2);
    try {
      Assert.assertFalse(authProviderManager.updatePassword(john,"password-updated2"));
    }
 catch (    AuthenticationProviderException ape) {
      ape.printStackTrace();
      Assert.fail("Error not expected");
    }
    formData=createFormData("john","password-updated2");
    Assert.assertEquals(AuthenticationManager.AuthenticationStatus.INVALID_CREDENTIALS,am.authenticateForm(null,realm1,formData));
    Assert.assertEquals(AuthenticationManager.AuthenticationStatus.INVALID_CREDENTIALS,am.authenticateForm(null,realm2,formData));
    setPasswordUpdateForProvider(true,AuthProviderConstants.PROVIDER_NAME_EXTERNAL_MODEL,realm2);
    realm1.setPasswordPolicy(new PasswordPolicy("length(8)"));
    try {
      authProviderManager.updatePassword(john,"passw");
      Assert.fail("Update not expected to pass");
    }
 catch (    AuthenticationProviderException ape) {
    }
  }
  finally {
    ResteasyProviderFactory.clearContextData();
  }
}
