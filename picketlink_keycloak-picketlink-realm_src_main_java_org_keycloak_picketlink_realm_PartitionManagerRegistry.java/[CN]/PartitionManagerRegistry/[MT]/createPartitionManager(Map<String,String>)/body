{
  IdentityConfigurationBuilder builder=new IdentityConfigurationBuilder();
  Properties connectionProps=new Properties();
  connectionProps.put("com.sun.jndi.ldap.connect.pool","true");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.authentication","none simple");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.initsize","1");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.maxsize","10");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.prefsize","5");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.timeout","300000");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.protocol","plain");
  checkSystemProperty("com.sun.jndi.ldap.connect.pool.debug","off");
  String vendor=ldapConfig.get(LDAPConstants.VENDOR);
  if (vendor != null && vendor.equals(LDAPConstants.VENDOR_RHDS)) {
    checkSystemProperty(LDAPIdentityStoreConfiguration.ENTRY_IDENTIFIER_ATTRIBUTE_NAME,"nsuniqueid");
  }
  boolean activeDirectory=vendor != null && vendor.equals(LDAPConstants.VENDOR_ACTIVE_DIRECTORY);
  String ldapLoginNameMapping=ldapConfig.get(LDAPConstants.USERNAME_LDAP_ATTRIBUTE);
  if (ldapLoginNameMapping == null) {
    ldapLoginNameMapping=activeDirectory ? CN : UID;
  }
  ldapLoginNameMapping=getNameOfLDAPAttribute("keycloak.ldap.idm.loginName",ldapLoginNameMapping,ldapLoginNameMapping,activeDirectory);
  String ldapFirstNameMapping=getNameOfLDAPAttribute("keycloak.ldap.idm.firstName",CN,"givenName",activeDirectory);
  String ldapLastNameMapping=getNameOfLDAPAttribute("keycloak.ldap.idm.lastName",SN,SN,activeDirectory);
  String ldapEmailMapping=getNameOfLDAPAttribute("keycloak.ldap.idm.email",EMAIL,EMAIL,activeDirectory);
  String[] userObjectClasses=getUserObjectClasses(ldapConfig);
  logger.infof("LDAP Attributes mapping: loginName: %s, firstName: %s, lastName: %s, email: %s",ldapLoginNameMapping,ldapFirstNameMapping,ldapLastNameMapping,ldapEmailMapping);
  builder.named("SIMPLE_LDAP_STORE_CONFIG").stores().ldap().connectionProperties(connectionProps).addCredentialHandler(LDAPKeycloakCredentialHandler.class).baseDN(ldapConfig.get(LDAPConstants.BASE_DN)).bindDN(ldapConfig.get(LDAPConstants.BIND_DN)).bindCredential(ldapConfig.get(LDAPConstants.BIND_CREDENTIAL)).url(ldapConfig.get(LDAPConstants.CONNECTION_URL)).activeDirectory(activeDirectory).supportAllFeatures().mapping(User.class).baseDN(ldapConfig.get(LDAPConstants.USER_DN_SUFFIX)).objectClasses(userObjectClasses).attribute("loginName",ldapLoginNameMapping,true).attribute("firstName",ldapFirstNameMapping).attribute("lastName",ldapLastNameMapping).attribute("email",ldapEmailMapping);
  List<IdentityConfiguration> identityConfigs=builder.buildAll();
  IdentityStoreConfiguration identityStoreConfig=identityConfigs.get(0).getStoreConfiguration().get(0);
  ((AbstractIdentityStoreConfiguration)identityStoreConfig).setIdentityStoreType(KeycloakLDAPIdentityStore.class);
  return new DefaultPartitionManager(identityConfigs);
}
