{
  String requestID=clientSession.getNote("REQUEST_ID");
  String relayState=clientSession.getNote(GeneralConstants.RELAY_STATE);
  String redirectUri=clientSession.getRedirectUri();
  String responseIssuer=getResponseIssuer(realm);
  SAML2PostBindingResponseBuilder builder=new SAML2PostBindingResponseBuilder();
  builder.requestID(requestID).relayState(relayState).destination(redirectUri).responseIssuer(responseIssuer).requestIssuer(clientSession.getClient().getClientId()).userPrincipal(userSession.getUser().getUsername()).attribute(X500SAMLProfileConstants.USERID.getFriendlyName(),userSession.getUser().getId()).authMethod(JBossSAMLURIConstants.AC_UNSPECIFIED.get());
  initClaims(builder,clientSession.getClient(),userSession.getUser());
  if (clientSession.getRoles() != null) {
    for (    String roleId : clientSession.getRoles()) {
      RoleModel roleModel=clientSession.getRealm().getRoleById(roleId);
      builder.roles(roleModel.getName());
    }
  }
  try {
    return builder.buildLoginResponse();
  }
 catch (  Exception e) {
    logger.error("failed",e);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Failed to process response");
  }
}
