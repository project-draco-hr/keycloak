{
  logger.debug("finishLogout");
  String logoutBindingUri=userSession.getNote(SAML_LOGOUT_BINDING_URI);
  String logoutRelayState=userSession.getNote(SAML_LOGOUT_RELAY_STATE);
  SAML2LogoutResponseBuilder builder=new SAML2LogoutResponseBuilder();
  builder.logoutRequestID(userSession.getNote(SAML_LOGOUT_REQUEST_ID));
  builder.destination(logoutBindingUri);
  builder.issuer(getResponseIssuer(realm));
  builder.relayState(logoutRelayState);
  String signingAlgorithm=userSession.getNote(SAML_LOGOUT_SIGNATURE_ALGORITHM);
  if (signingAlgorithm != null) {
    SignatureAlgorithm algorithm=SignatureAlgorithm.valueOf(signingAlgorithm);
    builder.signatureAlgorithm(algorithm).signWith(realm.getPrivateKey(),realm.getPublicKey(),realm.getCertificate()).signDocument();
  }
  try {
    if (isLogoutPostBindingForInitiator(userSession)) {
      return builder.postBinding().response(logoutBindingUri);
    }
 else {
      return builder.redirectBinding().response(logoutBindingUri);
    }
  }
 catch (  ConfigurationException e) {
    throw new RuntimeException(e);
  }
catch (  ProcessingException e) {
    throw new RuntimeException(e);
  }
catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
