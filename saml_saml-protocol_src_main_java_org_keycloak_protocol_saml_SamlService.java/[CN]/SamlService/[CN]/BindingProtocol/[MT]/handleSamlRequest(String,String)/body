{
  SAMLDocumentHolder documentHolder=extractDocument(samlRequest);
  if (documentHolder == null) {
    event.event(EventType.LOGIN);
    event.error(Errors.INVALID_TOKEN);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Invalid Request");
  }
  SAML2Object samlObject=documentHolder.getSamlObject();
  RequestAbstractType requestAbstractType=(RequestAbstractType)samlObject;
  String issuer=requestAbstractType.getIssuer().getValue();
  ClientModel client=realm.findClient(issuer);
  if (client == null) {
    event.event(EventType.LOGIN);
    event.error(Errors.CLIENT_NOT_FOUND);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Unknown login requester.");
  }
  if (!client.isEnabled()) {
    event.event(EventType.LOGIN);
    event.error(Errors.CLIENT_DISABLED);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Login requester not enabled.");
  }
  if ((client instanceof ApplicationModel) && ((ApplicationModel)client).isBearerOnly()) {
    event.event(EventType.LOGIN);
    event.error(Errors.NOT_ALLOWED);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Bearer-only applications are not allowed to initiate browser login");
  }
  if (client.isDirectGrantsOnly()) {
    event.event(EventType.LOGIN);
    event.error(Errors.NOT_ALLOWED);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"direct-grants-only clients are not allowed to initiate browser login");
  }
  try {
    verifySignature(documentHolder,client);
  }
 catch (  VerificationException e) {
    SamlService.logger.error("request validation failed",e);
    event.event(EventType.LOGIN);
    event.error(Errors.INVALID_SIGNATURE);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Invalid requester.");
  }
  logger.debug("verified request");
  if (samlObject instanceof AuthnRequestType) {
    logger.debug("** login request");
    event.event(EventType.LOGIN);
    AuthnRequestType authn=(AuthnRequestType)samlObject;
    return loginRequest(relayState,authn,client);
  }
 else   if (samlObject instanceof LogoutRequestType) {
    logger.debug("** logout request");
    event.event(EventType.LOGOUT);
    LogoutRequestType logout=(LogoutRequestType)samlObject;
    return logoutRequest(logout,client,relayState);
  }
 else {
    event.event(EventType.LOGIN);
    event.error(Errors.INVALID_TOKEN);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Invalid Request");
  }
}
