{
  String single=mappingModel.getConfig().get(SINGLE_ROLE_ATTRIBUTE);
  boolean singleAttribute=Boolean.parseBoolean(single);
  Map<ProtocolMapperModel,SAMLRoleNameMapper> roleNameMappers=new HashMap<>();
  KeycloakSessionFactory sessionFactory=session.getKeycloakSessionFactory();
  for (  ProtocolMapperModel mapping : clientSession.getClient().getProtocolMappers()) {
    if (!mapping.getProtocol().equals(SamlProtocol.LOGIN_PROTOCOL))     continue;
    ProtocolMapper mapper=(ProtocolMapper)sessionFactory.getProviderFactory(ProtocolMapper.class,mapping.getProtocolMapper());
    if (mapper == null || !(mapper instanceof SAMLRoleNameMapper))     continue;
    roleNameMappers.put(mapping,(SAMLRoleNameMapper)mapper);
  }
  AttributeType singleAttributeType=null;
  for (  String roleId : clientSession.getRoles()) {
    RoleModel roleModel=clientSession.getRealm().getRoleById(roleId);
    AttributeType attributeType=null;
    if (singleAttribute) {
      if (singleAttributeType == null) {
        singleAttributeType=AttributeStatementHelper.createAttributeType(mappingModel);
        roleAttributeStatement.addAttribute(new AttributeStatementType.ASTChoiceType(singleAttributeType));
      }
      attributeType=singleAttributeType;
    }
 else {
      attributeType=AttributeStatementHelper.createAttributeType(mappingModel);
      roleAttributeStatement.addAttribute(new AttributeStatementType.ASTChoiceType(attributeType));
    }
    String roleName=roleModel.getName();
    for (    Map.Entry<ProtocolMapperModel,SAMLRoleNameMapper> entry : roleNameMappers.entrySet()) {
      String newName=entry.getValue().mapName(entry.getKey(),roleModel);
      if (newName != null) {
        roleName=newName;
        break;
      }
    }
    attributeType.addAttributeValue(roleName);
  }
}
