{
  LinkedList<UserCredentialValueModel> credentialEntities=getCredentialsByType(provider,realm,user,UserCredentialModel.PASSWORD_HISTORY);
  if (credentialEntities.isEmpty()) {
    UserCredentialValueModel fedCred=new UserCredentialValueModel();
    fedCred.setCreatedDate(Time.toMillis(Time.currentTime()));
    fedCred.setType(cred.getType());
    fedCred.setDevice(cred.getDevice());
    fedCred.setValue(cred.getValue());
    OTPPolicy otpPolicy=realm.getOTPPolicy();
    fedCred.setAlgorithm(otpPolicy.getAlgorithm());
    fedCred.setDigits(otpPolicy.getDigits());
    fedCred.setCounter(otpPolicy.getInitialCounter());
    fedCred.setPeriod(otpPolicy.getPeriod());
    provider.updateCredential(realm,user,fedCred);
  }
 else {
    OTPPolicy policy=realm.getOTPPolicy();
    if (cred.getDevice() == null) {
      for (      UserCredentialValueModel model : credentialEntities)       provider.removeCredential(realm,user,model);
      UserCredentialValueModel fedCred=new UserCredentialValueModel();
      fedCred.setCreatedDate(Time.toMillis(Time.currentTime()));
      fedCred.setType(cred.getType());
      fedCred.setDevice(cred.getDevice());
      fedCred.setDigits(policy.getDigits());
      fedCred.setCounter(policy.getInitialCounter());
      fedCred.setAlgorithm(policy.getAlgorithm());
      fedCred.setValue(cred.getValue());
      fedCred.setPeriod(policy.getPeriod());
      provider.updateCredential(realm,user,fedCred);
    }
 else {
      UserCredentialValueModel fedCred=new UserCredentialValueModel();
      for (      UserCredentialValueModel model : credentialEntities) {
        if (cred.getDevice().equals(model.getDevice())) {
          fedCred=model;
          break;
        }
      }
      fedCred.setCreatedDate(Time.toMillis(Time.currentTime()));
      fedCred.setType(cred.getType());
      fedCred.setDevice(cred.getDevice());
      fedCred.setDigits(policy.getDigits());
      fedCred.setCounter(policy.getInitialCounter());
      fedCred.setAlgorithm(policy.getAlgorithm());
      fedCred.setValue(cred.getValue());
      fedCred.setPeriod(policy.getPeriod());
      provider.updateCredential(realm,user,fedCred);
    }
  }
}
