{
  PasswordPolicy policy=session.getContext().getRealm().getPasswordPolicy();
  int passwordHistoryPolicyValue=policy.getPolicyConfig(HistoryPasswordPolicyProviderFactory.ID);
  if (passwordHistoryPolicyValue != -1) {
    UserCredentialValueModel cred=getCredentialValueModel(user,UserCredentialModel.PASSWORD);
    if (cred != null) {
      if (PasswordHashManager.verify(session,policy,password,cred)) {
        return new PolicyError(ERROR_MESSAGE,passwordHistoryPolicyValue);
      }
    }
    List<UserCredentialValueModel> passwordExpiredCredentials=getCredentialValueModels(user,passwordHistoryPolicyValue - 1,UserCredentialModel.PASSWORD_HISTORY);
    for (    UserCredentialValueModel credential : passwordExpiredCredentials) {
      if (PasswordHashManager.verify(session,policy,password,credential)) {
        return new PolicyError(ERROR_MESSAGE,passwordHistoryPolicyValue);
      }
    }
  }
  return null;
}
