{
  String username=clientSession.getAuthenticatedUser().getUsername();
  String attemptedUsername=clientSession.getNote(AbstractFormAuthenticator.ATTEMPTED_USERNAME);
  if (attemptedUsername != null)   username=attemptedUsername;
  if (userSession == null) {
    boolean remember="true".equals(clientSession.getNote(Details.REMEMBER_ME));
    userSession=session.sessions().createUserSession(realm,clientSession.getAuthenticatedUser(),username,connection.getRemoteAddr(),"form",remember,null,null);
    userSession.setState(UserSessionModel.State.LOGGING_IN);
    userSessionCreated=true;
  }
  TokenManager.attachClientSession(userSession,clientSession);
  event.user(userSession.getUser()).detail(Details.USERNAME,username).session(userSession);
}
