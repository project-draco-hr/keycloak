{
  UserModel authUser=clientSession.getAuthenticatedUser();
  validateUser(authUser);
  Response challenge=null;
  Map<String,UserSessionModel.AuthenticatorStatus> previousAttempts=clientSession.getAuthenticators();
  for (  AuthenticatorModel model : authenticators) {
    UserSessionModel.AuthenticatorStatus oldStatus=previousAttempts.get(model.getAlias());
    if (isProcessed(oldStatus))     continue;
    AuthenticatorFactory factory=(AuthenticatorFactory)session.getKeycloakSessionFactory().getProviderFactory(Authenticator.class,model.getProviderId());
    Authenticator authenticator=factory.create(model);
    if (authenticator.requiresUser() && authUser == null) {
      if (authenticator.requiresUser()) {
        if (challenge != null)         return challenge;
        throw new AuthException(Error.UNKNOWN_USER);
      }
    }
    if (authUser != null && model.getRequirement() == AuthenticatorModel.Requirement.ALTERNATIVE) {
      clientSession.setAuthenticatorStatus(model.getAlias(),UserSessionModel.AuthenticatorStatus.SKIPPED);
      continue;
    }
    authUser=clientSession.getAuthenticatedUser();
    if (authenticator.requiresUser() && authUser != null && !authenticator.configuredFor(authUser)) {
      if (model.getRequirement() == AuthenticatorModel.Requirement.REQUIRED) {
        if (model.isUserSetupAllowed()) {
          clientSession.setAuthenticatorStatus(model.getAlias(),UserSessionModel.AuthenticatorStatus.SETUP_REQUIRED);
          authUser.addRequiredAction(authenticator.getRequiredAction());
        }
 else {
          throw new AuthException(Error.CREDENTIAL_SETUP_REQUIRED);
        }
      }
      continue;
    }
    Result context=new Result(model,authenticator);
    authenticator.authenticate(context);
    Status result=context.getStatus();
    if (result == Status.SUCCESS) {
      clientSession.setAuthenticatorStatus(model.getAlias(),UserSessionModel.AuthenticatorStatus.SUCCESS);
      if (model.isMasterAuthenticator())       return authenticationComplete();
      continue;
    }
 else     if (result == Status.FAILED) {
      throw new AuthException(context.error);
    }
 else     if (result == Status.CHALLENGE) {
      if (model.getRequirement() == AuthenticatorModel.Requirement.REQUIRED)       return context.challenge;
      if (challenge != null)       challenge=context.challenge;
      continue;
    }
 else     if (result == Status.FAILURE_CHALLENGE) {
      logUserFailure();
      return context.challenge;
    }
 else     if (result == Status.ATTEMPTED) {
      if (model.getRequirement() == AuthenticatorModel.Requirement.REQUIRED)       throw new AuthException(Error.INVALID_CREDENTIALS);
      clientSession.setAuthenticatorStatus(model.getAlias(),UserSessionModel.AuthenticatorStatus.ATTEMPTED);
      continue;
    }
  }
  if (authUser == null) {
    if (challenge != null)     return challenge;
    throw new AuthException(Error.UNKNOWN_USER);
  }
  return authenticationComplete();
}
