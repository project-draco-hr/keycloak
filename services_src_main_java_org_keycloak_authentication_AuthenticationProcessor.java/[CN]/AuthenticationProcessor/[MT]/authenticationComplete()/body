{
  if (userSession == null) {
    userSession=session.sessions().createUserSession(realm,clientSession.getAuthenticatedUser(),clientSession.getAuthenticatedUser().getUsername(),connection.getRemoteAddr(),"form",false,null,null);
    userSession.setState(UserSessionModel.State.LOGGING_IN);
  }
  TokenManager.attachClientSession(userSession,clientSession);
  return processRequiredActions();
}
