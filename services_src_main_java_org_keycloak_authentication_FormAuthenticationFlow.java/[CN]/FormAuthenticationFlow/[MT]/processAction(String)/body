{
  if (!actionExecution.equals(execution.getId())) {
    throw new AuthenticationProcessor.AuthException("action is not current execution",AuthenticationProcessor.Error.INTERNAL_ERROR);
  }
  FormAuthenticator authenticator=processor.getSession().getProvider(FormAuthenticator.class,execution.getAuthenticator());
  for (  AuthenticationExecutionModel formActionExecution : processor.getRealm().getAuthenticationExecutions(execution.getFlowId())) {
    FormAction action=processor.getSession().getProvider(FormAction.class,execution.getAuthenticator());
    UserModel authUser=processor.getClientSession().getAuthenticatedUser();
    if (action.requiresUser() && authUser == null) {
      throw new AuthenticationProcessor.AuthException("form action: " + execution.getAuthenticator() + " requires user",AuthenticationProcessor.Error.UNKNOWN_USER);
    }
    boolean configuredFor=false;
    if (action.requiresUser() && authUser != null) {
      configuredFor=action.configuredFor(processor.getSession(),processor.getRealm(),authUser);
      if (!configuredFor) {
        if (formActionExecution.isRequired()) {
          if (formActionExecution.isUserSetupAllowed()) {
            AuthenticationProcessor.logger.debugv("authenticator SETUP_REQUIRED: {0}",execution.getAuthenticator());
            processor.getClientSession().setExecutionStatus(formActionExecution.getId(),ClientSessionModel.ExecutionStatus.SETUP_REQUIRED);
            action.setRequiredActions(processor.getSession(),processor.getRealm(),authUser);
            continue;
          }
 else {
            throw new AuthenticationProcessor.AuthException(AuthenticationProcessor.Error.CREDENTIAL_SETUP_REQUIRED);
          }
        }
 else         if (formActionExecution.isOptional()) {
          processor.getClientSession().setExecutionStatus(formActionExecution.getId(),ClientSessionModel.ExecutionStatus.SKIPPED);
          continue;
        }
      }
    }
    FormActionResult result=new FormActionResult(processor.createAuthenticatorContext(formActionExecution,null),authenticator);
    action.authenticate(result);
    return processResult(result,formActionExecution);
  }
  return null;
}
