{
  if (clientSession.getUserSession() != null) {
    return;
  }
  UserModel user=session.getUser();
  clientSession.setUserSession(session);
  Set<String> requestedRoles=new HashSet<String>();
  for (  RoleModel r : TokenManager.getAccess(null,clientSession.getClient(),user)) {
    requestedRoles.add(r.getId());
  }
  clientSession.setRoles(requestedRoles);
  Set<String> requestedProtocolMappers=new HashSet<String>();
  for (  ProtocolMapperModel protocolMapper : clientSession.getClient().getProtocolMappers()) {
    if (protocolMapper.getProtocol().equals(clientSession.getAuthMethod())) {
      requestedProtocolMappers.add(protocolMapper.getId());
    }
  }
  clientSession.setProtocolMappers(requestedProtocolMappers);
}
