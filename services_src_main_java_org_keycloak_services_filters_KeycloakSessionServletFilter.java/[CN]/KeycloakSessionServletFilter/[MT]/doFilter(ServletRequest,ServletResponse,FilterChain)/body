{
  ProviderSessionFactory providerSessionFactory=(ProviderSessionFactory)servletRequest.getServletContext().getAttribute(ProviderSessionFactory.class.getName());
  ProviderSession providerSession=providerSessionFactory.createSession();
  HttpServletRequest request=(HttpServletRequest)servletRequest;
  ResteasyProviderFactory.pushContext(ProviderSession.class,providerSession);
  KeycloakSession session=providerSession.getProvider(KeycloakSession.class);
  ResteasyProviderFactory.pushContext(KeycloakSession.class,session);
  KeycloakTransaction tx=session.getTransaction();
  ResteasyProviderFactory.pushContext(KeycloakTransaction.class,tx);
  tx.begin();
  try {
    filterChain.doFilter(servletRequest,servletResponse);
    if (tx.isActive()) {
      if (tx.getRollbackOnly())       tx.rollback();
 else       tx.commit();
    }
  }
 catch (  IOException ex) {
    if (tx.isActive())     tx.rollback();
    throw ex;
  }
catch (  ServletException ex) {
    if (tx.isActive())     tx.rollback();
    throw ex;
  }
catch (  RuntimeException ex) {
    if (tx.isActive())     tx.rollback();
    throw new RuntimeException("request path: " + request.getRequestURI(),ex);
  }
 finally {
    providerSession.close();
    ResteasyProviderFactory.clearContextData();
  }
}
