{
  final HttpServletRequest request=(HttpServletRequest)servletRequest;
  KeycloakSessionFactory sessionFactory=(KeycloakSessionFactory)servletRequest.getServletContext().getAttribute(KeycloakSessionFactory.class.getName());
  KeycloakSession session=sessionFactory.create();
  ResteasyProviderFactory.pushContext(KeycloakSession.class,session);
  ClientConnection connection=new ClientConnection(){
    @Override public String getRemoteAddr(){
      return request.getRemoteAddr();
    }
    @Override public String getRemoteHost(){
      return request.getRemoteHost();
    }
    @Override public int getReportPort(){
      return request.getRemotePort();
    }
  }
;
  session.getContext().setConnection(connection);
  ResteasyProviderFactory.pushContext(ClientConnection.class,connection);
  KeycloakTransaction tx=session.getTransaction();
  ResteasyProviderFactory.pushContext(KeycloakTransaction.class,tx);
  tx.begin();
  try {
    filterChain.doFilter(servletRequest,servletResponse);
    if (tx.isActive()) {
      if (tx.getRollbackOnly())       tx.rollback();
 else       tx.commit();
    }
  }
 catch (  IOException ex) {
    if (tx.isActive())     tx.rollback();
    throw ex;
  }
catch (  ServletException ex) {
    if (tx.isActive())     tx.rollback();
    throw ex;
  }
catch (  RuntimeException ex) {
    if (tx.isActive())     tx.rollback();
    throw new RuntimeException("request path: " + request.getRequestURI(),ex);
  }
 finally {
    session.close();
    ResteasyProviderFactory.clearContextData();
  }
}
