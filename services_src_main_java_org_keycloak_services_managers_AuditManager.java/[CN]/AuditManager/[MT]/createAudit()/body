{
  List<AuditListener> listeners=new LinkedList<AuditListener>();
  if (realm.isAuditEnabled()) {
    AuditProvider auditProvider=session.getProvider(AuditProvider.class);
    if (auditProvider != null) {
      listeners.add(auditProvider);
    }
 else {
      log.error("Audit enabled, but no audit provider configured");
    }
  }
  if (realm.getAuditListeners() != null) {
    for (    String id : realm.getAuditListeners()) {
      AuditListener listener=session.getProvider(AuditListener.class,id);
      if (listener != null) {
        listeners.add(listener);
      }
 else {
        log.error("Audit listener '" + id + "' registered, but not found");
      }
    }
  }
  return new Audit(listeners,realm,clientConnection.getRemoteAddr());
}
