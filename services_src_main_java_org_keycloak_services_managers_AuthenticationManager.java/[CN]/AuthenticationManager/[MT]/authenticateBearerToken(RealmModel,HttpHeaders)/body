{
  String tokenString=null;
  String authHeader=headers.getHeaderString(HttpHeaders.AUTHORIZATION);
  if (authHeader == null) {
    return null;
  }
 else {
    String[] split=authHeader.trim().split("\\s+");
    if (split == null || split.length != 2)     throw new NotAuthorizedException("Bearer");
    if (!split[0].equalsIgnoreCase("Bearer"))     throw new NotAuthorizedException("Bearer");
    tokenString=split[1];
  }
  try {
    SkeletonKeyToken token=RSATokenVerifier.verifyToken(tokenString,realm.getPublicKey(),realm.getId());
    if (!token.isActive()) {
      throw new NotAuthorizedException("token_expired");
    }
    Auth auth=new Auth(token);
    UserModel user=realm.getUser(token.getSubject());
    if (user == null || !user.isEnabled()) {
      throw new NotAuthorizedException("invalid_user");
    }
    auth.setUser(user);
    if (token.getIssuedFor() != null) {
      UserModel client=realm.getUser(token.getIssuedFor());
      if (client == null || !client.isEnabled()) {
        throw new NotAuthorizedException("invalid_user");
      }
      auth.setClient(client);
    }
    return auth;
  }
 catch (  VerificationException e) {
    logger.error("Failed to verify token",e);
    throw new NotAuthorizedException("invalid_token");
  }
}
