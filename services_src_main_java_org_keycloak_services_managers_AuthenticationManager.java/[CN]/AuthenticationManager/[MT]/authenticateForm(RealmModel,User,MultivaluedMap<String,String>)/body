{
  String username=user.getLoginName();
  Set<String> types=new HashSet<String>();
  for (  RequiredCredentialModel credential : realm.getRequiredCredentials()) {
    types.add(credential.getType());
  }
  if (types.contains(RequiredCredentialRepresentation.PASSWORD)) {
    String password=formData.getFirst(RequiredCredentialRepresentation.PASSWORD);
    if (password == null) {
      logger.warn("Password not provided");
      return false;
    }
    if (types.contains(RequiredCredentialRepresentation.TOTP)) {
      String token=formData.getFirst(RequiredCredentialRepresentation.TOTP);
      if (token == null) {
        logger.warn("TOTP token not provided");
        return false;
      }
      TOTPCredentials creds=new TOTPCredentials();
      creds.setToken(token);
      creds.setUsername(username);
      creds.setPassword(new Password(password));
      realm.getIdm().validateCredentials(creds);
      if (creds.getStatus() != Credentials.Status.VALID) {
        return false;
      }
    }
 else {
      UsernamePasswordCredentials creds=new UsernamePasswordCredentials(username,new Password(password));
      realm.getIdm().validateCredentials(creds);
      if (creds.getStatus() != Credentials.Status.VALID) {
        return false;
      }
    }
  }
 else {
    logger.warn("Do not know how to authenticate user");
    return false;
  }
  return true;
}
