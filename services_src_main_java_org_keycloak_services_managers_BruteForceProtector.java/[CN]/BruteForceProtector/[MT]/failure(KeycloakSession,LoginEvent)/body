{
  RealmModel realm=getRealmModel(session,event);
  logFailure(event);
  UsernameLoginFailureModel user=getUserModel(session,event);
  if (user == null)   return;
  user.setLastIPFailure(event.ip);
  long currentTime=System.currentTimeMillis();
  long last=user.getLastFailure();
  long deltaTime=0;
  if (last > 0) {
    deltaTime=currentTime - last;
  }
  user.setLastFailure(currentTime);
  if (deltaTime > 0) {
    if (deltaTime > (long)realm.getMaxDeltaTimeSeconds() * 1000L) {
      user.clearFailures();
    }
  }
  user.incrementFailures();
  int waitSeconds=realm.getWaitIncrementSeconds() * (user.getNumFailures() / realm.getFailureFactor());
  if (waitSeconds == 0) {
    if (deltaTime > realm.getQuickLoginCheckMilliSeconds()) {
      waitSeconds=realm.getMinimumQuickLoginWaitSeconds();
    }
  }
  waitSeconds=Math.min(realm.getMaxFailureWaitSeconds(),waitSeconds);
  if (waitSeconds > 0) {
    user.setFailedLoginNotBefore((int)(currentTime / 1000) + waitSeconds);
  }
}
