{
  List<EventListenerProvider> listeners=new LinkedList<EventListenerProvider>();
  if (realm.isEventsEnabled()) {
    EventStoreProvider eventStore=session.getProvider(EventStoreProvider.class);
    if (eventStore != null) {
      listeners.add(eventStore);
    }
 else {
      log.error("Events enabled, but no event store provider configured");
    }
  }
  if (realm.getEventsListeners() != null) {
    for (    String id : realm.getEventsListeners()) {
      EventListenerProvider listener=session.getProvider(EventListenerProvider.class,id);
      if (listener != null) {
        listeners.add(listener);
      }
 else {
        log.error("Event listener '" + id + "' registered, but provider not found");
      }
    }
  }
  Set<EventType> enabledEventTypes=new HashSet<EventType>();
  for (  String type : realm.getEnabledEventTypes()) {
    enabledEventTypes.add(EventType.valueOf(type));
  }
  return new EventBuilder(listeners,enabledEventTypes,realm,clientConnection.getRemoteAddr());
}
