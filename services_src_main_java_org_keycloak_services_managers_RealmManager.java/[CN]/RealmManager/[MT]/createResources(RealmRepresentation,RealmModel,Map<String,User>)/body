{
  for (  ResourceRepresentation resourceRep : rep.getResources()) {
    ResourceModel resource=realm.addResource(resourceRep.getName());
    resource.setManagementUrl(resourceRep.getAdminUrl());
    resource.setSurrogateAuthRequired(resourceRep.isSurrogateAuthRequired());
    resource.updateResource();
    User resourceUser=resource.getResourceUser();
    if (resourceRep.getCredentials() != null) {
      for (      CredentialRepresentation cred : resourceRep.getCredentials()) {
        UserCredentialModel credential=new UserCredentialModel();
        credential.setType(cred.getType());
        credential.setValue(cred.getValue());
        realm.updateCredential(resourceUser,credential);
      }
    }
    userMap.put(resourceUser.getLoginName(),resourceUser);
    if (resourceRep.getRoles() != null) {
      for (      String roleString : resourceRep.getRoles()) {
        SimpleRole role=new SimpleRole(roleString.trim());
        resource.getIdm().add(role);
      }
    }
    if (resourceRep.getRoleMappings() != null) {
      for (      RoleMappingRepresentation mapping : resourceRep.getRoleMappings()) {
        User user=userMap.get(mapping.getUsername());
        for (        String roleString : mapping.getRoles()) {
          Role role=resource.getIdm().getRole(roleString.trim());
          if (role == null) {
            role=new SimpleRole(roleString.trim());
            resource.getIdm().add(role);
          }
          realm.getIdm().grantRole(user,role);
        }
      }
    }
    if (resourceRep.getScopeMappings() != null) {
      for (      ScopeMappingRepresentation mapping : resourceRep.getScopeMappings()) {
        User user=userMap.get(mapping.getUsername());
        for (        String roleString : mapping.getRoles()) {
          Role role=resource.getIdm().getRole(roleString.trim());
          if (role == null) {
            role=new SimpleRole(roleString.trim());
            resource.getIdm().add(role);
          }
          resource.addScope(user,role.getName());
        }
      }
    }
    if (resourceRep.isUseRealmMappings())     realm.addScope(resource.getResourceUser(),"*");
  }
}
