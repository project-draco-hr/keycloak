{
  newRealm.setName(rep.getRealm());
  newRealm.setEnabled(rep.isEnabled());
  newRealm.setTokenLifespan(rep.getTokenLifespan());
  newRealm.setAccessCodeLifespan(rep.getAccessCodeLifespan());
  newRealm.setSslNotRequired(rep.isSslNotRequired());
  newRealm.setCookieLoginAllowed(rep.isCookieLoginAllowed());
  if (rep.getPrivateKey() == null || rep.getPublicKey() == null) {
    generateRealmKeys(newRealm);
  }
 else {
    newRealm.setPrivateKeyPem(rep.getPrivateKey());
    newRealm.setPublicKeyPem(rep.getPublicKey());
  }
  newRealm.updateRealm();
  Map<String,UserModel> userMap=new HashMap<String,UserModel>();
  for (  RequiredCredentialRepresentation requiredCred : rep.getRequiredCredentials()) {
    RequiredCredentialModel credential=new RequiredCredentialModel();
    credential.setType(requiredCred.getType());
    credential.setInput(requiredCred.isInput());
    credential.setSecret(requiredCred.isSecret());
    newRealm.addRequiredCredential(credential);
  }
  for (  UserRepresentation userRep : rep.getUsers()) {
    UserModel user=newRealm.addUser(userRep.getUsername());
    user.setEnabled(userRep.isEnabled());
    if (userRep.getAttributes() != null) {
      for (      Map.Entry<String,String> entry : userRep.getAttributes().entrySet()) {
        user.setAttribute(entry.getKey(),entry.getValue());
      }
    }
    if (userRep.getCredentials() != null) {
      for (      CredentialRepresentation cred : userRep.getCredentials()) {
        UserCredentialModel credential=new UserCredentialModel();
        credential.setType(cred.getType());
        credential.setValue(cred.getValue());
        newRealm.updateCredential(user,credential);
      }
    }
    userMap.put(user.getLoginName(),user);
  }
  if (rep.getRoles() != null) {
    for (    RoleRepresentation roleRep : rep.getRoles()) {
      RoleModel role=newRealm.addRole(roleRep.getName());
      if (roleRep.getDescription() != null)       role.setDescription(roleRep.getDescription());
    }
  }
  if (rep.getResources() != null) {
    createResources(rep,newRealm,userMap);
  }
  if (rep.getRoleMappings() != null) {
    for (    RoleMappingRepresentation mapping : rep.getRoleMappings()) {
      UserModel user=userMap.get(mapping.getUsername());
      for (      String roleString : mapping.getRoles()) {
        RoleModel role=newRealm.getRole(roleString.trim());
        if (role == null) {
          role=newRealm.addRole(roleString.trim());
        }
        newRealm.grantRole(user,role);
      }
    }
  }
  if (rep.getScopeMappings() != null) {
    for (    ScopeMappingRepresentation scope : rep.getScopeMappings()) {
      for (      String roleString : scope.getRoles()) {
        RoleModel role=newRealm.getRole(roleString.trim());
        if (role == null) {
          role=newRealm.addRole(roleString.trim());
        }
        UserModel user=userMap.get(scope.getUsername());
        newRealm.addScope(user,role.getName());
      }
    }
  }
}
