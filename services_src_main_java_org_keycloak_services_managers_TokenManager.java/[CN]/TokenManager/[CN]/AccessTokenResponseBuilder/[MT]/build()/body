{
  AccessTokenResponse res=new AccessTokenResponse();
  if (idToken != null) {
    String encodedToken=new JWSBuilder().jsonContent(idToken).rsa256(realm.getPrivateKey());
    res.setIdToken(encodedToken);
  }
  if (accessToken != null) {
    String encodedToken=new JWSBuilder().jsonContent(accessToken).rsa256(realm.getPrivateKey());
    res.setToken(encodedToken);
    res.setTokenType("bearer");
    if (accessToken.getExpiration() != 0) {
      res.setExpiresIn(accessToken.getExpiration() - Time.currentTime());
    }
  }
  if (refreshToken != null) {
    String encodedToken=new JWSBuilder().jsonContent(refreshToken).rsa256(realm.getPrivateKey());
    res.setRefreshToken(encodedToken);
  }
  int notBefore=realm.getNotBefore();
  if (client.getNotBefore() > notBefore)   notBefore=client.getNotBefore();
  res.setNotBeforePolicy(notBefore);
  return res;
}
