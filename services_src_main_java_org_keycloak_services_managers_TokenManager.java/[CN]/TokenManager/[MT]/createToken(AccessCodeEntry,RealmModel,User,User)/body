{
  SkeletonKeyToken token=initToken(realm,client,user);
  if (accessCodeEntry.getRealmRolesRequested().size() > 0) {
    SkeletonKeyToken.Access access=new SkeletonKeyToken.Access();
    for (    Role role : accessCodeEntry.getRealmRolesRequested()) {
      access.addRole(role.getName());
    }
    token.setRealmAccess(access);
  }
  if (accessCodeEntry.getResourceRolesRequested().size() > 0) {
    Map<String,ResourceModel> resourceMap=realm.getResourceMap();
    for (    String resourceName : accessCodeEntry.getResourceRolesRequested().keySet()) {
      ResourceModel resource=resourceMap.get(resourceName);
      SkeletonKeyToken.Access access=token.addAccess(resourceName).verifyCaller(resource.isSurrogateAuthRequired());
      for (      Role role : accessCodeEntry.getResourceRolesRequested().get(resourceName)) {
        access.addRole(role.getName());
      }
    }
  }
  accessCodeEntry.setToken(token);
}
