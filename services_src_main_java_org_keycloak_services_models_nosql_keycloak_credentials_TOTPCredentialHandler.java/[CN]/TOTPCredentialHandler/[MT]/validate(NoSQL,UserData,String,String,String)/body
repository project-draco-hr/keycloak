{
  Credentials.Status status=super.validate(noSQL,user,passwordToValidate);
  if (Credentials.Status.VALID != status) {
    return status;
  }
  device=getDevice(device);
  user=noSQL.loadObject(UserData.class,user.getId());
  if (user != null) {
    if (user.isEnabled()) {
      NoSQLQuery query=noSQL.createQueryBuilder().andCondition("userId",user.getId()).andCondition("device",device).build();
      OTPData otpData=noSQL.loadSingleObject(OTPData.class,query);
      if (otpData != null) {
        if (!PasswordCredentialHandler.isCredentialExpired(otpData.getExpiryDate())) {
          boolean isValid=this.totp.validate(token,otpData.getSecretKey().getBytes());
          if (!isValid) {
            status=Credentials.Status.INVALID;
          }
        }
 else {
          status=Credentials.Status.EXPIRED;
        }
      }
 else {
        status=Credentials.Status.UNVALIDATED;
      }
    }
 else {
      status=Credentials.Status.ACCOUNT_DISABLED;
    }
  }
 else {
    status=Credentials.Status.INVALID;
  }
  return status;
}
