{
  if (uriInfo.getQueryParameters().containsKey("key")) {
    AccessCodeEntry accessCode=tokenManager.getAccessCode(uriInfo.getQueryParameters().getFirst("key"));
    if (accessCode == null || accessCode.isExpired() || !accessCode.getRequiredActions().contains(RequiredAction.VERIFY_EMAIL)) {
      return Response.status(Status.FORBIDDEN).build();
    }
    String loginName=accessCode.getUser().getLoginName();
    UserModel user=realm.getUser(loginName);
    user.setEmailVerified(true);
    user.removeRequiredAction(RequiredAction.VERIFY_EMAIL);
    accessCode.getRequiredActions().remove(RequiredAction.VERIFY_EMAIL);
    return redirectOauth(user,accessCode);
  }
 else {
    AccessCodeEntry accessCode=getAccessCodeEntry(RequiredAction.VERIFY_EMAIL);
    UserModel user=accessCode != null ? getUserFromAccessCode(accessCode) : null;
    if (user == null) {
      return Response.status(Status.FORBIDDEN).build();
    }
    return Flows.forms(realm,request,uriInfo).setAccessCode(accessCode).setUser(user).forwardToAction(RequiredAction.VERIFY_EMAIL);
  }
}
