{
  try {
    if (error != null) {
      logger.debug("error from oauth");
      throw new ForbiddenException("error");
    }
    if (!realm.isEnabled()) {
      logger.debug("realm not enabled");
      throw new ForbiddenException();
    }
    if (!application.isEnabled()) {
      logger.debug("account management app not enabled");
      throw new ForbiddenException();
    }
    if (code == null) {
      logger.debug("code not specified");
      throw new BadRequestException();
    }
    if (state == null) {
      logger.debug("state not specified");
      throw new BadRequestException();
    }
    URI accountUri=Urls.accountBase(uriInfo.getBaseUri()).path("/").build(realm.getName());
    URI redirectUri=path != null ? accountUri.resolve(path) : accountUri;
    if (referrer != null) {
      redirectUri=redirectUri.resolve("?referrer=" + referrer);
    }
    NewCookie cookie=authManager.createCookie(realm,application,code,Urls.accountBase(uriInfo.getBaseUri()).build(realm.getName()));
    return Response.status(302).cookie(cookie).location(redirectUri).build();
  }
  finally {
    authManager.expireCookie(Urls.accountBase(uriInfo.getBaseUri()).build(realm.getName()));
  }
}
