{
  if (auth == null) {
    return login(null);
  }
  require(AccountRoles.MANAGE_ACCOUNT);
  UserModel user=auth.getUser();
  String error=Validation.validateUpdateProfileForm(formData);
  if (error != null) {
    return account.setError(error).createResponse(AccountPages.ACCOUNT);
  }
  user.setFirstName(formData.getFirst("firstName"));
  user.setLastName(formData.getFirst("lastName"));
  String email=formData.getFirst("email");
  String oldEmail=user.getEmail();
  boolean emailChanged=oldEmail != null ? !oldEmail.equals(email) : email != null;
  user.setEmail(formData.getFirst("email"));
  audit.event(Events.UPDATE_PROFILE).client(auth.getClient()).user(auth.getUser()).success();
  if (emailChanged) {
    user.setEmailVerified(false);
    audit.clone().event(Events.UPDATE_EMAIL).detail(Details.PREVIOUS_EMAIL,oldEmail).detail(Details.UPDATED_EMAIL,email).success();
  }
  return account.setSuccess("accountUpdated").createResponse(AccountPages.ACCOUNT);
}
