{
  if (auth == null) {
    return login("password");
  }
  require(AccountRoles.MANAGE_ACCOUNT);
  String action=formData.getFirst("submitAction");
  if (action != null && action.equals("Cancel")) {
    setReferrerOnPage();
    return account.createResponse(AccountPages.PASSWORD);
  }
  csrfCheck(formData);
  UserModel user=auth.getUser();
  boolean requireCurrent=isPasswordSet(user);
  account.setPasswordSet(requireCurrent);
  String password=formData.getFirst("password");
  String passwordNew=formData.getFirst("password-new");
  String passwordConfirm=formData.getFirst("password-confirm");
  if (requireCurrent) {
    if (Validation.isEmpty(password)) {
      setReferrerOnPage();
      return account.setError(Messages.MISSING_PASSWORD).createResponse(AccountPages.PASSWORD);
    }
    UserCredentialModel cred=UserCredentialModel.password(password);
    if (!session.users().validCredentials(realm,user,cred)) {
      setReferrerOnPage();
      return account.setError(Messages.INVALID_PASSWORD_EXISTING).createResponse(AccountPages.PASSWORD);
    }
  }
  if (Validation.isEmpty(passwordNew)) {
    setReferrerOnPage();
    return account.setError(Messages.MISSING_PASSWORD).createResponse(AccountPages.PASSWORD);
  }
  if (!passwordNew.equals(passwordConfirm)) {
    setReferrerOnPage();
    return account.setError(Messages.INVALID_PASSWORD_CONFIRM).createResponse(AccountPages.PASSWORD);
  }
  try {
    session.users().updateCredential(realm,user,UserCredentialModel.password(passwordNew));
  }
 catch (  ModelReadOnlyException mre) {
    setReferrerOnPage();
    return account.setError(Messages.READ_ONLY_PASSWORD).createResponse(AccountPages.PASSWORD);
  }
catch (  ModelException me) {
    logger.error("Failed to update password",me);
    setReferrerOnPage();
    return account.setError(me.getMessage(),me.getParameters()).createResponse(AccountPages.PASSWORD);
  }
catch (  Exception ape) {
    logger.error("Failed to update password",ape);
    setReferrerOnPage();
    return account.setError(ape.getMessage()).createResponse(AccountPages.PASSWORD);
  }
  List<UserSessionModel> sessions=session.sessions().getUserSessions(realm,user);
  for (  UserSessionModel s : sessions) {
    if (!s.getId().equals(auth.getSession().getId())) {
      AuthenticationManager.backchannelLogout(session,realm,s,uriInfo,clientConnection,headers,true);
    }
  }
  event.event(EventType.UPDATE_PASSWORD).client(auth.getClient()).user(auth.getUser()).success();
  setReferrerOnPage();
  return account.setPasswordSet(true).setSuccess(Messages.ACCOUNT_PASSWORD_UPDATED).createResponse(AccountPages.PASSWORD);
}
