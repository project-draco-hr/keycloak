{
  Auth auth=getAuth(true);
  require(auth,AccountRoles.MANAGE_ACCOUNT);
  UserModel user=auth.getUser();
  String totp=formData.getFirst("totp");
  String totpSecret=formData.getFirst("totpSecret");
  Account account=AccountLoader.load().createAccount(uriInfo).setRealm(realm).setUser(auth.getUser());
  if (Validation.isEmpty(totp)) {
    return account.setError(Messages.MISSING_TOTP).createResponse(AccountPages.TOTP);
  }
 else   if (!new TimeBasedOTP().validate(totp,totpSecret.getBytes())) {
    return account.setError(Messages.INVALID_TOTP).createResponse(AccountPages.TOTP);
  }
  UserCredentialModel credentials=new UserCredentialModel();
  credentials.setType(CredentialRepresentation.TOTP);
  credentials.setValue(totpSecret);
  realm.updateCredential(user,credentials);
  user.setTotp(true);
  return account.setSuccess("successTotp").createResponse(AccountPages.TOTP);
}
