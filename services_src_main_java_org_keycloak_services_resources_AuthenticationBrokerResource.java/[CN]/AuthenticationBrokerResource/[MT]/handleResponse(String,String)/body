{
  RealmManager realmManager=new RealmManager(session);
  RealmModel realm=realmManager.getRealmByName(realmName);
  IdentityProviderModel identityProviderConfig=getIdentityProviderConfig(realm,providerId);
  try {
    IdentityProvider identityProvider=getIdentityProvider(realm,providerId);
    if (identityProvider == null) {
      return Flows.forms(session,realm,null,uriInfo).setError("Social identityProvider not found").createErrorPage();
    }
    String relayState=identityProvider.getRelayState(createAuthenticationRequest(providerId,null,realm,null));
    if (relayState == null) {
      return redirectToErrorPage(realm,"No relay state from identity identityProvider.");
    }
    ClientSessionCode clientCode=isValidAuthorizationCode(relayState,realm);
    if (clientCode == null) {
      return redirectToErrorPage(realm,"Invalid authorization code, please login again through your application.");
    }
    ClientSessionModel clientSession=clientCode.getClientSession();
    ClientModel clientModel=clientSession.getClient();
    Response response=checkClientPermissions(clientModel,providerId);
    if (response != null) {
      return response;
    }
    AuthenticationResponse authenticationResponse=identityProvider.handleResponse(createAuthenticationRequest(providerId,null,realm,clientSession));
    response=authenticationResponse.getResponse();
    if (response != null) {
      return response;
    }
    FederatedIdentity identity=authenticationResponse.getUser();
    if (!identityProviderConfig.isStoreToken()) {
      identity.setToken(null);
    }
    return performLocalAuthentication(realm,providerId,identity,clientCode);
  }
 catch (  Exception e) {
    if (session.getTransaction().isActive()) {
      session.getTransaction().rollback();
    }
    return Flows.forms(session,realm,null,uriInfo).setError("Authentication failed. Could not authenticate against Identity Provider [" + identityProviderConfig.getName() + "].").createErrorPage();
  }
 finally {
    if (session.getTransaction().isActive()) {
      session.getTransaction().commit();
    }
  }
}
