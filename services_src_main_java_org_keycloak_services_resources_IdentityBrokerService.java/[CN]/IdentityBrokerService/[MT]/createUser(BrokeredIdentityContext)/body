{
  FederatedIdentityModel federatedIdentityModel=new FederatedIdentityModel(updatedIdentity.getIdpConfig().getAlias(),updatedIdentity.getId(),updatedIdentity.getUsername(),updatedIdentity.getToken());
  UserModel existingUser=null;
  if (updatedIdentity.getEmail() != null) {
    existingUser=this.session.users().getUserByEmail(updatedIdentity.getEmail(),this.realmModel);
  }
  if (existingUser != null) {
    fireErrorEvent(Errors.FEDERATED_IDENTITY_EMAIL_EXISTS);
    throw new IdentityBrokerException(Messages.FEDERATED_IDENTITY_EMAIL_EXISTS);
  }
  String username=updatedIdentity.getUsername();
  if (this.realmModel.isRegistrationEmailAsUsername() && !Validation.isEmpty(updatedIdentity.getEmail())) {
    username=updatedIdentity.getEmail();
  }
 else   if (username == null) {
    username=updatedIdentity.getIdpConfig().getAlias() + "." + updatedIdentity.getId();
  }
 else {
    username=updatedIdentity.getIdpConfig().getAlias() + "." + updatedIdentity.getUsername();
  }
  if (username != null) {
    username=username.trim();
  }
  existingUser=this.session.users().getUserByUsername(username,this.realmModel);
  if (existingUser != null) {
    fireErrorEvent(Errors.FEDERATED_IDENTITY_USERNAME_EXISTS);
    throw new IdentityBrokerException(Messages.FEDERATED_IDENTITY_USERNAME_EXISTS);
  }
  if (isDebugEnabled()) {
    LOGGER.debugf("Creating account from identity [%s].",federatedIdentityModel);
  }
  UserModel federatedUser=this.session.users().addUser(this.realmModel,username);
  if (isDebugEnabled()) {
    LOGGER.debugf("Account [%s] created.",federatedUser);
  }
  federatedUser.setEnabled(true);
  federatedUser.setEmail(updatedIdentity.getEmail());
  federatedUser.setFirstName(updatedIdentity.getFirstName());
  federatedUser.setLastName(updatedIdentity.getLastName());
  if (updatedIdentity.getIdpConfig().isAddReadTokenRoleOnCreate()) {
    RoleModel readTokenRole=realmModel.getClientByClientId(Constants.BROKER_SERVICE_CLIENT_ID).getRole(READ_TOKEN_ROLE);
    federatedUser.grantRole(readTokenRole);
  }
  this.session.users().addFederatedIdentity(this.realmModel,federatedUser,federatedIdentityModel);
  updatedIdentity.getIdp().importNewUser(session,realmModel,federatedUser,updatedIdentity);
  Set<IdentityProviderMapperModel> mappers=realmModel.getIdentityProviderMappersByAlias(updatedIdentity.getIdpConfig().getAlias());
  if (mappers != null) {
    KeycloakSessionFactory sessionFactory=session.getKeycloakSessionFactory();
    for (    IdentityProviderMapperModel mapper : mappers) {
      IdentityProviderMapper target=(IdentityProviderMapper)sessionFactory.getProviderFactory(IdentityProviderMapper.class,mapper.getIdentityProviderMapper());
      target.importNewUser(session,realmModel,federatedUser,mapper,updatedIdentity);
    }
  }
  this.event.clone().user(federatedUser).event(EventType.REGISTER).detail(Details.IDENTITY_PROVIDER,federatedIdentityModel.getIdentityProvider()).detail(Details.IDENTITY_PROVIDER_USERNAME,updatedIdentity.getUsername()).removeDetail("auth_method").success();
  return federatedUser;
}
