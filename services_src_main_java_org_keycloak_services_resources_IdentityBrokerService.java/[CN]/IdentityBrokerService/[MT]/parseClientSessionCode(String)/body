{
  ClientSessionCode clientCode=ClientSessionCode.parse(code,this.session,this.realmModel);
  if (clientCode != null && clientCode.isValid(AUTHENTICATE.name(),ClientSessionCode.ActionType.LOGIN)) {
    ClientSessionModel clientSession=clientCode.getClientSession();
    if (clientSession != null) {
      ClientModel client=clientSession.getClient();
      if (client == null) {
        throw new IdentityBrokerException("Invalid client");
      }
      logger.debugf("Got authorization code from client [%s].",client.getClientId());
      this.event.client(client);
      this.session.getContext().setClient(client);
      if (clientSession.getUserSession() != null) {
        this.event.session(clientSession.getUserSession());
      }
    }
    if (isDebugEnabled()) {
      logger.debugf("Authorization code is valid.");
    }
    return clientCode;
  }
  throw new IdentityBrokerException("Invalid code, please login again through your client.");
}
