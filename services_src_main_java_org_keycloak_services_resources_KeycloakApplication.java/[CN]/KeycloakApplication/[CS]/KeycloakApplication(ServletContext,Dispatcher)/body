{
  loadConfig();
  this.contextPath=context.getContextPath();
  this.sessionFactory=createSessionFactory();
  dispatcher.getDefaultContextObjects().put(KeycloakApplication.class,this);
  BruteForceProtector protector=new BruteForceProtector(sessionFactory);
  dispatcher.getDefaultContextObjects().put(BruteForceProtector.class,protector);
  ResteasyProviderFactory.pushContext(BruteForceProtector.class,protector);
  ResteasyProviderFactory.pushContext(KeycloakApplication.class,this);
  protector.start();
  context.setAttribute(BruteForceProtector.class.getName(),protector);
  context.setAttribute(KeycloakSessionFactory.class.getName(),this.sessionFactory);
  singletons.add(new ServerVersionResource());
  singletons.add(new RealmsResource());
  singletons.add(new AdminRoot());
  singletons.add(new ModelExceptionMapper());
  classes.add(QRCodeResource.class);
  classes.add(ThemeResource.class);
  classes.add(JsResource.class);
  singletons.add(new ObjectMapperResolver(Boolean.parseBoolean(System.getProperty("keycloak.jsonPrettyPrint","false"))));
  migrateModel();
  sessionFactory.publish(new PostMigrationEvent());
  boolean bootstrapAdminUser=false;
  KeycloakSession session=sessionFactory.create();
  try {
    session.getTransaction().begin();
    ApplianceBootstrap applianceBootstrap=new ApplianceBootstrap(session);
    ExportImportManager exportImportManager=new ExportImportManager(session);
    boolean createMasterRealm=applianceBootstrap.isNewInstall();
    if (exportImportManager.isRunImport() && exportImportManager.isImportMasterIncluded()) {
      createMasterRealm=false;
    }
    if (createMasterRealm) {
      applianceBootstrap.createMasterRealm(contextPath);
    }
    if (exportImportManager.isRunImport()) {
      exportImportManager.runImport();
    }
 else {
      importRealms();
    }
    importAddUser();
    if (exportImportManager.isRunExport()) {
      exportImportManager.runExport();
    }
    bootstrapAdminUser=applianceBootstrap.isNoMasterUser();
    session.getTransaction().commit();
  }
  finally {
    session.close();
  }
  singletons.add(new WelcomeResource(bootstrapAdminUser));
  setupScheduledTasks(sessionFactory);
}
