{
  String configDir=System.getProperty("jboss.server.config.dir");
  if (configDir != null) {
    File addUserFile=new File(configDir + File.separator + "keycloak-add-user.json");
    if (addUserFile.isFile()) {
      log.info("Importing users from '" + addUserFile + "'");
      List<RealmRepresentation> realms;
      try {
        realms=JsonSerialization.readValue(new FileInputStream(addUserFile),new TypeReference<List<RealmRepresentation>>(){
        }
);
      }
 catch (      IOException e) {
        log.errorv("Failed to load 'keycloak-add-user.json': {0}",e.getMessage());
        return;
      }
      for (      RealmRepresentation realmRep : realms) {
        for (        UserRepresentation userRep : realmRep.getUsers()) {
          KeycloakSession session=sessionFactory.create();
          try {
            session.getTransaction().begin();
            RealmModel realm=session.realms().getRealmByName(realmRep.getRealm());
            if (realm == null) {
              log.errorv("Failed to add user ''{0}'' to realm ''{1}'': realm not found",userRep.getUsername(),realmRep.getRealm());
            }
 else {
              UserModel user=session.users().addUser(realm,userRep.getUsername());
              user.setEnabled(userRep.isEnabled());
              RepresentationToModel.createCredentials(userRep,user);
              RepresentationToModel.createRoleMappings(userRep,user,realm);
            }
            session.getTransaction().commit();
            log.infov("Added user ''{0}'' to realm ''{1}''",userRep.getUsername(),realmRep.getRealm());
          }
 catch (          ModelDuplicateException e) {
            log.errorv("Failed to add user ''{0}'' to realm ''{1}'': user with username exists",userRep.getUsername(),realmRep.getRealm());
          }
catch (          Throwable t) {
            session.getTransaction().rollback();
            log.errorv("Failed to add user ''{0}'' to realm ''{1}'': {2}",userRep.getUsername(),realmRep.getRealm(),t.getMessage());
          }
 finally {
            session.close();
          }
        }
      }
      if (!addUserFile.delete()) {
        log.errorv("Failed to delete '{0}'",addUserFile.getAbsolutePath());
      }
    }
  }
}
