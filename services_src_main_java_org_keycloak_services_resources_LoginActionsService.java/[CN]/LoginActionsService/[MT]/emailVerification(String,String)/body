{
  event.event(EventType.VERIFY_EMAIL);
  if (key != null) {
    Checks checks=new Checks();
    if (!checks.verifyCode(key,ClientSessionModel.Action.VERIFY_EMAIL.name())) {
      return checks.response;
    }
    ClientSessionCode accessCode=checks.clientCode;
    ClientSessionModel clientSession=accessCode.getClientSession();
    UserSessionModel userSession=clientSession.getUserSession();
    UserModel user=userSession.getUser();
    initEvent(clientSession);
    user.setEmailVerified(true);
    user.removeRequiredAction(RequiredAction.VERIFY_EMAIL);
    event.event(EventType.VERIFY_EMAIL).detail(Details.EMAIL,user.getEmail()).success();
    String actionCookieValue=getActionCookie();
    if (actionCookieValue == null || !actionCookieValue.equals(userSession.getId())) {
      session.sessions().removeClientSession(realm,clientSession);
      return session.getProvider(LoginFormsProvider.class).setSuccess(Messages.EMAIL_VERIFIED).createInfoPage();
    }
    event=event.clone().removeDetail(Details.EMAIL).event(EventType.LOGIN);
    return AuthenticationManager.nextActionAfterAuthentication(session,userSession,clientSession,clientConnection,request,uriInfo,event);
  }
 else {
    Checks checks=new Checks();
    if (!checks.verifyCode(code,ClientSessionModel.Action.VERIFY_EMAIL.name())) {
      return checks.response;
    }
    ClientSessionCode accessCode=checks.clientCode;
    ClientSessionModel clientSession=accessCode.getClientSession();
    UserSessionModel userSession=clientSession.getUserSession();
    initEvent(clientSession);
    createActionCookie(realm,uriInfo,clientConnection,userSession.getId());
    return session.getProvider(LoginFormsProvider.class).setClientSessionCode(accessCode.getCode()).setUser(userSession.getUser()).createResponse(RequiredAction.VERIFY_EMAIL);
  }
}
