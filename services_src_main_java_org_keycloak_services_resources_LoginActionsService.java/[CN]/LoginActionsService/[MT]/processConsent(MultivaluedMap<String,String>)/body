{
  event.event(EventType.LOGIN).detail(Details.RESPONSE_TYPE,"code");
  if (!checkSsl()) {
    return ErrorPage.error(session,Messages.HTTPS_REQUIRED);
  }
  String code=formData.getFirst("code");
  ClientSessionCode accessCode=ClientSessionCode.parse(code,session,realm);
  if (accessCode == null || !accessCode.isValid(ClientSessionModel.Action.OAUTH_GRANT.name())) {
    event.error(Errors.INVALID_CODE);
    return ErrorPage.error(session,Messages.INVALID_ACCESS_CODE);
  }
  ClientSessionModel clientSession=accessCode.getClientSession();
  event.detail(Details.CODE_ID,clientSession.getId());
  String redirect=clientSession.getRedirectUri();
  UserSessionModel userSession=clientSession.getUserSession();
  UserModel user=userSession.getUser();
  ClientModel client=clientSession.getClient();
  event.client(client).user(user).detail(Details.RESPONSE_TYPE,"code").detail(Details.REDIRECT_URI,redirect);
  event.detail(Details.AUTH_METHOD,userSession.getAuthMethod());
  event.detail(Details.USERNAME,userSession.getLoginUsername());
  if (userSession.isRememberMe()) {
    event.detail(Details.REMEMBER_ME,"true");
  }
  if (!AuthenticationManager.isSessionValid(realm,userSession)) {
    AuthenticationManager.backchannelLogout(session,realm,userSession,uriInfo,clientConnection,headers,true);
    event.error(Errors.INVALID_CODE);
    return ErrorPage.error(session,Messages.SESSION_NOT_ACTIVE);
  }
  event.session(userSession);
  if (formData.containsKey("cancel")) {
    LoginProtocol protocol=session.getProvider(LoginProtocol.class,clientSession.getAuthMethod());
    protocol.setRealm(realm).setHttpHeaders(headers).setUriInfo(uriInfo);
    event.error(Errors.REJECTED_BY_USER);
    return protocol.consentDenied(clientSession);
  }
  UserConsentModel grantedConsent=user.getConsentByClient(client.getId());
  if (grantedConsent == null) {
    grantedConsent=new UserConsentModel(client);
    user.addConsent(grantedConsent);
  }
  for (  RoleModel role : accessCode.getRequestedRoles()) {
    grantedConsent.addGrantedRole(role);
  }
  for (  ProtocolMapperModel protocolMapper : accessCode.getRequestedProtocolMappers()) {
    if (protocolMapper.isConsentRequired() && protocolMapper.getConsentText() != null) {
      grantedConsent.addGrantedProtocolMapper(protocolMapper);
    }
  }
  user.updateConsent(grantedConsent);
  event.detail(Details.CONSENT,Details.CONSENT_VALUE_CONSENT_GRANTED);
  event.success();
  return authManager.redirectAfterSuccessfulFlow(session,realm,userSession,clientSession,request,uriInfo,clientConnection);
}
