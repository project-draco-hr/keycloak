{
  event.event(EventType.UPDATE_PASSWORD);
  Checks checks=new Checks();
  if (!checks.check(code,ClientSessionModel.Action.UPDATE_PASSWORD.name(),ClientSessionModel.Action.RECOVER_PASSWORD.name())) {
    return checks.response;
  }
  ClientSessionCode accessCode=checks.clientCode;
  ClientSessionModel clientSession=accessCode.getClientSession();
  UserSessionModel userSession=clientSession.getUserSession();
  UserModel user=userSession.getUser();
  initEvent(clientSession);
  String passwordNew=formData.getFirst("password-new");
  String passwordConfirm=formData.getFirst("password-confirm");
  LoginFormsProvider loginForms=session.getProvider(LoginFormsProvider.class).setUser(user);
  if (Validation.isBlank(passwordNew)) {
    return loginForms.setError(Messages.MISSING_PASSWORD).setClientSessionCode(accessCode.getCode()).createResponse(RequiredAction.UPDATE_PASSWORD);
  }
 else   if (!passwordNew.equals(passwordConfirm)) {
    return loginForms.setError(Messages.NOTMATCH_PASSWORD).setClientSessionCode(accessCode.getCode()).createResponse(RequiredAction.UPDATE_PASSWORD);
  }
  try {
    session.users().updateCredential(realm,user,UserCredentialModel.password(passwordNew));
  }
 catch (  ModelException me) {
    return loginForms.setError(me.getMessage(),me.getParameters()).setClientSessionCode(accessCode.getCode()).createResponse(RequiredAction.UPDATE_PASSWORD);
  }
catch (  Exception ape) {
    return loginForms.setError(ape.getMessage()).setClientSessionCode(accessCode.getCode()).createResponse(RequiredAction.UPDATE_PASSWORD);
  }
  user.removeRequiredAction(RequiredAction.UPDATE_PASSWORD);
  event.event(EventType.UPDATE_PASSWORD).success();
  if (clientSession.getAction().equals(ClientSessionModel.Action.RECOVER_PASSWORD.name())) {
    String actionCookieValue=getActionCookie();
    if (actionCookieValue == null || !actionCookieValue.equals(userSession.getId())) {
      return session.getProvider(LoginFormsProvider.class).setSuccess(Messages.ACCOUNT_PASSWORD_UPDATED).createInfoPage();
    }
  }
  event=event.clone().event(EventType.LOGIN);
  return AuthenticationManager.nextActionAfterAuthentication(session,userSession,clientSession,clientConnection,request,uriInfo,event);
}
