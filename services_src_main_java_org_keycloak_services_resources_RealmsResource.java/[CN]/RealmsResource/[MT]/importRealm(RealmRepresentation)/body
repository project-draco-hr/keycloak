{
  identitySession.getTransaction().begin();
  RealmModel realm;
  try {
    RealmManager realmManager=new RealmManager(identitySession);
    RealmModel defaultRealm=realmManager.getRealm(Realm.DEFAULT_REALM);
    User realmCreator=new AuthenticationManager().authenticateBearerToken(defaultRealm,headers);
    Role creatorRole=defaultRealm.getRole(RegistrationService.REALM_CREATOR_ROLE);
    if (!defaultRealm.hasRole(realmCreator,creatorRole)) {
      logger.warn("not a realm creator");
      throw new NotAuthorizedException("Bearer");
    }
    realm=realmManager.importRealm(rep,realmCreator);
    identitySession.getTransaction().commit();
  }
 catch (  RuntimeException re) {
    identitySession.getTransaction().rollback();
    throw re;
  }
  UriBuilder builder=uriInfo.getRequestUriBuilder().path(realm.getId());
  return Response.created(builder.build()).entity(RealmSubResource.realmRep(realm,uriInfo)).type(MediaType.APPLICATION_JSON_TYPE).build();
}
