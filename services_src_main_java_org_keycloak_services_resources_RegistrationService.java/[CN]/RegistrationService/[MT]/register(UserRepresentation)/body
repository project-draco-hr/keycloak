{
  return new Transaction(){
    @Override protected Response callImpl(){
      RealmManager realmManager=new RealmManager(session);
      RealmModel defaultRealm=realmManager.defaultRealm();
      if (!defaultRealm.isEnabled()) {
        throw new ForbiddenException();
      }
      if (!defaultRealm.isRegistrationAllowed()) {
        throw new ForbiddenException();
      }
      UserModel user=defaultRealm.getUser(newUser.getUsername());
      if (user != null) {
        return Response.status(400).type("text/plain").entity("user exists").build();
      }
      user=defaultRealm.addUser(newUser.getUsername());
      for (      CredentialRepresentation cred : newUser.getCredentials()) {
        UserCredentialModel credModel=new UserCredentialModel();
        credModel.setType(cred.getType());
        credModel.setValue(cred.getValue());
        defaultRealm.updateCredential(user,credModel);
      }
      RoleModel realmCreator=defaultRealm.getRole(REALM_CREATOR_ROLE);
      defaultRealm.grantRole(user,realmCreator);
      URI uri=uriInfo.getBaseUriBuilder().path(RealmsResource.class).path(user.getLoginName()).build();
      return Response.created(uri).build();
    }
  }
.call();
}
