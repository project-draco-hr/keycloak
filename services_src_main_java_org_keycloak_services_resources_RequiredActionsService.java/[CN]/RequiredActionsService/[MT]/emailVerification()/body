{
  if (uriInfo.getQueryParameters().containsKey("key")) {
    AccessCodeEntry accessCode=tokenManager.getAccessCode(uriInfo.getQueryParameters().getFirst("key"));
    if (accessCode == null || accessCode.isExpired() || !accessCode.getRequiredActions().contains(RequiredAction.VERIFY_EMAIL)) {
      return unauthorized();
    }
    UserModel user=getUser(accessCode);
    initAudit(accessCode);
    user.setEmailVerified(true);
    user.removeRequiredAction(RequiredAction.VERIFY_EMAIL);
    accessCode.getRequiredActions().remove(RequiredAction.VERIFY_EMAIL);
    audit.clone().event(Events.VERIFY_EMAIL).detail(Details.EMAIL,accessCode.getUser().getEmail()).success();
    return redirectOauth(user,accessCode);
  }
 else {
    AccessCodeEntry accessCode=getAccessCodeEntry(RequiredAction.VERIFY_EMAIL);
    if (accessCode == null) {
      return unauthorized();
    }
    initAudit(accessCode);
    return Flows.forms(realm,uriInfo).setAccessCode(accessCode.getId(),accessCode.getCode()).setUser(accessCode.getUser()).createResponse(RequiredAction.VERIFY_EMAIL);
  }
}
