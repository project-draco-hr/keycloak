{
  event.event(EventType.SEND_RESET_PASSWORD);
  if (uriInfo.getQueryParameters().containsKey("key")) {
    Checks checks=new Checks();
    if (!checks.check(code,ClientSessionModel.Action.UPDATE_PASSWORD)) {
      return checks.response;
    }
    ClientSessionCode accessCode=checks.clientCode;
    ClientSessionModel clientSession=accessCode.getClientSession();
    UserSessionModel userSession=clientSession.getUserSession();
    UserModel user=userSession.getUser();
    String key=uriInfo.getQueryParameters().getFirst("key");
    String keyNote=clientSession.getNote("key");
    if (key == null || !key.equals(keyNote)) {
      return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Somebody is trying to illegally change your password.");
    }
    return Flows.forms(session,realm,null,uriInfo).setAccessCode(accessCode.getCode()).createResponse(RequiredAction.UPDATE_PASSWORD);
  }
 else {
    return Flows.forms(session,realm,null,uriInfo).setAccessCode(code).createPasswordReset();
  }
}
