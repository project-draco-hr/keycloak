{
  String username=formData.getFirst("username");
  String scopeParam=uriInfo.getQueryParameters().getFirst(OAuth2Constants.SCOPE);
  String state=uriInfo.getQueryParameters().getFirst(OAuth2Constants.STATE);
  String redirect=uriInfo.getQueryParameters().getFirst(OAuth2Constants.REDIRECT_URI);
  String clientId=uriInfo.getQueryParameters().getFirst(OAuth2Constants.CLIENT_ID);
  ClientModel client=realm.findClient(clientId);
  if (client == null) {
    return Flows.oauth(realm,request,uriInfo,authManager,tokenManager).forwardToSecurityFailure("Unknown login requester.");
  }
  if (!client.isEnabled()) {
    return Flows.oauth(realm,request,uriInfo,authManager,tokenManager).forwardToSecurityFailure("Login requester not enabled.");
  }
  UserModel user=realm.getUser(username);
  if (user == null && username.contains("@")) {
    user=realm.getUserByEmail(username);
  }
  if (user == null) {
    logger.warn("Failed to send password reset email: user not found");
  }
 else {
    Set<RequiredAction> requiredActions=new HashSet<RequiredAction>(user.getRequiredActions());
    requiredActions.add(RequiredAction.UPDATE_PASSWORD);
    AccessCodeEntry accessCode=tokenManager.createAccessCode(scopeParam,state,redirect,realm,client,user);
    accessCode.setRequiredActions(requiredActions);
    accessCode.setExpiration(Time.currentTime() + realm.getAccessCodeLifespanUserAction());
    try {
      new EmailSender(realm.getSmtpConfig()).sendPasswordReset(user,realm,accessCode,uriInfo);
    }
 catch (    EmailException e) {
      logger.error("Failed to send password reset email",e);
      return Flows.forms(realm,request,uriInfo).setError("emailSendError").createErrorPage();
    }
  }
  return Flows.forms(realm,request,uriInfo).setSuccess("emailSent").createPasswordReset();
}
