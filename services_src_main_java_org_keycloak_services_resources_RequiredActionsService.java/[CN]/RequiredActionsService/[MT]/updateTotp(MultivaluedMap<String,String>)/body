{
  AccessCodeEntry accessCode=getAccessCodeEntry(RequiredAction.CONFIGURE_TOTP);
  if (accessCode == null) {
    return unauthorized();
  }
  UserModel user=getUser(accessCode);
  initAudit(accessCode);
  String totp=formData.getFirst("totp");
  String totpSecret=formData.getFirst("totpSecret");
  LoginFormsProvider loginForms=Flows.forms(providerSession,realm,uriInfo).setUser(user);
  if (Validation.isEmpty(totp)) {
    return loginForms.setError(Messages.MISSING_TOTP).createResponse(RequiredAction.CONFIGURE_TOTP);
  }
 else   if (!new TimeBasedOTP().validate(totp,totpSecret.getBytes())) {
    return loginForms.setError(Messages.INVALID_TOTP).createResponse(RequiredAction.CONFIGURE_TOTP);
  }
  UserCredentialModel credentials=new UserCredentialModel();
  credentials.setType(CredentialRepresentation.TOTP);
  credentials.setValue(totpSecret);
  user.updateCredential(credentials);
  user.setTotp(true);
  user.removeRequiredAction(RequiredAction.CONFIGURE_TOTP);
  accessCode.getRequiredActions().remove(RequiredAction.CONFIGURE_TOTP);
  audit.clone().event(EventType.UPDATE_TOTP).success();
  return redirectOauth(user,accessCode);
}
