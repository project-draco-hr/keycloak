{
  if (!defaultRealm.isEnabled()) {
    throw new ForbiddenException();
  }
  if (!defaultRealm.isRegistrationAllowed()) {
    throw new ForbiddenException();
  }
  UserModel user=defaultRealm.getUser(newUser.getUsername());
  if (user != null) {
    return null;
  }
  user=defaultRealm.addUser(newUser.getUsername());
  user.setFirstName(newUser.getFirstName());
  user.setLastName(newUser.getLastName());
  user.setEmail(newUser.getEmail());
  for (  CredentialRepresentation cred : newUser.getCredentials()) {
    UserCredentialModel credModel=new UserCredentialModel();
    credModel.setType(cred.getType());
    credModel.setValue(cred.getValue());
    defaultRealm.updateCredential(user,credModel);
  }
  for (  RoleModel role : defaultRealm.getDefaultRoles()) {
    defaultRealm.grantRole(user,role);
  }
  return user;
}
