{
  logger.info("accessRequest <---");
  if (!realm.isEnabled()) {
    throw new NotAuthorizedException("Realm not enabled");
  }
  String code=formData.getFirst("code");
  if (code == null) {
    logger.debug("code not specified");
    Map<String,String> error=new HashMap<String,String>();
    error.put("error","invalid_request");
    error.put("error_description","code not specified");
    return Response.status(Response.Status.BAD_REQUEST).entity(error).type("application/json").build();
  }
  String client_id=formData.getFirst("client_id");
  if (client_id == null) {
    logger.debug("client_id not specified");
    Map<String,String> error=new HashMap<String,String>();
    error.put("error","invalid_request");
    error.put("error_description","client_id not specified");
    return Response.status(Response.Status.BAD_REQUEST).entity(error).type("application/json").build();
  }
  UserModel client=realm.getUser(client_id);
  if (client == null) {
    logger.debug("Could not find user");
    Map<String,String> error=new HashMap<String,String>();
    error.put("error","invalid_client");
    error.put("error_description","Could not find user");
    return Response.status(Response.Status.BAD_REQUEST).entity(error).type("application/json").build();
  }
  if (!client.isEnabled()) {
    logger.debug("user is not enabled");
    Map<String,String> error=new HashMap<String,String>();
    error.put("error","invalid_client");
    error.put("error_description","User is not enabled");
    return Response.status(Response.Status.BAD_REQUEST).entity(error).type("application/json").build();
  }
  boolean authenticated=authManager.authenticateForm(realm,client,formData);
  if (!authenticated) {
    Map<String,String> error=new HashMap<String,String>();
    error.put("error","unauthorized_client");
    return Response.status(Response.Status.BAD_REQUEST).entity(error).type("application/json").build();
  }
  JWSInput input=new JWSInput(code,providers);
  boolean verifiedCode=false;
  try {
    verifiedCode=RSAProvider.verify(input,realm.getPublicKey());
  }
 catch (  Exception ignored) {
    logger.debug("Failed to verify signature",ignored);
  }
  if (!verifiedCode) {
    Map<String,String> res=new HashMap<String,String>();
    res.put("error","invalid_grant");
    res.put("error_description","Unable to verify code signature");
    return Response.status(Response.Status.BAD_REQUEST).type(MediaType.APPLICATION_JSON_TYPE).entity(res).build();
  }
  String key=input.readContent(String.class);
  AccessCodeEntry accessCode=tokenManager.pullAccessCode(key);
  if (accessCode == null) {
    Map<String,String> res=new HashMap<String,String>();
    res.put("error","invalid_grant");
    res.put("error_description","Code not found");
    return Response.status(Response.Status.BAD_REQUEST).type(MediaType.APPLICATION_JSON_TYPE).entity(res).build();
  }
  if (accessCode.isExpired()) {
    Map<String,String> res=new HashMap<String,String>();
    res.put("error","invalid_grant");
    res.put("error_description","Code is expired");
    return Response.status(Response.Status.BAD_REQUEST).type(MediaType.APPLICATION_JSON_TYPE).entity(res).build();
  }
  if (!accessCode.getToken().isActive()) {
    Map<String,String> res=new HashMap<String,String>();
    res.put("error","invalid_grant");
    res.put("error_description","Token expired");
    return Response.status(Response.Status.BAD_REQUEST).type(MediaType.APPLICATION_JSON_TYPE).entity(res).build();
  }
  if (!client.getLoginName().equals(accessCode.getClient().getLoginName())) {
    Map<String,String> res=new HashMap<String,String>();
    res.put("error","invalid_grant");
    res.put("error_description","Auth error");
    return Response.status(Response.Status.BAD_REQUEST).type(MediaType.APPLICATION_JSON_TYPE).entity(res).build();
  }
  logger.info("accessRequest SUCCESS");
  AccessTokenResponse res=accessTokenResponse(realm.getPrivateKey(),accessCode.getToken());
  return Response.ok(res).build();
}
