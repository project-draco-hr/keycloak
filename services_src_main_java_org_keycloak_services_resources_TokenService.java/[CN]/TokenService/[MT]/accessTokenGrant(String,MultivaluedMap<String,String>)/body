{
  String username=form.getFirst(AuthenticationManager.FORM_USERNAME);
  if (username == null) {
    throw new NotAuthorizedException("No user");
  }
  RealmModel realm=adapter.getRealm(realmId);
  if (realm == null) {
    throw new NotFoundException("Realm not found");
  }
  if (!realm.isEnabled()) {
    throw new NotAuthorizedException("Disabled realm");
  }
  User user=realm.getIdm().getUser(username);
  if (user == null) {
    throw new NotAuthorizedException("No user");
  }
  if (!user.isEnabled()) {
    throw new NotAuthorizedException("Disabled user.");
  }
  if (authManager.authenticateForm(realm,user,form)) {
    throw new NotAuthorizedException("Auth failed");
  }
  SkeletonKeyToken token=tokenManager.createAccessToken(realm,user);
  String encoded=tokenManager.encodeToken(realm,token);
  AccessTokenResponse res=accessTokenResponse(token,encoded);
  return Response.ok(res,MediaType.APPLICATION_JSON_TYPE).build();
}
