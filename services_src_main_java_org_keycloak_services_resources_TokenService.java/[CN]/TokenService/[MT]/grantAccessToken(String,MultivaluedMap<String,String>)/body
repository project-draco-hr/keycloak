{
  if (!checkSsl()) {
    throw new NotAcceptableException("HTTPS required");
  }
  UserModel client=authorizeClient(authorizationHeader);
  String username=form.getFirst(AuthenticationManager.FORM_USERNAME);
  if (username == null) {
    throw new NotAuthorizedException("No user");
  }
  if (!realm.isEnabled()) {
    throw new NotAuthorizedException("Disabled realm");
  }
  UserModel user=realm.getUser(username);
  if (user == null) {
    throw new NotAuthorizedException("No user");
  }
  if (!user.isEnabled()) {
    throw new NotAuthorizedException("Disabled user.");
  }
  if (authManager.authenticateForm(realm,user,form) != AuthenticationStatus.SUCCESS) {
    throw new NotAuthorizedException("Auth failed");
  }
  String scope=form.getFirst("scope");
  AccessTokenResponse res=tokenManager.responseBuilder(realm).generateAccessToken(scope,client,user).build();
  return Response.ok(res,MediaType.APPLICATION_JSON_TYPE).build();
}
