{
  return new Transaction(){
    protected Response callImpl(){
      String username=form.getFirst(AuthenticationManager.FORM_USERNAME);
      if (username == null) {
        throw new NotAuthorizedException("No user");
      }
      if (!realm.isEnabled()) {
        throw new NotAuthorizedException("Disabled realm");
      }
      UserModel user=realm.getUser(username);
      if (user == null) {
        throw new NotAuthorizedException("No user");
      }
      if (!user.isEnabled()) {
        throw new NotAuthorizedException("Disabled user.");
      }
      if (!authManager.authenticateForm(realm,user,form)) {
        throw new NotAuthorizedException("FORM");
      }
      tokenManager=new TokenManager();
      SkeletonKeyToken token=authManager.createIdentityToken(realm,username);
      String encoded=tokenManager.encodeToken(realm,token);
      AccessTokenResponse res=accessTokenResponse(token,encoded);
      return Response.ok(res,MediaType.APPLICATION_JSON_TYPE).build();
    }
  }
.call();
}
