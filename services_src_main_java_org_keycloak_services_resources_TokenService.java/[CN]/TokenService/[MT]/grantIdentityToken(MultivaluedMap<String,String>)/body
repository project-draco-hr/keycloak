{
  String username=form.getFirst(AuthenticationManager.FORM_USERNAME);
  if (username == null) {
    throw new NotAuthorizedException("No user");
  }
  if (!realm.isEnabled()) {
    throw new NotAuthorizedException("Disabled realm");
  }
  UserModel user=realm.getUser(username);
  AuthenticationStatus status=authManager.authenticateForm(realm,user,form);
  if (status != AuthenticationStatus.SUCCESS) {
    throw new NotAuthorizedException(status);
  }
  tokenManager=new TokenManager();
  SkeletonKeyToken token=authManager.createIdentityToken(realm,username);
  String encoded=tokenManager.encodeToken(realm,token);
  AccessTokenResponse res=accessTokenResponse(token,encoded);
  return Response.ok(res,MediaType.APPLICATION_JSON_TYPE).build();
}
