{
  return new Transaction(){
    protected Response callImpl(){
      if (!realm.isEnabled()) {
        OAuthUtil.securityFailureForward(request,"Realm not enabled");
        return null;
      }
      UserModel client=realm.getUser(clientId);
      if (client == null) {
        OAuthUtil.securityFailureForward(request,"Unknown login requester.");
        transaction.rollback();
        return null;
      }
      if (!client.isEnabled()) {
        OAuthUtil.securityFailureForward(request,"Login requester not enabled.");
        transaction.rollback();
        session.close();
        return null;
      }
      RoleModel resourceRole=realm.getRole(RealmManager.RESOURCE_ROLE);
      RoleModel identityRequestRole=realm.getRole(RealmManager.IDENTITY_REQUESTER_ROLE);
      boolean isResource=realm.hasRole(client,resourceRole);
      if (!isResource && !realm.hasRole(client,identityRequestRole)) {
        OAuthUtil.securityFailureForward(request,"Login requester not allowed to request login.");
        transaction.rollback();
        session.close();
        return null;
      }
      UserModel user=authManager.authenticateIdentityCookie(realm,uriInfo,headers);
      if (user != null) {
        logger.info(user.getLoginName() + " already logged in.");
        return OAuthUtil.processAccessCode(realm,tokenManager,authManager,request,uriInfo,scopeParam,state,redirect,client,user);
      }
      OAuthUtil.forwardToLoginForm(realm,request,uriInfo,redirect,clientId,scopeParam,state);
      return null;
    }
  }
.call();
}
