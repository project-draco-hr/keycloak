{
  if (!realm.isEnabled()) {
    securityFailureForward("Realm not enabled");
    return null;
  }
  User client=realm.getUser(clientId);
  if (client == null) {
    securityFailureForward("Unknown login requester.");
    return null;
  }
  if (!client.isEnabled()) {
    securityFailureForward("Login requester not enabled.");
    identitySession.close();
    return null;
  }
  Role resourceRole=realm.getRole(RealmManager.RESOURCE_ROLE);
  Role identityRequestRole=realm.getRole(RealmManager.IDENTITY_REQUESTER_ROLE);
  boolean isResource=realm.hasRole(client,resourceRole);
  if (!isResource && !realm.hasRole(client,identityRequestRole)) {
    securityFailureForward("Login requester not allowed to request login.");
    identitySession.close();
    return null;
  }
  User user=authManager.authenticateIdentityCookie(realm,uriInfo,headers);
  if (user != null) {
    logger.info(user.getLoginName() + " already logged in.");
    return processAccessCode(scopeParam,state,redirect,client,user);
  }
  forwardToLoginForm(redirect,clientId,scopeParam,state);
  return null;
}
