{
  logger.info("TokenService.loginPage");
  OAuthFlows oauth=Flows.oauth(realm,request,uriInfo,authManager,tokenManager);
  if (!checkSsl()) {
    return oauth.forwardToSecurityFailure("HTTPS required");
  }
  if (!realm.isEnabled()) {
    logger.warn("Realm not enabled");
    return oauth.forwardToSecurityFailure("Realm not enabled");
  }
  UserModel client=realm.getUser(clientId);
  if (client == null) {
    logger.warn("Unknown login requester: " + clientId);
    return oauth.forwardToSecurityFailure("Unknown login requester.");
  }
  if (!client.isEnabled()) {
    logger.warn("Login requester not enabled.");
    return oauth.forwardToSecurityFailure("Login requester not enabled.");
  }
  redirect=verifyRedirectUri(redirect,client);
  if (redirect == null) {
    return oauth.forwardToSecurityFailure("Invalid redirect_uri.");
  }
  logger.info("Checking roles...");
  RoleModel resourceRole=realm.getRole(Constants.APPLICATION_ROLE);
  RoleModel identityRequestRole=realm.getRole(Constants.IDENTITY_REQUESTER_ROLE);
  boolean isResource=realm.hasRole(client,resourceRole);
  if (!isResource && !realm.hasRole(client,identityRequestRole)) {
    logger.warn("Login requester not allowed to request login.");
    return oauth.forwardToSecurityFailure("Login requester not allowed to request login.");
  }
  logger.info("Checking cookie...");
  UserModel user=authManager.authenticateIdentityCookie(realm,uriInfo,headers);
  if (user != null) {
    logger.debug(user.getLoginName() + " already logged in.");
    return oauth.processAccessCode(scopeParam,state,redirect,client,user);
  }
  if (prompt != null && prompt.equals("none")) {
    return oauth.redirectError(client,"access_denied",state,redirect);
  }
  logger.info("forwardToLogin() now...");
  return Flows.forms(realm,request,uriInfo).forwardToLogin();
}
