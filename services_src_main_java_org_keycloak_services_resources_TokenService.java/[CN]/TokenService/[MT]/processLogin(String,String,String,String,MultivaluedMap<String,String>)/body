{
  return new Transaction(){
    protected Response callImpl(){
      OAuthFlows oauth=Flows.oauth(realm,request,uriInfo,authManager,tokenManager);
      if (!realm.isEnabled()) {
        return oauth.forwardToSecurityFailure("Realm not enabled.");
      }
      UserModel client=realm.getUser(clientId);
      if (client == null) {
        return oauth.forwardToSecurityFailure("Unknown login requester.");
      }
      if (!client.isEnabled()) {
        return oauth.forwardToSecurityFailure("Login requester not enabled.");
      }
      String username=formData.getFirst("username");
      UserModel user=realm.getUser(username);
      if (user == null) {
        logger.error("Incorrect user name.");
        return Flows.forms(realm,request).setError("Invalid username or password").setFormData(formData).forwardToLogin();
      }
      if (!user.isEnabled()) {
        return oauth.forwardToSecurityFailure("Your account is not enabled.");
      }
      boolean authenticated=authManager.authenticateForm(realm,user,formData);
      if (!authenticated) {
        logger.error("Authentication failed");
        return Flows.forms(realm,request).setError("Invalid username or password").setFormData(formData).forwardToLogin();
      }
      return oauth.processAccessCode(scopeParam,state,redirect,client,user);
    }
  }
.call();
}
