{
  event.event(EventType.LOGIN).detail(Details.RESPONSE_TYPE,"code");
  OAuthFlows oauth=Flows.oauth(session,realm,request,uriInfo,clientConnection,authManager,tokenManager);
  if (!checkSsl()) {
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"HTTPS required");
  }
  String code=formData.getFirst(OAuth2Constants.CODE);
  ClientSessionCode accessCode=ClientSessionCode.parse(code,session,realm);
  if (accessCode == null || !accessCode.isValid(ClientSessionModel.Action.OAUTH_GRANT)) {
    event.error(Errors.INVALID_CODE);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Invalid access code.");
  }
  ClientSessionModel clientSession=accessCode.getClientSession();
  event.detail(Details.CODE_ID,clientSession.getId());
  String redirect=clientSession.getRedirectUri();
  event.client(clientSession.getClient()).user(clientSession.getUserSession().getUser()).detail(Details.RESPONSE_TYPE,"code").detail(Details.REDIRECT_URI,redirect);
  UserSessionModel userSession=clientSession.getUserSession();
  if (userSession != null) {
    event.detail(Details.AUTH_METHOD,userSession.getAuthMethod());
    event.detail(Details.USERNAME,userSession.getLoginUsername());
    if (userSession.isRememberMe()) {
      event.detail(Details.REMEMBER_ME,"true");
    }
  }
  if (!AuthenticationManager.isSessionValid(realm,userSession)) {
    AuthenticationManager.logout(session,realm,userSession,uriInfo,clientConnection);
    event.error(Errors.INVALID_CODE);
    return Flows.forwardToSecurityFailurePage(session,realm,uriInfo,"Session not active");
  }
  event.session(userSession);
  if (formData.containsKey("cancel")) {
    event.error(Errors.REJECTED_BY_USER);
    return redirectAccessDenied(redirect,clientSession.getNote(OpenIdConnectProtocol.STATE_PARAM));
  }
  event.success();
  accessCode.setAction(ClientSessionModel.Action.CODE_TO_TOKEN);
  return oauth.redirectAccessCode(accessCode,userSession,clientSession.getNote(OpenIdConnectProtocol.STATE_PARAM),redirect);
}
