{
  OAuthFlows oauth=Flows.oauth(realm,request,uriInfo,authManager,tokenManager);
  if (!realm.isEnabled()) {
    return oauth.forwardToSecurityFailure("Realm not enabled");
  }
  UserModel client=realm.getUser(clientId);
  if (client == null) {
    return oauth.forwardToSecurityFailure("Unknown login requester.");
  }
  if (!client.isEnabled()) {
    return oauth.forwardToSecurityFailure("Login requester not enabled.");
  }
  if (!realm.isRegistrationAllowed()) {
    return oauth.forwardToSecurityFailure("Registration not allowed");
  }
  List<String> requiredCredentialTypes=new LinkedList<String>();
  for (  RequiredCredentialModel m : realm.getRequiredCredentials()) {
    requiredCredentialTypes.add(m.getType());
  }
  String error=Validation.validateRegistrationForm(formData,requiredCredentialTypes);
  if (error != null) {
    return Flows.forms(realm,request,uriInfo).setError(error).setFormData(formData).setSocialRegistration(isSocialRegistration).forwardToRegistration();
  }
  String username=formData.getFirst("username");
  UserModel user=realm.getUser(username);
  if (user != null) {
    return Flows.forms(realm,request,uriInfo).setError(Messages.USERNAME_EXISTS).setFormData(formData).setSocialRegistration(isSocialRegistration).forwardToRegistration();
  }
  user=realm.addUser(username);
  String fullname=formData.getFirst("name");
  if (fullname != null) {
    StringTokenizer tokenizer=new StringTokenizer(fullname," ");
    StringBuffer first=null;
    String last="";
    while (tokenizer.hasMoreTokens()) {
      String token=tokenizer.nextToken();
      if (tokenizer.hasMoreTokens()) {
        if (first == null) {
          first=new StringBuffer();
        }
 else {
          first.append(" ");
        }
        first.append(token);
      }
 else {
        last=token;
      }
    }
    if (first == null)     first=new StringBuffer();
    user.setFirstName(first.toString());
    user.setLastName(last);
  }
  user.setEmail(formData.getFirst("email"));
  if (requiredCredentialTypes.contains(CredentialRepresentation.PASSWORD)) {
    UserCredentialModel credentials=new UserCredentialModel();
    credentials.setType(CredentialRepresentation.PASSWORD);
    credentials.setValue(formData.getFirst("password"));
    realm.updateCredential(user,credentials);
  }
  for (  RoleModel role : realm.getDefaultRoles()) {
    realm.grantRole(user,role);
  }
  return null;
}
