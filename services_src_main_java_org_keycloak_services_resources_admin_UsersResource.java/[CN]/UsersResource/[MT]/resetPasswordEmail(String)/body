{
  auth.requireManage();
  UserModel user=session.users().getUserByUsername(username,realm);
  if (user == null) {
    throw new NotFoundException("User not found");
  }
  if (user.getEmail() == null) {
    return Flows.errors().error("User email missing",Response.Status.BAD_REQUEST);
  }
  String redirect=Urls.accountBase(uriInfo.getBaseUri()).path("/").build(realm.getName()).toString();
  String clientId=Constants.ACCOUNT_MANAGEMENT_APP;
  ClientModel client=realm.findClient(clientId);
  if (client == null || !client.isEnabled()) {
    return Flows.errors().error("AccountProvider management not enabled",Response.Status.INTERNAL_SERVER_ERROR);
  }
  UserSessionModel userSession=session.sessions().createUserSession(realm,user,username,clientConnection.getRemoteAddr(),"form",false);
  ClientSessionModel clientSession=session.sessions().createClientSession(realm,client);
  clientSession.setAuthMethod(OAuthFlows.LOGIN_PAGE_PROTOCOL);
  clientSession.setRedirectUri(redirect);
  clientSession.setUserSession(userSession);
  ClientSessionCode accessCode=new ClientSessionCode(realm,clientSession);
  accessCode.setRequiredAction(UserModel.RequiredAction.UPDATE_PASSWORD);
  try {
    UriBuilder builder=Urls.loginPasswordResetBuilder(uriInfo.getBaseUri());
    builder.queryParam("code",accessCode.getCode());
    String key=UUID.randomUUID().toString();
    clientSession.setNote("key",key);
    builder.queryParam("key",key);
    String link=builder.build(realm.getName()).toString();
    long expiration=TimeUnit.SECONDS.toMinutes(realm.getAccessCodeLifespanUserAction());
    this.session.getProvider(EmailProvider.class).setRealm(realm).setUser(user).sendPasswordReset(link,expiration);
    return Response.ok().build();
  }
 catch (  EmailException e) {
    logger.error("Failed to send password reset email",e);
    return Flows.errors().error("Failed to send email",Response.Status.INTERNAL_SERVER_ERROR);
  }
}
