{
  ProviderSession providerSession=providerSessionFactory.createSession();
  KeycloakSession keycloakSession=providerSession.getProvider(KeycloakSession.class);
  try {
    keycloakSession.getTransaction().begin();
    task.run(keycloakSession,providerSession);
    keycloakSession.getTransaction().commit();
    logger.debug("Executed scheduled task " + task.getClass().getSimpleName());
  }
 catch (  Throwable t) {
    logger.error("Failed to run scheduled task " + task.getClass().getSimpleName(),t);
    keycloakSession.getTransaction().rollback();
  }
 finally {
    try {
      providerSession.close();
    }
 catch (    Throwable t) {
      logger.error("Failed to close ProviderSession",t);
    }
  }
}
