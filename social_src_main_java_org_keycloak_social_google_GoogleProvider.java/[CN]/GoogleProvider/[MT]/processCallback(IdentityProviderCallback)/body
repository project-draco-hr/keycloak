{
  String code=callback.getQueryParam("code");
  try {
    GoogleTokenResponse tokenResponse=new GoogleAuthorizationCodeTokenRequest(TRANSPORT,JSON_FACTORY,callback.getProviderKey(),callback.getProviderSecret(),code,callback.getProviderCallbackUrl().toString()).execute();
    GoogleCredential credential=new GoogleCredential.Builder().setJsonFactory(JSON_FACTORY).setTransport(TRANSPORT).setClientSecrets(callback.getProviderKey(),callback.getProviderSecret()).build().setFromTokenResponse(tokenResponse);
    Oauth2 oauth2=new Oauth2.Builder(TRANSPORT,JSON_FACTORY,credential).build();
    Tokeninfo tokenInfo=oauth2.tokeninfo().setAccessToken(credential.getAccessToken()).execute();
    if (tokenInfo.containsKey("error")) {
      throw new RuntimeException("error");
    }
    Userinfo userInfo=oauth2.userinfo().get().execute();
    User user=new SimpleUser(userInfo.getEmail());
    user.setFirstName(userInfo.getGivenName());
    user.setLastName(userInfo.getFamilyName());
    user.setEmail(userInfo.getEmail());
    return user;
  }
 catch (  Exception e) {
    throw new IdentityProviderException(e);
  }
}
