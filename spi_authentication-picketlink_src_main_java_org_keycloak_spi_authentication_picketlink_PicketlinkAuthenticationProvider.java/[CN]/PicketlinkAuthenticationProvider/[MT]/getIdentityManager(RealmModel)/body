{
  IdentityManager identityManager=ResteasyProviderFactory.getContextData(IdentityManager.class);
  if (identityManager == null) {
    Iterable<PartitionManagerProvider> providers=ProviderLoader.load(PartitionManagerProvider.class);
    PartitionManager partitionManager=null;
    for (    PartitionManagerProvider provider : providers) {
      partitionManager=provider.getPartitionManager(realm);
      if (partitionManager != null) {
        break;
      }
    }
    if (partitionManager == null) {
      throw new AuthenticationProviderException("Not able to locate PartitionManager with any PartitionManagerProvider");
    }
    identityManager=partitionManager.createIdentityManager();
    ResteasyProviderFactory.pushContext(IdentityManager.class,identityManager);
  }
  return identityManager;
}
