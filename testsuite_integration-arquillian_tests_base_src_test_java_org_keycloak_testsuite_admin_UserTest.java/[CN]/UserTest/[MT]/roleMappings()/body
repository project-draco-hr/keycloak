{
  RealmResource realm=adminClient.realms().realm("test");
  RealmRepresentation realmRep=RealmBuilder.edit(realm.toRepresentation()).testEventListener().build();
  realm.update(realmRep);
  realm.roles().create(RoleBuilder.create().name("realm-role").build());
  realm.roles().create(RoleBuilder.create().name("realm-composite").build());
  realm.roles().create(RoleBuilder.create().name("realm-child").build());
  realm.roles().get("realm-composite").addComposites(Collections.singletonList(realm.roles().get("realm-child").toRepresentation()));
  Response response=realm.clients().create(ClientBuilder.create().clientId("myclient").build());
  String clientUuid=ApiUtil.getCreatedId(response);
  response.close();
  realm.clients().get(clientUuid).roles().create(RoleBuilder.create().name("client-role").build());
  realm.clients().get(clientUuid).roles().create(RoleBuilder.create().name("client-role2").build());
  realm.clients().get(clientUuid).roles().create(RoleBuilder.create().name("client-composite").build());
  realm.clients().get(clientUuid).roles().create(RoleBuilder.create().name("client-child").build());
  realm.clients().get(clientUuid).roles().get("client-composite").addComposites(Collections.singletonList(realm.clients().get(clientUuid).roles().get("client-child").toRepresentation()));
  response=realm.users().create(UserBuilder.create().username("myuser").build());
  String userId=ApiUtil.getCreatedId(response);
  response.close();
  assertAdminEvents.clear();
  RoleMappingResource roles=realm.users().get(userId).roles();
  assertNames(roles.realmLevel().listAll(),"user","offline_access");
  List<RoleRepresentation> l=new LinkedList<>();
  l.add(realm.roles().get("realm-role").toRepresentation());
  l.add(realm.roles().get("realm-composite").toRepresentation());
  roles.realmLevel().add(l);
  assertAdminEvents.assertEvent("test",OperationType.CREATE,AdminEventPaths.userRealmRoleMappingsPath(userId),l);
  List<RoleRepresentation> list=Collections.singletonList(realm.clients().get(clientUuid).roles().get("client-role").toRepresentation());
  roles.clientLevel(clientUuid).add(list);
  assertAdminEvents.assertEvent("test",OperationType.CREATE,AdminEventPaths.userClientRoleMappingsPath(userId,clientUuid),list);
  list=Collections.singletonList(realm.clients().get(clientUuid).roles().get("client-composite").toRepresentation());
  roles.clientLevel(clientUuid).add(list);
  assertAdminEvents.assertEvent("test",OperationType.CREATE,AdminEventPaths.userClientRoleMappingsPath(userId,clientUuid),list);
  assertNames(roles.realmLevel().listAll(),"realm-role","realm-composite","user","offline_access");
  assertNames(roles.realmLevel().listAvailable(),"admin");
  assertNames(roles.realmLevel().listEffective(),"realm-role","realm-composite","realm-child","user","offline_access");
  assertNames(roles.clientLevel(clientUuid).listAll(),"client-role","client-composite");
  assertNames(roles.clientLevel(clientUuid).listAvailable(),"client-role2");
  assertNames(roles.clientLevel(clientUuid).listEffective(),"client-role","client-composite","client-child");
  MappingsRepresentation all=roles.getAll();
  assertNames(all.getRealmMappings(),"realm-role","realm-composite","user","offline_access");
  assertEquals(2,all.getClientMappings().size());
  assertNames(all.getClientMappings().get("myclient").getMappings(),"client-role","client-composite");
  assertNames(all.getClientMappings().get("account").getMappings(),"manage-account","view-profile");
  RoleRepresentation realmRoleRep=realm.roles().get("realm-role").toRepresentation();
  roles.realmLevel().remove(Collections.singletonList(realmRoleRep));
  assertAdminEvents.assertEvent("test",OperationType.DELETE,AdminEventPaths.userRealmRoleMappingsPath(userId),Collections.singletonList(realmRoleRep));
  assertNames(roles.realmLevel().listAll(),"realm-composite","user","offline_access");
  RoleRepresentation clientRoleRep=realm.clients().get(clientUuid).roles().get("client-role").toRepresentation();
  roles.clientLevel(clientUuid).remove(Collections.singletonList(clientRoleRep));
  assertAdminEvents.assertEvent("test",OperationType.DELETE,AdminEventPaths.userClientRoleMappingsPath(userId,clientUuid),Collections.singletonList(clientRoleRep));
  assertNames(roles.clientLevel(clientUuid).listAll(),"client-composite");
}
