{
  String state=null;
  String redirectUri=null;
  List<NameValuePair> query=null;
  try {
    URI uri=URI.create(req.getRequestURL().append('?').append(req.getQueryString()).toString());
    query=URLEncodedUtils.parse(uri,"UTF-8");
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  for (  NameValuePair p : query) {
    if ("state".equals(p.getName())) {
      state=p.getValue();
    }
 else     if ("redirect_uri".equals(p.getName())) {
      redirectUri=p.getValue();
    }
  }
  String redirect;
  if (req.getParameter("login") != null) {
    redirect=redirectUri + "?id=" + req.getParameter("id")+ "&username="+ req.getParameter("username")+ "&state="+ state+ "&code="+ UUID.randomUUID().toString();
    if (req.getParameter("firstname") != null) {
      redirect+="&firstname=" + req.getParameter("firstname");
    }
    if (req.getParameter("lastname") != null) {
      redirect+="&lastname=" + req.getParameter("lastname");
    }
    if (req.getParameter("email") != null) {
      redirect+="&email=" + req.getParameter("email");
    }
  }
 else {
    redirect=redirectUri + "?error=access_denied&state=" + state;
  }
  resp.sendRedirect(redirect);
}
