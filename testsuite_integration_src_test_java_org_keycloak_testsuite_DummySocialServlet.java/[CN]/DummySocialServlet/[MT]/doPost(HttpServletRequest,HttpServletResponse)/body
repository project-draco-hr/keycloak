{
  String accessToken=req.getParameter("username");
  String state=null;
  String redirectUri=null;
  List<NameValuePair> query=null;
  try {
    URI uri=URI.create(req.getRequestURL().append('?').append(req.getQueryString()).toString());
    query=URLEncodedUtils.parse(uri,"UTF-8");
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  for (  NameValuePair p : query) {
    if ("state".equals(p.getName())) {
      state=p.getValue();
    }
 else     if ("redirect_uri".equals(p.getName())) {
      redirectUri=p.getValue();
    }
  }
  String redirect=redirectUri + "?access_token=" + accessToken+ "&token_type=bearer&state="+ state;
  resp.sendRedirect(redirect);
}
