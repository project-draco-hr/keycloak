{
  HttpClient client=new DefaultHttpClient();
  HttpPost post=new HttpPost(getAccessTokenUrl());
  List<NameValuePair> parameters=new LinkedList<NameValuePair>();
  parameters.add(new BasicNameValuePair(OAuth2Constants.GRANT_TYPE,OAuth2Constants.AUTHORIZATION_CODE));
  if (code != null) {
    parameters.add(new BasicNameValuePair(OAuth2Constants.CODE,code));
  }
  if (redirectUri != null) {
    parameters.add(new BasicNameValuePair(OAuth2Constants.REDIRECT_URI,redirectUri));
  }
  if (clientId != null && password != null) {
    String authorization=BasicAuthHelper.createHeader(clientId,password);
    post.setHeader("Authorization",authorization);
  }
 else   if (clientId != null) {
    parameters.add(new BasicNameValuePair(OAuth2Constants.CLIENT_ID,clientId));
  }
  UrlEncodedFormEntity formEntity=null;
  try {
    formEntity=new UrlEncodedFormEntity(parameters,"UTF-8");
  }
 catch (  UnsupportedEncodingException e) {
    throw new RuntimeException(e);
  }
  post.setEntity(formEntity);
  try {
    return new AccessTokenResponse(client.execute(post));
  }
 catch (  Exception e) {
    throw new RuntimeException("Failed to retrieve access token",e);
  }
}
