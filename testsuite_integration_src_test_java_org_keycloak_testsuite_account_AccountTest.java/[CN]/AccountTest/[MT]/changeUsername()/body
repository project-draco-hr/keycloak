{
  keycloakRule.update(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      appRealm.setEditUsernameAllowed(true);
    }
  }
);
  try {
    profilePage.open();
    loginPage.login("test-user@localhost","password");
    events.expectLogin().client("account").detail(Details.REDIRECT_URI,ACCOUNT_REDIRECT).assertEvent();
    Assert.assertEquals("test-user@localhost",profilePage.getUsername());
    Assert.assertEquals("Tom",profilePage.getFirstName());
    Assert.assertEquals("Brady",profilePage.getLastName());
    Assert.assertEquals("test-user@localhost",profilePage.getEmail());
    profilePage.updateProfile("","New first","New last","new@email.com");
    Assert.assertEquals("Please specify username.",profilePage.getError());
    Assert.assertEquals("",profilePage.getUsername());
    Assert.assertEquals("New first",profilePage.getFirstName());
    Assert.assertEquals("New last",profilePage.getLastName());
    Assert.assertEquals("new@email.com",profilePage.getEmail());
    events.assertEmpty();
    profilePage.updateProfile("test-user-new@localhost","New first","New last","new@email.com");
    Assert.assertEquals("Your account has been updated.",profilePage.getSuccess());
    Assert.assertEquals("test-user-new@localhost",profilePage.getUsername());
    Assert.assertEquals("New first",profilePage.getFirstName());
    Assert.assertEquals("New last",profilePage.getLastName());
    Assert.assertEquals("new@email.com",profilePage.getEmail());
  }
  finally {
    profilePage.updateProfile("test-user@localhost","Tom","Brady","test-user@localhost");
    events.clear();
    keycloakRule.update(new KeycloakRule.KeycloakSetup(){
      @Override public void config(      RealmManager manager,      RealmModel adminstrationRealm,      RealmModel appRealm){
        appRealm.setEditUsernameAllowed(false);
      }
    }
);
  }
}
