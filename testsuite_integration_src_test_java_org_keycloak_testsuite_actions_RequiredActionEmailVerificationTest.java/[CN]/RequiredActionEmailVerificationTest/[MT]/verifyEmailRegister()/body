{
  loginPage.open();
  loginPage.clickRegister();
  registerPage.register("firstName","lastName","email","verifyEmail","password","password");
  String userId=events.expectRegister("verifyEmail","email").assertEvent().getUserId();
  Assert.assertTrue(verifyEmailPage.isCurrent());
  Assert.assertEquals(1,greenMail.getReceivedMessages().length);
  MimeMessage message=greenMail.getReceivedMessages()[0];
  String body=(String)message.getContent();
  Pattern p=Pattern.compile("(?s).*(http://[^\\s]*).*");
  Matcher m=p.matcher(body);
  m.matches();
  Event sendEvent=events.expectRequiredAction("send_verify_email").user(userId).detail("username","verifyEmail").detail("email","email").assertEvent();
  String sessionId=sendEvent.getSessionId();
  String mailCodeId=sendEvent.getDetails().get(Details.CODE_ID);
  String verificationUrl=m.group(1);
  driver.navigate().to(verificationUrl.trim());
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectRequiredAction("verify_email").user(userId).session(sessionId).detail("username","verifyEmail").detail("email","email").detail(Details.CODE_ID,mailCodeId).assertEvent();
  events.expectLogin().user(userId).session(sessionId).detail("username","verifyEmail").detail(Details.CODE_ID,mailCodeId).assertEvent();
}
