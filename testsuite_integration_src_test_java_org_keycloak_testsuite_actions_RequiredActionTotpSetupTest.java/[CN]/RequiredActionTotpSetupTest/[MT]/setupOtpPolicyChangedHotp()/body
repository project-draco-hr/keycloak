{
  keycloakRule.update(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      OTPPolicy newPolicy=new OTPPolicy();
      newPolicy.setLookAheadWindow(0);
      newPolicy.setDigits(6);
      newPolicy.setPeriod(30);
      newPolicy.setType(UserCredentialModel.HOTP);
      newPolicy.setAlgorithm(HmacOTP.HMAC_SHA1);
      newPolicy.setInitialCounter(0);
      appRealm.setOTPPolicy(newPolicy);
    }
  }
);
  loginPage.open();
  loginPage.login("test-user@localhost","password");
  totpPage.assertCurrent();
  String totpSecret=totpPage.getTotpSecret();
  HmacOTP otpgen=new HmacOTP(6,HmacOTP.HMAC_SHA1,1);
  totpPage.configure(otpgen.generateHOTP(totpSecret,0));
  String uri=driver.getCurrentUrl();
  String sessionId=events.expectRequiredAction(EventType.UPDATE_TOTP).assertEvent().getSessionId();
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  Event loginEvent=events.expectLogin().session(sessionId).assertEvent();
  oauth.openLogout();
  events.expectLogout(loginEvent.getSessionId()).assertEvent();
  loginPage.open();
  loginPage.login("test-user@localhost","password");
  String token=otpgen.generateHOTP(totpSecret,1);
  loginTotpPage.login(token);
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectLogin().assertEvent();
  oauth.openLogout();
  events.expectLogout(null).session(AssertEvents.isUUID()).assertEvent();
  keycloakRule.update(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      OTPPolicy newPolicy=new OTPPolicy();
      newPolicy.setLookAheadWindow(5);
      newPolicy.setDigits(6);
      newPolicy.setPeriod(30);
      newPolicy.setType(UserCredentialModel.HOTP);
      newPolicy.setAlgorithm(HmacOTP.HMAC_SHA1);
      newPolicy.setInitialCounter(0);
      appRealm.setOTPPolicy(newPolicy);
    }
  }
);
  loginPage.open();
  loginPage.login("test-user@localhost","password");
  token=otpgen.generateHOTP(totpSecret,4);
  loginTotpPage.assertCurrent();
  loginTotpPage.login(token);
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectLogin().assertEvent();
  keycloakRule.update(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      appRealm.setOTPPolicy(originalPolicy);
    }
  }
);
}
