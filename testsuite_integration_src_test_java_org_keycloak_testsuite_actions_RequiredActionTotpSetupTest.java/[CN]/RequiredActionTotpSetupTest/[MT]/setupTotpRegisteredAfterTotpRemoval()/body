{
  loginPage.open();
  loginPage.clickRegister();
  registerPage.register("firstName2","lastName2","email2","setupTotp2","password2","password2");
  String userId=events.expectRegister("setupTotp2","email2").assertEvent().getUserId();
  totpPage.assertCurrent();
  String totpCode=totpPage.getTotpSecret();
  totpPage.configure(totp.generate(totpCode));
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectRequiredAction("update_totp").user(userId).detail(Details.USERNAME,"setupTotp2").assertEvent();
  events.expectLogin().user(userId).detail(Details.USERNAME,"setupTotp2").assertEvent();
  oauth.openLogout();
  events.expectLogout().user(userId).assertEvent();
  loginPage.open();
  loginPage.login("setupTotp2","password2");
  Assert.assertTrue(loginPage.isCurrent());
  Assert.assertFalse(totpPage.isCurrent());
  loginTotpPage.login(totp.generate(totpCode));
  events.expectLogin().user(userId).detail(Details.USERNAME,"setupTotp2").assertEvent();
  accountTotpPage.open();
  accountTotpPage.assertCurrent();
  events.expectLogin().user(userId).detail(Details.AUTH_METHOD,"sso").client("account").detail(Details.REDIRECT_URI,AccountService.loginRedirectUrl(UriBuilder.fromUri("http://localhost:8081/auth")).queryParam("path","totp").build("test").toString()).removeDetail(Details.USERNAME).assertEvent();
  accountTotpPage.removeTotp();
  events.expectAccount("remove_totp").user(userId).assertEvent();
  oauth.openLogout();
  events.expectLogout().user(userId).assertEvent();
  loginPage.open();
  loginPage.login("setupTotp2","password2");
  totpPage.assertCurrent();
  totpPage.configure(totp.generate(totpPage.getTotpSecret()));
  events.expectRequiredAction("update_totp").user(userId).detail(Details.USERNAME,"setupTotp2").assertEvent();
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectLogin().user(userId).detail(Details.USERNAME,"setupTotp2").assertEvent();
}
