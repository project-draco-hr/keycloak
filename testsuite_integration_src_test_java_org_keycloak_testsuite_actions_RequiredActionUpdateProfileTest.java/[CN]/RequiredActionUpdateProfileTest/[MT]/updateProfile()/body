{
  loginPage.open();
  loginPage.login("test-user@localhost","password");
  updateProfilePage.assertCurrent();
  updateProfilePage.update("New first","New last","new@email.com");
  String sessionId=events.expectRequiredAction(EventType.UPDATE_PROFILE).assertEvent().getSessionId();
  events.expectRequiredAction(EventType.UPDATE_EMAIL).session(sessionId).detail(Details.PREVIOUS_EMAIL,"test-user@localhost").detail(Details.UPDATED_EMAIL,"new@email.com").assertEvent();
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectLogin().session(sessionId).assertEvent();
  UserRepresentation user=keycloakRule.getUser("test","test-user@localhost");
  Assert.assertEquals("New first",user.getFirstName());
  Assert.assertEquals("New last",user.getLastName());
  Assert.assertEquals("new@email.com",user.getEmail());
}
