{
  IdentityProviderModel identityProviderModel=getIdentityProviderModel();
  identityProviderModel.setStoreToken(true);
  identityProviderModel.setUpdateProfileFirstLogin(false);
  driver.navigate().to("http://localhost:8081/test-app");
  this.loginPage.clickSocial(getProviderId());
  assertTrue(this.driver.getCurrentUrl().startsWith("http://localhost:8082/auth/"));
  this.loginPage.login("test-user","password");
  doAfterProviderAuthentication();
  changePasswordPage.realm("realm-with-broker");
  changePasswordPage.open();
  changePasswordPage.changePassword("password","password");
  driver.navigate().to("http://localhost:8081/test-app/logout");
  oauth.realm("realm-with-broker");
  oauth.redirectUri("http://localhost:8081/third-party");
  oauth.clientId("third-party");
  oauth.doLoginGrant("test-user@localhost","password");
  grantPage.assertCurrent();
  grantPage.accept();
  assertTrue(oauth.getCurrentQuery().containsKey(OAuth2Constants.CODE));
  ClientModel clientModel=getRealm().getClientByClientId("third-party");
  assertEquals(0,clientModel.getIdentityProviders().size());
  configureRetrieveToken(clientModel,getProviderId(),true);
  AccessTokenResponse accessToken=oauth.doAccessTokenRequest(oauth.getCurrentQuery().get(OAuth2Constants.CODE),"password");
  doTokenRequest(accessToken.getAccessToken());
}
