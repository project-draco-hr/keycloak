{
  KeycloakSession session=keycloakRule.startSession();
  boolean skip=false;
  try {
    RealmModel appRealm=new RealmManager(session).getRealmByName("test");
    LDAPFederationProvider ldapFedProvider=FederationTestUtils.getLdapProvider(session,ldapModel);
    LDAPConfig config=ldapFedProvider.getLdapIdentityStore().getConfig();
    if (config.isActiveDirectory() && config.getUsernameLdapAttribute().equals(LDAPConstants.SAM_ACCOUNT_NAME)) {
      skip=true;
    }
    if (!skip) {
      LDAPObject johnDot=FederationTestUtils.addLDAPUser(ldapFedProvider,appRealm,"john,dot","John","Dot","johndot@email.org",null,"12387");
      ldapFedProvider.getLdapIdentityStore().updatePassword(johnDot,"Password1");
    }
  }
  finally {
    keycloakRule.stopSession(session,false);
  }
  if (!skip) {
    loginSuccessAndLogout("john,dot","Password1");
  }
}
