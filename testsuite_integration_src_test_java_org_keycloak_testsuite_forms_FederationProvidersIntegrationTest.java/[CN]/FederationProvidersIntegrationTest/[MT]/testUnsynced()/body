{
  KeycloakSession session=keycloakRule.startSession();
  RealmModel appRealm=session.realms().getRealmByName("test");
  UserFederationProviderModel model=new UserFederationProviderModel(ldapModel.getId(),ldapModel.getProviderName(),ldapModel.getConfig(),ldapModel.getPriority(),ldapModel.getDisplayName());
  model.getConfig().put(LDAPFederationProvider.EDIT_MODE,UserFederationProvider.EditMode.UNSYNCED.toString());
  appRealm.updateUserFederationProvider(model);
  UserModel user=session.users().getUserByUsername("johnkeycloak",appRealm);
  Assert.assertNotNull(user);
  Assert.assertNotNull(user.getFederationLink());
  Assert.assertEquals(user.getFederationLink(),ldapModel.getId());
  UserCredentialModel cred=UserCredentialModel.password("candy");
  user.updateCredential(cred);
  UserCredentialValueModel userCredentialValueModel=user.getCredentialsDirectly().get(0);
  Assert.assertEquals(UserCredentialModel.PASSWORD,userCredentialValueModel.getType());
  Assert.assertTrue(session.users().validCredentials(appRealm,user,cred));
  session.getTransaction().rollback();
  session.close();
  session=keycloakRule.startSession();
  appRealm=session.realms().getRealmByName("test");
  Assert.assertEquals(UserFederationProvider.EditMode.WRITABLE.toString(),appRealm.getUserFederationProviders().get(0).getConfig().get(LDAPFederationProvider.EDIT_MODE));
  keycloakRule.stopSession(session,false);
}
