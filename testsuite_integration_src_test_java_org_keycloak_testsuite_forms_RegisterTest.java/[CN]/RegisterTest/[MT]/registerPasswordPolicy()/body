{
  keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      appRealm.setPasswordPolicy(new PasswordPolicy("length"));
    }
  }
);
  try {
    loginPage.open();
    loginPage.clickRegister();
    registerPage.assertCurrent();
    registerPage.register("firstName","lastName","registerPasswordPolicyemail","registerPasswordPolicy","pass","pass");
    registerPage.assertCurrent();
    Assert.assertEquals("Invalid password: minimum length 8",registerPage.getError());
    events.expectRegister("registerPasswordPolicy","registerPasswordPolicyemail").user((String)null).error("invalid_registration").assertEvent();
    registerPage.register("firstName","lastName","registerPasswordPolicyemail","registerPasswordPolicy","password","password");
    Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
    String userId=events.expectRegister("registerPasswordPolicy","registerPasswordPolicyemail").assertEvent().getUserId();
    events.expectLogin().user(userId).detail(Details.USERNAME,"registerPasswordPolicy").assertEvent();
  }
  finally {
    keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
      @Override public void config(      RealmManager manager,      RealmModel adminstrationRealm,      RealmModel appRealm){
        appRealm.setPasswordPolicy(new PasswordPolicy(null));
      }
    }
);
  }
}
