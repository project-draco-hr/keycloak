{
  loginPage.open();
  loginPage.resetPassword();
  resetPasswordPage.assertCurrent();
  resetPasswordPage.changePassword(username);
  resetPasswordPage.assertCurrent();
  events.expectRequiredAction("send_reset_password").user(userId).detail(Details.USERNAME,username).detail(Details.EMAIL,"login@test.com").assertEvent();
  Assert.assertEquals("You should receive an email shortly with further instructions.",resetPasswordPage.getSuccessMessage());
  Assert.assertEquals(1,greenMail.getReceivedMessages().length);
  MimeMessage message=greenMail.getReceivedMessages()[0];
  String body=(String)message.getContent();
  String changePasswordUrl=body.split("\n")[3];
  driver.navigate().to(changePasswordUrl.trim());
  updatePasswordPage.assertCurrent();
  updatePasswordPage.changePassword("resetPassword","resetPassword");
  events.expectRequiredAction("update_password").user(userId).detail(Details.USERNAME,username).assertEvent();
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
  events.expectLogin().user(userId).detail(Details.USERNAME,username).assertEvent();
  oauth.openLogout();
  events.expectLogout().user(userId).assertEvent();
  loginPage.open();
  loginPage.login("login-test","resetPassword");
  events.expectLogin().user(userId).detail(Details.USERNAME,"login-test").assertEvent();
  Assert.assertEquals(RequestType.AUTH_RESPONSE,appPage.getRequestType());
}
