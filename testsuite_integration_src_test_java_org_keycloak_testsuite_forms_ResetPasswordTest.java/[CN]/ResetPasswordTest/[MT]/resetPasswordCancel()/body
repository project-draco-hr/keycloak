{
  loginPage.open();
  loginPage.resetPassword();
  resetPasswordPage.assertCurrent();
  resetPasswordPage.changePassword("login-test");
  validateResetPage.assertCurrent();
  events.expectRequiredAction(EventType.SEND_RESET_PASSWORD).session((String)null).user(userId).detail(Details.USERNAME,"login-test").detail(Details.EMAIL,"login@test.com").assertEvent().getSessionId();
  validateResetPage.cancel();
  assertTrue(loginPage.isCurrent());
  loginPage.login("login-test","password");
  String currentUrl=driver.getCurrentUrl();
  String src=driver.getPageSource();
  System.out.println("currentUrl: " + currentUrl);
  events.expectLogin().user(userId).detail(Details.USERNAME,"login-test").assertEvent();
  assertEquals(1,greenMail.getReceivedMessages().length);
  MimeMessage message=greenMail.getReceivedMessages()[0];
  final String changePasswordUrl=getPasswordResetEmailLink(message);
  driver.navigate().to(changePasswordUrl.trim());
  events.expect(EventType.RESET_PASSWORD_ERROR).client((String)null).user((String)null).error("invalid_code").clearDetails().assertEvent();
  assertTrue(errorPage.isCurrent());
  assertEquals("An error occurred, please login again through your application.",errorPage.getError());
}
