{
  loginPage.open();
  loginPage.resetPassword();
  resetPasswordPage.assertCurrent();
  resetPasswordPage.changePassword("test-user@localhost");
  resetPasswordPage.assertCurrent();
  events.expectRequiredAction(EventType.SEND_RESET_PASSWORD).detail(Details.USERNAME,"test-user@localhost").detail(Details.EMAIL,"test-user@localhost").assertEvent().getSessionId();
  resetPasswordPage.backToLogin();
  assertTrue(loginPage.isCurrent());
  loginPage.login("login@test.com","password");
  Event loginEvent=events.expectLogin().user(userId).detail(Details.USERNAME,"login-test").assertEvent();
  String code=oauth.getCurrentQuery().get("code");
  OAuthClient.AccessTokenResponse tokenResponse=oauth.doAccessTokenRequest(code,"password");
  assertEquals(200,tokenResponse.getStatusCode());
  assertEquals(userId,oauth.verifyToken(tokenResponse.getAccessToken()).getSubject());
  events.expectCodeToToken(loginEvent.getDetails().get(Details.CODE_ID),loginEvent.getSessionId()).user(userId).assertEvent();
}
