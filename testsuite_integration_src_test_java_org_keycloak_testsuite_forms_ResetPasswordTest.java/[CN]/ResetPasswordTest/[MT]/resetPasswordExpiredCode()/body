{
  try {
    loginPage.open();
    loginPage.resetPassword();
    resetPasswordPage.assertCurrent();
    resetPasswordPage.changePassword("login-test");
    resetPasswordPage.assertCurrent();
    String sessionId=events.expectRequiredAction(EventType.SEND_RESET_PASSWORD).user(userId).detail(Details.USERNAME,"login-test").detail(Details.EMAIL,"login@test.com").assertEvent().getSessionId();
    assertEquals("You should receive an email shortly with further instructions.",resetPasswordPage.getSuccessMessage());
    assertEquals(1,greenMail.getReceivedMessages().length);
    MimeMessage message=greenMail.getReceivedMessages()[0];
    String body=(String)message.getContent();
    String changePasswordUrl=MailUtil.getLink(body);
    Time.setOffset(350);
    driver.navigate().to(changePasswordUrl.trim());
    errorPage.assertCurrent();
    assertEquals("An error occurred, please login again through your application.",errorPage.getError());
    events.expectRequiredAction(EventType.RESET_PASSWORD).error("invalid_code").client((String)null).user((String)null).session((String)null).clearDetails().assertEvent();
  }
  finally {
    Time.setOffset(0);
  }
}
