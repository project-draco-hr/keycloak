{
  String username="login-test";
  loginPage.open();
  loginPage.resetPassword();
  resetPasswordPage.assertCurrent();
  resetPasswordPage.changePassword(username);
  resetPasswordPage.assertCurrent();
  String sessionId=events.expectRequiredAction(EventType.SEND_RESET_PASSWORD).user(userId).detail(Details.USERNAME,username).detail(Details.EMAIL,"login@test.com").assertEvent().getSessionId();
  assertEquals("You should receive an email shortly with further instructions.",resetPasswordPage.getSuccessMessage());
  assertEquals(1,greenMail.getReceivedMessages().length);
  MimeMessage message=greenMail.getReceivedMessages()[0];
  String body=(String)message.getContent();
  String changePasswordUrl=MailUtil.getLink(body);
  driver.manage().deleteAllCookies();
  driver.navigate().to(changePasswordUrl.trim());
  updatePasswordPage.assertCurrent();
  updatePasswordPage.changePassword("resetPassword","resetPassword");
  events.expectRequiredAction(EventType.UPDATE_PASSWORD).user(userId).session(sessionId).detail(Details.USERNAME,username).assertEvent();
  assertTrue(infoPage.isCurrent());
  assertEquals("Your password has been updated",infoPage.getInfo());
  loginPage.open();
  assertTrue(loginPage.isCurrent());
}
