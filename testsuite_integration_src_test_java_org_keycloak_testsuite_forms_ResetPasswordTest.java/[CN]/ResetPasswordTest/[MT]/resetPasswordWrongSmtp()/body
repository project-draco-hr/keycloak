{
  final String[] host=new String[1];
  keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      Map<String,String> smtpConfig=new HashMap<>();
      smtpConfig.putAll(appRealm.getSmtpConfig());
      host[0]=smtpConfig.get("host");
      smtpConfig.put("host","invalid_host");
      appRealm.setSmtpConfig(smtpConfig);
    }
  }
);
  try {
    loginPage.open();
    loginPage.resetPassword();
    resetPasswordPage.assertCurrent();
    resetPasswordPage.changePassword("login-test");
    errorPage.assertCurrent();
    assertEquals("Failed to send email, please try again later.",errorPage.getError());
    assertEquals(0,greenMail.getReceivedMessages().length);
    events.expectRequiredAction(EventType.SEND_RESET_PASSWORD_ERROR).user(userId).session((String)null).detail(Details.USERNAME,"login-test").removeDetail(Details.CODE_ID).error(Errors.EMAIL_SEND_FAILED).assertEvent();
  }
  finally {
    keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
      @Override public void config(      RealmManager manager,      RealmModel adminstrationRealm,      RealmModel appRealm){
        Map<String,String> smtpConfig=new HashMap<>();
        smtpConfig.putAll(appRealm.getSmtpConfig());
        smtpConfig.put("host",host[0]);
        appRealm.setSmtpConfig(smtpConfig);
      }
    }
);
  }
}
