{
  keycloakRule.update(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      ClientModel app=appRealm.getClientByClientId("test-app");
      app.addProtocolMapper(GroupMembershipMapper.create("groups","groups",false,null,true,true));
      app.addProtocolMapper(UserAttributeMapper.createClaimMapper("topAttribute","topAttribute","topAttribute",ProviderConfigProperty.STRING_TYPE,false,null,true,true,false));
      app.addProtocolMapper(UserAttributeMapper.createClaimMapper("level2Attribute","level2Attribute","level2Attribute",ProviderConfigProperty.STRING_TYPE,false,null,true,true,false));
    }
  }
,"test");
  RealmResource realm=keycloak.realms().realm("test");
{
    UserRepresentation user=realm.users().search("topGroupUser",-1,-1).get(0);
    AccessToken token=login(user.getUsername(),"test-app","password",user.getId());
    Assert.assertTrue(token.getRealmAccess().getRoles().contains("user"));
    List<String> groups=(List<String>)token.getOtherClaims().get("groups");
    Assert.assertNotNull(groups);
    Assert.assertTrue(groups.size() == 1);
    Assert.assertEquals("topGroup",groups.get(0));
    Assert.assertEquals("true",token.getOtherClaims().get("topAttribute"));
  }
{
    UserRepresentation user=realm.users().search("level2GroupUser",-1,-1).get(0);
    AccessToken token=login(user.getUsername(),"test-app","password",user.getId());
    Assert.assertTrue(token.getRealmAccess().getRoles().contains("user"));
    Assert.assertTrue(token.getRealmAccess().getRoles().contains("admin"));
    Assert.assertTrue(token.getResourceAccess("test-app").getRoles().contains("customer-user"));
    List<String> groups=(List<String>)token.getOtherClaims().get("groups");
    Assert.assertNotNull(groups);
    Assert.assertTrue(groups.size() == 1);
    Assert.assertEquals("level2group",groups.get(0));
    Assert.assertEquals("true",token.getOtherClaims().get("topAttribute"));
    Assert.assertEquals("true",token.getOtherClaims().get("level2Attribute"));
  }
}
