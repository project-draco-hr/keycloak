{
  keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
    @Override public void config(    RealmManager manager,    RealmModel adminstrationRealm,    RealmModel appRealm){
      ClientModel client=new ClientManager(manager).createClient(appRealm,"sample-public-client");
      client.addRedirectUri("http://localhost:8081/app/auth");
      client.setEnabled(true);
      client.setPublicClient(true);
    }
  }
);
  oauth.clientId("sample-public-client");
  oauth.doLogin("test-user@localhost","password");
  Event loginEvent=events.expectLogin().client("sample-public-client").assertEvent();
  String sessionId=loginEvent.getSessionId();
  String codeId=loginEvent.getDetails().get(Details.CODE_ID);
  String code=oauth.getCurrentQuery().get(OAuth2Constants.CODE);
  CloseableHttpClient client=new DefaultHttpClient();
  try {
    HttpPost post=new HttpPost(oauth.getAccessTokenUrl());
    List<NameValuePair> parameters=new LinkedList<NameValuePair>();
    parameters.add(new BasicNameValuePair(OAuth2Constants.GRANT_TYPE,OAuth2Constants.AUTHORIZATION_CODE));
    parameters.add(new BasicNameValuePair(OAuth2Constants.CODE,code));
    parameters.add(new BasicNameValuePair(OAuth2Constants.REDIRECT_URI,oauth.getRedirectUri()));
    parameters.add(new BasicNameValuePair(OAuth2Constants.CLIENT_ID,oauth.getClientId()));
    post.setHeader("Authorization","Negotiate something-which-will-be-ignored");
    UrlEncodedFormEntity formEntity=null;
    formEntity=new UrlEncodedFormEntity(parameters,"UTF-8");
    post.setEntity(formEntity);
    AccessTokenResponse response=new AccessTokenResponse(client.execute(post));
    Assert.assertEquals(200,response.getStatusCode());
    AccessToken token=oauth.verifyToken(response.getAccessToken());
    events.expectCodeToToken(codeId,sessionId).client("sample-public-client").assertEvent();
  }
  finally {
    oauth.closeClient(client);
  }
}
