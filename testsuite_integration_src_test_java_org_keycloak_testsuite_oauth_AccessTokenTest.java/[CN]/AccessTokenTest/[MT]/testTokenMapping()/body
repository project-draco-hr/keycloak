{
  Client client=ClientBuilder.newClient();
  UriBuilder builder=UriBuilder.fromUri(org.keycloak.testsuite.Constants.AUTH_SERVER_ROOT);
  URI grantUri=OIDCLoginProtocolService.grantAccessTokenUrl(builder).build("test");
  WebTarget grantTarget=client.target(grantUri);
{
    KeycloakSession session=keycloakRule.startSession();
    RealmModel realm=session.realms().getRealmByName("test");
    UserModel user=session.users().getUserByUsername("test-user@localhost",realm);
    user.setAttribute("street","5 Yawkey Way");
    user.setAttribute("locality","Boston");
    user.setAttribute("region","MA");
    user.setAttribute("postal_code","02115");
    user.setAttribute("country","USA");
    user.setAttribute("phone","617-777-6666");
    ApplicationModel app=realm.getApplicationByName("test-app");
    ProtocolMapperModel mapper=OIDCAddressMapper.createAddressMapper(true,true);
    app.addProtocolMapper(mapper);
    app.addProtocolMapper(OIDCUserAttributeMapper.createClaimMapper("custom phone","phone","home_phone","String",true,"",true,true));
    session.getTransaction().commit();
    session.close();
  }
{
    Response response=executeGrantAccessTokenRequest(grantTarget);
    Assert.assertEquals(200,response.getStatus());
    org.keycloak.representations.AccessTokenResponse tokenResponse=response.readEntity(org.keycloak.representations.AccessTokenResponse.class);
    IDToken idToken=getIdToken(tokenResponse);
    Assert.assertNotNull(idToken.getAddress());
    Assert.assertEquals(idToken.getAddress().getStreetAddress(),"5 Yawkey Way");
    Assert.assertEquals(idToken.getAddress().getLocality(),"Boston");
    Assert.assertEquals(idToken.getAddress().getRegion(),"MA");
    Assert.assertEquals(idToken.getAddress().getPostalCode(),"02115");
    Assert.assertEquals(idToken.getAddress().getCountry(),"USA");
    Assert.assertNotNull(idToken.getOtherClaims().get("home_phone"));
    AccessToken accessToken=getAccessToken(tokenResponse);
    Assert.assertNotNull(accessToken.getAddress());
    Assert.assertEquals(accessToken.getAddress().getStreetAddress(),"5 Yawkey Way");
    Assert.assertEquals(accessToken.getAddress().getLocality(),"Boston");
    Assert.assertEquals(accessToken.getAddress().getRegion(),"MA");
    Assert.assertEquals(accessToken.getAddress().getPostalCode(),"02115");
    Assert.assertEquals(accessToken.getAddress().getCountry(),"USA");
    Assert.assertNotNull(accessToken.getOtherClaims().get("home_phone"));
    Assert.assertEquals("617-777-6666",accessToken.getOtherClaims().get("home_phone"));
    response.close();
  }
  client.close();
  events.clear();
}
