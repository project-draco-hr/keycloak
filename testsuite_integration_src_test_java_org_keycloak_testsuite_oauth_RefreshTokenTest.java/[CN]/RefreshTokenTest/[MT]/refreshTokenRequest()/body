{
  oauth.doLogin("test-user@localhost","password");
  String code=oauth.getCurrentQuery().get(OAuth2Constants.CODE);
  AccessTokenResponse tokenResponse=oauth.doAccessTokenRequest(code,"password");
  AccessToken token=oauth.verifyToken(tokenResponse.getAccessToken());
  String refreshTokenString=tokenResponse.getRefreshToken();
  RefreshToken refreshToken=oauth.verifyRefreshToken(refreshTokenString);
  Assert.assertNotNull(refreshTokenString);
  Assert.assertEquals("bearer",tokenResponse.getTokenType());
  Assert.assertThat(token.getExpiration() - Time.currentTime(),allOf(greaterThanOrEqualTo(250),lessThanOrEqualTo(300)));
  Assert.assertThat(refreshToken.getExpiration() - Time.currentTime(),allOf(greaterThanOrEqualTo(35950),lessThanOrEqualTo(36000)));
  Thread.sleep(2000);
  AccessTokenResponse response=oauth.doRefreshTokenRequest(refreshTokenString,"password");
  AccessToken refreshedToken=oauth.verifyToken(response.getAccessToken());
  RefreshToken refreshedRefreshToken=oauth.verifyRefreshToken(response.getRefreshToken());
  Assert.assertEquals(200,response.getStatusCode());
  Assert.assertThat(response.getExpiresIn(),allOf(greaterThanOrEqualTo(250),lessThanOrEqualTo(300)));
  Assert.assertThat(refreshedToken.getExpiration() - Time.currentTime(),allOf(greaterThanOrEqualTo(250),lessThanOrEqualTo(300)));
  Assert.assertThat(refreshedToken.getExpiration() - token.getExpiration(),allOf(greaterThanOrEqualTo(1),lessThanOrEqualTo(3)));
  Assert.assertThat(refreshedRefreshToken.getExpiration() - refreshToken.getExpiration(),allOf(greaterThanOrEqualTo(1),lessThanOrEqualTo(3)));
  Assert.assertNotEquals(token.getId(),refreshedToken.getId());
  Assert.assertNotEquals(refreshToken.getId(),refreshedRefreshToken.getId());
  Assert.assertEquals("bearer",response.getTokenType());
  Assert.assertEquals(keycloakRule.getUser("test","test-user@localhost").getId(),refreshedToken.getSubject());
  Assert.assertNotEquals("test-user@localhost",refreshedToken.getSubject());
  Assert.assertEquals(1,refreshedToken.getRealmAccess().getRoles().size());
  Assert.assertTrue(refreshedToken.getRealmAccess().isUserInRole("user"));
  Assert.assertEquals(1,refreshedToken.getResourceAccess(oauth.getClientId()).getRoles().size());
  Assert.assertTrue(refreshedToken.getResourceAccess(oauth.getClientId()).isUserInRole("customer-user"));
}
