{
  try {
    keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
      @Override public void config(      RealmManager manager,      RealmModel adminstrationRealm,      RealmModel appRealm){
        appRealm.setRevokeRefreshToken(true);
      }
    }
);
    oauth.doLogin("test-user@localhost","password");
    Event loginEvent=events.expectLogin().assertEvent();
    String sessionId=loginEvent.getSessionId();
    String codeId=loginEvent.getDetails().get(Details.CODE_ID);
    String code=oauth.getCurrentQuery().get(OAuth2Constants.CODE);
    AccessTokenResponse response1=oauth.doAccessTokenRequest(code,"password");
    RefreshToken refreshToken1=oauth.verifyRefreshToken(response1.getRefreshToken());
    events.expectCodeToToken(codeId,sessionId).assertEvent();
    Time.setOffset(2);
    AccessTokenResponse response2=oauth.doRefreshTokenRequest(response1.getRefreshToken(),"password");
    RefreshToken refreshToken2=oauth.verifyRefreshToken(response2.getRefreshToken());
    Assert.assertEquals(200,response2.getStatusCode());
    events.expectRefresh(refreshToken1.getId(),sessionId).assertEvent();
    AccessTokenResponse response3=oauth.doRefreshTokenRequest(response1.getRefreshToken(),"password");
    Assert.assertEquals(400,response3.getStatusCode());
    events.expectRefresh(refreshToken1.getId(),sessionId).removeDetail(Details.TOKEN_ID).removeDetail(Details.UPDATED_REFRESH_TOKEN_ID).error("invalid_token").assertEvent();
    oauth.doRefreshTokenRequest(response2.getRefreshToken(),"password");
    events.expectRefresh(refreshToken2.getId(),sessionId).assertEvent();
  }
  finally {
    Time.setOffset(0);
    keycloakRule.configure(new KeycloakRule.KeycloakSetup(){
      @Override public void config(      RealmManager manager,      RealmModel adminstrationRealm,      RealmModel appRealm){
        appRealm.setRevokeRefreshToken(false);
      }
    }
);
  }
}
