{
  oauth.doLogin("test-user@localhost","password");
  Event loginEvent=events.expectLogin().assertEvent();
  String sessionId=loginEvent.getSessionId();
  String code=oauth.getCurrentQuery().get(OAuth2Constants.CODE);
  OAuthClient.AccessTokenResponse tokenResponse=oauth.doAccessTokenRequest(code,"password");
  events.poll();
  String refreshId=oauth.verifyRefreshToken(tokenResponse.getRefreshToken()).getId();
  KeycloakSession session=keycloakRule.startSession();
  RealmModel realm=session.realms().getRealmByName("test");
  UserSessionModel userSession=session.sessions().getUserSession(realm,sessionId);
  int last=userSession.getLastSessionRefresh();
  session.getTransaction().commit();
  session.close();
  Time.setOffset(2);
  tokenResponse=oauth.doRefreshTokenRequest(tokenResponse.getRefreshToken(),"password");
  AccessToken refreshedToken=oauth.verifyToken(tokenResponse.getAccessToken());
  RefreshToken refreshedRefreshToken=oauth.verifyRefreshToken(tokenResponse.getRefreshToken());
  Assert.assertEquals(200,tokenResponse.getStatusCode());
  session=keycloakRule.startSession();
  realm=session.realms().getRealmByName("test");
  userSession=session.sessions().getUserSession(realm,sessionId);
  int next=userSession.getLastSessionRefresh();
  session.getTransaction().commit();
  session.close();
  Assert.assertNotEquals(last,next);
  session=keycloakRule.startSession();
  realm=session.realms().getRealmByName("test");
  int lastAccessTokenLifespan=realm.getAccessTokenLifespan();
  realm.setAccessTokenLifespan(100000);
  session.getTransaction().commit();
  session.close();
  Time.setOffset(4);
  tokenResponse=oauth.doRefreshTokenRequest(tokenResponse.getRefreshToken(),"password");
  session=keycloakRule.startSession();
  realm=session.realms().getRealmByName("test");
  userSession=session.sessions().getUserSession(realm,sessionId);
  next=userSession.getLastSessionRefresh();
  session.getTransaction().commit();
  session.close();
  Assert.assertThat(next,allOf(greaterThan(last),lessThan(last + 50)));
  session=keycloakRule.startSession();
  realm=session.realms().getRealmByName("test");
  int originalIdle=realm.getSsoSessionIdleTimeout();
  realm.setSsoSessionIdleTimeout(1);
  session.getTransaction().commit();
  session.close();
  events.clear();
  Time.setOffset(6);
  tokenResponse=oauth.doRefreshTokenRequest(tokenResponse.getRefreshToken(),"password");
  assertEquals(400,tokenResponse.getStatusCode());
  assertNull(tokenResponse.getAccessToken());
  assertNull(tokenResponse.getRefreshToken());
  events.expectRefresh(refreshId,sessionId).error(Errors.INVALID_TOKEN);
  session=keycloakRule.startSession();
  realm=session.realms().getRealmByName("test");
  realm.setSsoSessionIdleTimeout(originalIdle);
  realm.setAccessTokenLifespan(lastAccessTokenLifespan);
  session.getTransaction().commit();
  session.close();
  events.clear();
  Time.setOffset(0);
}
