{
  if (contextPath == null || appBase == null || appBase.length() == 0) {
    throw new IllegalArgumentException("Context path or appbase should not be null");
  }
  if (!contextPath.startsWith("/")) {
    contextPath="/" + contextPath;
  }
  this.port=port;
  server=new Embedded();
  server.setName("TomcatEmbeddedServer");
  server.setCatalinaBase(TomcatTest.getBaseDirectory());
  Host localHost=server.createHost("localhost",appBase);
  localHost.setAutoDeploy(false);
  StandardContext rootContext=(StandardContext)server.createContext(contextPath,"webapp");
  KeycloakAuthenticatorValve valve=new KeycloakAuthenticatorValve();
  rootContext.addValve(valve);
  rootContext.setDefaultWebXml("web.xml");
  localHost.addChild(rootContext);
  Engine engine=server.createEngine();
  engine.setDefaultHost(localHost.getName());
  engine.setName("TomcatEngine");
  engine.addChild(localHost);
  server.addEngine(engine);
  Connector connector=server.createConnector(localHost.getName(),port,false);
  server.addConnector(connector);
  if (shutdownHook) {
    Runtime.getRuntime().addShutdownHook(new Thread(){
      public void run(){
        if (isRunning) {
          if (isInfo)           LOG.info("Stopping the Tomcat server, through shutdown hook");
          try {
            if (server != null) {
              server.stop();
            }
          }
 catch (          LifecycleException e) {
            LOG.error("Error while stopping the Tomcat server, through shutdown hook",e);
          }
        }
      }
    }
);
  }
}
